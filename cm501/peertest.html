<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Peer Evaluation (Test)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body { font-family: 'Inter', sans-serif; }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.0.0",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.469.0"
      }
    }
    </script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="typescript,react">
      import React, { useState, useEffect } from 'react';
      import { createRoot } from 'react-dom/client';
      import { 
        LogOut, CheckCircle, ShieldAlert, FileSpreadsheet, 
        Users, Copy, ExternalLink, Check, Trash2, ArrowLeft, Smile, Shuffle
      } from 'lucide-react';

      /** 
       * ==========================================
       * TYPES
       * ==========================================
       */
      interface Student {
        name: string;
        email: string;
        section: string;
        group: string;
      }

      // SIMPLIFIED DATA STRUCTURE
      interface EvaluationData {
        emojiRating: string; // The selected emoji char
        comments: string;
      }

      interface FullSubmission {
        evaluatorEmail: string;
        evaluatorName: string;
        section: string;
        group: string;
        evaluations: Record<string, EvaluationData>;
        timestamp: string;
      }

      type AppStep = 'LOGIN' | 'EVALUATE' | 'SUCCESS' | 'INSTRUCTOR_DASHBOARD';

      /** 
       * ==========================================
       * CONSTANTS
       * ==========================================
       */
      const STUDENTS: Student[] = [
        // Section G1
        { section: 'G1', group: '1', name: 'Kaylin McConnell', email: 'klmcconn@bu.edu' },
        { section: 'G1', group: '1', name: 'Crystal Wu', email: 'cwu21@bu.edu' },
        { section: 'G1', group: '1', name: 'Lincoln Edwards', email: 'lincred@bu.edu' },
        { section: 'G1', group: '1', name: 'Olivia Evans', email: 'eolivia@bu.edu' },
        { section: 'G1', group: '2', name: 'Emily Wyrwa', email: 'evwyrwa@bu.edu' },
        { section: 'G1', group: '2', name: 'Amber (Nikki) Capinpin', email: 'capinpin@bu.edu' },
        { section: 'G1', group: '2', name: 'Claudia', email: 'cminacap@bu.edu' },
        { section: 'G1', group: '2', name: 'Sidi Bello', email: 'sidikatb@bu.edu' },
        { section: 'G1', group: '3', name: 'Annie Levy', email: 'anlevy@bu.edu' },
        { section: 'G1', group: '3', name: 'Ali Cook', email: 'alircook@bu.edu' },
        { section: 'G1', group: '3', name: 'Ava Rheingold', email: 'arheingo@bu.edu' },
        { section: 'G1', group: '3', name: 'Xiaodong (Will) Will', email: 'xiaodonf@bu.edu' },
        { section: 'G1', group: '4', name: 'Piper Gilliam', email: 'pipergg@bu.edu' },
        { section: 'G1', group: '4', name: 'Zitong(Becky) Zheng', email: 'Beckyzzt@bu.edu' },
        { section: 'G1', group: '4', name: 'Sanyu', email: 'sanyuliu@bu.edu' },
        { section: 'G1', group: '4', name: 'Jessica Lin', email: 'jess3lin@bu.edu' },
        { section: 'G1', group: '5', name: 'Teresa Garate', email: 'teresag@bu.edu' },
        { section: 'G1', group: '5', name: 'Ziyi', email: 'renziyi@bu.edu' },
        { section: 'G1', group: '5', name: 'Qinjian(Erik) Ran', email: 'qjr2000@bu.edu' },
        { section: 'G1', group: '5', name: 'Sitong (Scarlett) Jiang', email: 'jstong@bu.edu' },
        // Section H1
        { section: 'H1', group: '1', name: 'Keira Shannon', email: 'keiras@bu.edu' },
        { section: 'H1', group: '1', name: 'Anna McClean', email: 'amcclean@bu.edu' },
        { section: 'H1', group: '1', name: 'Amelia Edelsberg', email: 'ameliae@bu.edu' },
        { section: 'H1', group: '1', name: 'Erin Hajian', email: 'ehajian@bu.edu' },
        { section: 'H1', group: '2', name: 'Marina Berger', email: 'maberger@bu.edu' },
        { section: 'H1', group: '2', name: 'Amanda Brecher', email: 'ambrec@bu.edu' },
        { section: 'H1', group: '2', name: 'Yiyang(Kacey) Jin', email: 'jinyy328@bu.edu' },
        { section: 'H1', group: '2', name: 'Nadezhda Kuznetsova', email: 'nadezhda@bu.edu' },
        { section: 'H1', group: '3', name: 'Samantha Shorr', email: 'sshorr@bu.edu' },
        { section: 'H1', group: '3', name: 'Ananya Swaroop', email: 'ananya21@bu.edu' },
        { section: 'H1', group: '3', name: 'Mily Talgham Cohen', email: 'milytc@bu.edu' },
        { section: 'H1', group: '3', name: 'Lance Shook', email: 'lshook@bu.edu' },
        { section: 'H1', group: '4', name: 'Kirsten Foster', email: 'kefoster@bu.edu' },
        { section: 'H1', group: '4', name: 'Zoe Baumann', email: 'zbaumann@bu.edu' },
        { section: 'H1', group: '4', name: 'Maddy Oberding', email: 'mgober@bu.edu' },
        { section: 'H1', group: '4', name: 'Mickie McCool', email: 'mfmccool@bu.edu' },
        { section: 'H1', group: '5', name: 'Delia Rune', email: 'deliar@bu.edu' },
        { section: 'H1', group: '5', name: 'Kayla Lok', email: 'kaylalok@bu.edu' },
        { section: 'H1', group: '5', name: 'Yiyu Zhang', email: 'yiyuzh@bu.edu' },
        { section: 'H1', group: '5', name: 'Mina Jones', email: 'minacjon@bu.edu' },
        // Section K1
        { section: 'K1', group: '1', name: 'Jocelyn Mao', email: 'jocmao@bu.edu' },
        { section: 'K1', group: '1', name: 'Alisa Hilaly', email: 'alisah@bu.edu' },
        { section: 'K1', group: '1', name: 'Victoria Shapiro', email: 'tshapiro@bu.edu' },
        { section: 'K1', group: '1', name: 'Olivia Schnur', email: 'oschnur@bu.edu' },
        { section: 'K1', group: '2', name: 'Anna Novick', email: 'annayn@bu.edu' },
        { section: 'K1', group: '2', name: 'Michaela Shunney', email: 'mshunney@bu.edu' },
        { section: 'K1', group: '2', name: 'Savannah Radisch', email: 'sradisch@bu.edu' },
        { section: 'K1', group: '2', name: 'Donald Varnerin', email: 'Donnyv@bu.edu' },
        { section: 'K1', group: '3', name: 'Izzy Anderson', email: 'icanders@bu.edu' },
        { section: 'K1', group: '3', name: 'HaoYuan Chen', email: 'chyharry@bu.edu' },
        { section: 'K1', group: '3', name: 'Shree Lheyaa Jayasudha Mathivanan', email: 'lheyaa@bu.edu' },
        { section: 'K1', group: '3', name: 'Blair LeBlanc', email: 'blairl@bu.edu' },
        { section: 'K1', group: '4', name: 'Tala Solomon', email: 'talas@bu.edu' },
        { section: 'K1', group: '4', name: 'Ava Graff', email: 'avagraff@bu.edu' },
        { section: 'K1', group: '4', name: 'Sydney Wiggins', email: 'swiggins@bu.edu' },
        { section: 'K1', group: '4', name: 'Julie Liu', email: 'jhliu18@bu.edu' },
        { section: 'K1', group: '5', name: 'Nia Carrera', email: 'niac@bu.edu' },
        { section: 'K1', group: '5', name: 'Nancy Liu', email: 'lnanan@bu.edu' },
        { section: 'K1', group: '5', name: 'Muneeb Mahmood', email: 'muneebm@bu.edu' },
        // Instructor / Testing
        { section: 'Test', group: 'Instructor', name: 'Jen Choi', email: 'choijen@bu.edu' },
        { section: 'Test', group: 'Instructor', name: 'Jen Choi (Gmail)', email: 'choij126@gmail.com' },
        { section: 'Test', group: 'Instructor', name: 'Jen Jiun Choi', email: 'jenjiunchoi@gmail.com' },
        { section: 'Test', group: 'Instructor', name: 'Test Student A', email: 'test.student.a@bu.edu' },
        { section: 'Test', group: 'Instructor', name: 'Test Student B', email: 'test.student.b@bu.edu' },
      ];

      const INITIAL_EVALUATION_STATE: EvaluationData = {
        emojiRating: '',
        comments: ''
      };

      /** 
       * ==========================================
       * UTILS: CSV/TSV Helper (Simplified)
       * ==========================================
       */
      const escapeField = (str, separator) => {
        if (str === null || str === undefined) return '';
        const stringValue = str.toString();
        if (separator === '\t') {
          if (stringValue.includes('\t') || stringValue.includes('\n') || stringValue.includes('"')) {
            return `"${stringValue.replace(/"/g, '""')}"`;
          }
        } else {
          if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
            return `"${stringValue.replace(/"/g, '""')}"`;
          }
        }
        return stringValue;
      };

      const generateMasterData = (students, submissions, format = 'csv') => {
        const sep = format === 'tsv' ? '\t' : ',';
        const headers = [
          'Section', 'Group', 
          'Target Name', 'Target Email',
          'Evaluator Name', 'Evaluator Email', 
          'Rating (Emoji)', 'Comments', 'Status'
        ];

        const rows = [headers.join(sep)];

        // Simple sort by section/group/name
        const sortedStudents = [...students].sort((a, b) => {
           if (a.section !== b.section) return a.section.localeCompare(b.section);
           if (a.group !== b.group) return a.group.localeCompare(b.group);
           return a.name.localeCompare(b.name);
        });

        sortedStudents.forEach((target) => {
           // Find potential evaluators (everyone in their group, excluding self)
           const potentialEvaluators = students.filter(s => s.section === target.section && s.group === target.group && s.email !== target.email);
           
           potentialEvaluators.forEach(evaluator => {
              const submission = submissions[evaluator.email];
              let evalData = null;
              let status = 'Pending';

              if (submission && submission.evaluations && submission.evaluations[target.email]) {
                  evalData = submission.evaluations[target.email];
                  status = 'Submitted';
              }

              const row = [
                escapeField(target.section, sep), escapeField(target.group, sep), 
                escapeField(target.name, sep), escapeField(target.email, sep),
                escapeField(evaluator.name, sep), escapeField(evaluator.email, sep),
                escapeField(evalData?.emojiRating ?? '', sep), // The Emoji
                escapeField(evalData?.comments ?? '', sep),    // Optional Comment
                status
              ];
              rows.push(row.join(sep));
           });
        });

        return rows.join('\n');
      };

      /** 
       * ==========================================
       * COMPONENT: EvaluationForm (Simplified)
       * ==========================================
       */
      const EMOJI_POOL = [
        'ðŸ˜€', 'ðŸ¤£', 'ðŸ™ƒ', 'ðŸ¥°', 'ðŸ¤ª', 'ðŸ§', 'ðŸ¥³', 'ðŸ˜Ž', 
        'ðŸ˜­', 'ðŸ˜±', 'ðŸ˜¡', 'ðŸ¤¢', 'ðŸ¤ ', 'ðŸ‘»', 'ðŸ‘½', 'ðŸ¤–',
        'ðŸ’©', 'ðŸ¦„', 'ðŸ', 'ðŸ¢', 'ðŸ¦–', 'ðŸ™', 'ðŸ¦‹', 'ðŸ’',
        'ðŸ”¥', 'ðŸŒˆ', 'â˜€ï¸', 'â­', 'ðŸ•', 'ðŸ”', 'ðŸŒ®', 'ðŸ¦',
        'ðŸ©', 'ðŸ»', 'ðŸ†', 'âš½', 'ðŸŽ¨', 'ðŸš€', 'ðŸ’¡', 'ðŸ’Ž',
        'ðŸ’£', 'ðŸŽˆ', 'ðŸŽ', 'ðŸ§¸', 'ðŸ§¶', 'â¤ï¸', 'ðŸ’¯', 'ðŸš«'
      ];

      const EvaluationForm = ({ targetName, data, onChange, onNext, isLast }) => {
        const [randomEmojis, setRandomEmojis] = useState([]);

        useEffect(() => {
          // Select 12 unique random emojis from the pool
          const shuffled = [...EMOJI_POOL].sort(() => 0.5 - Math.random());
          setRandomEmojis(shuffled.slice(0, 12));
        }, [targetName]); // Re-shuffle when the student changes

        const isValid = data.emojiRating !== '';

        return (
          <div className="max-w-xl mx-auto bg-white p-8 rounded-xl shadow-lg border border-gray-100 text-center">
            <h2 className="text-2xl font-bold text-gray-900 mb-2">Evaluate <span className="text-red-600">{targetName}</span></h2>
            <p className="text-gray-500 mb-6">Pick an emoji that represents your experience.</p>

            <div className="grid grid-cols-4 gap-4 mb-8">
                {randomEmojis.map((emoji) => (
                    <button
                        key={emoji}
                        onClick={() => onChange('emojiRating', emoji)}
                        className={`flex items-center justify-center h-16 rounded-xl text-3xl transition-all ${
                            data.emojiRating === emoji 
                            ? 'bg-red-50 border-2 border-red-500 transform scale-110 shadow-md' 
                            : 'bg-gray-50 border border-gray-100 hover:bg-white hover:shadow-sm hover:scale-105'
                        }`}
                    >
                        {emoji}
                    </button>
                ))}
            </div>

            <div className="mb-8 text-left">
                <label className="block text-sm font-medium text-gray-700 mb-2">Optional Comments</label>
                <textarea
                    value={data.comments}
                    onChange={(e) => onChange('comments', e.target.value)}
                    placeholder="Want to explain your choice?"
                    className="w-full p-3 border border-gray-300 rounded-md text-sm focus:ring-red-500 focus:border-red-500"
                    rows={3}
                />
            </div>

            <button
                onClick={onNext}
                disabled={!isValid}
                className={`w-full py-3 rounded-lg font-bold text-white transition-all ${
                    isValid ? 'bg-red-600 hover:bg-red-700 shadow-md' : 'bg-gray-300 cursor-not-allowed'
                }`}
            >
                {isLast ? 'Submit All' : 'Next Student'}
            </button>
          </div>
        );
      };

      /** 
       * ==========================================
       * COMPONENT: Main App
       * ==========================================
       */
      const App = () => {
        const [step, setStep] = useState('LOGIN');
        const [currentUser, setCurrentUser] = useState(null);
        const [loginEmail, setLoginEmail] = useState('');
        const [loginError, setLoginError] = useState('');
        const [copySuccess, setCopySuccess] = useState(false);
        const [peers, setPeers] = useState([]);
        const [evaluations, setEvaluations] = useState({});
        const [currentPeerIndex, setCurrentPeerIndex] = useState(0);

        // Only this email has dashboard access
        const INSTRUCTORS = ['choijen@bu.edu'];
        const isInstructor = (email) => INSTRUCTORS.includes(email);

        const getSubmissionsFromStorage = () => {
          try {
            const stored = localStorage.getItem('peer_eval_test_submissions'); // Different key for test version
            return stored ? JSON.parse(stored) : {};
          } catch (e) { return {}; }
        };

        const handleLogin = (e) => {
          e.preventDefault();
          const emailLower = loginEmail.toLowerCase().trim();
          const student = STUDENTS.find(s => s.email.toLowerCase() === emailLower);
          
          if (student) {
            setCurrentUser(student);
            const groupMembers = STUDENTS.filter(s => s.section === student.section && s.group === student.group);
            const peersToEval = groupMembers.filter(s => s.email !== student.email);
            setPeers(peersToEval);
            
            const initialEvals = {};
            peersToEval.forEach(p => initialEvals[p.email] = { ...INITIAL_EVALUATION_STATE });
            setEvaluations(initialEvals);
            setStep('EVALUATE');
            setLoginError('');
          } else {
            setLoginError('Email not found in the authorized student list.');
          }
        };

        const handleEvaluationChange = (field, value) => {
          const currentPeer = peers[currentPeerIndex];
          setEvaluations(prev => ({
            ...prev,
            [currentPeer.email]: { ...prev[currentPeer.email], [field]: value }
          }));
        };

        const handleNextEval = () => {
          if (currentPeerIndex < peers.length - 1) {
            setCurrentPeerIndex(prev => prev + 1);
            window.scrollTo(0, 0);
          } else {
            handleSubmit();
          }
        };

        const handleSubmit = () => {
          if (!currentUser) return;
          const submission = {
            evaluatorEmail: currentUser.email,
            evaluatorName: currentUser.name,
            section: currentUser.section,
            group: currentUser.group,
            evaluations,
            timestamp: new Date().toISOString()
          };
          
          // Save to Local Storage (Test Key)
          const allSubmissions = getSubmissionsFromStorage();
          allSubmissions[currentUser.email] = submission;
          localStorage.setItem('peer_eval_test_submissions', JSON.stringify(allSubmissions));
          setStep('SUCCESS');
        };

        const handleCopyToClipboard = () => {
          const submissions = getSubmissionsFromStorage();
          const tsvContent = generateMasterData(STUDENTS, submissions, 'tsv');
          navigator.clipboard.writeText(tsvContent).then(() => {
            setCopySuccess(true);
            setTimeout(() => setCopySuccess(false), 3000);
          });
        };

        const handleClearData = () => {
          if (confirm("Delete all data from this browser?")) {
            localStorage.removeItem('peer_eval_test_submissions');
            window.location.reload();
          }
        };

        if (step === 'LOGIN') {
          return (
            <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
              <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8 border border-gray-100">
                <div className="text-center mb-8">
                  <h1 className="text-2xl font-bold text-gray-900">Peer Evaluation (Test)</h1>
                  <p className="text-gray-500 mt-2">Sections G1, H1, K1 - Emoji Version</p>
                </div>
                <form onSubmit={handleLogin} className="space-y-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700">BU Email Address</label>
                    <input type="email" required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="you@bu.edu" value={loginEmail} onChange={(e) => setLoginEmail(e.target.value)} />
                  </div>
                  {loginError && <div className="bg-red-50 text-red-700 px-4 py-3 rounded text-sm">{loginError}</div>}
                  <button type="submit" className="w-full py-2 px-4 bg-red-600 text-white rounded-md hover:bg-red-700">Access Form</button>
                </form>
              </div>
            </div>
          );
        }

        const statsSubmissions = Object.keys(getSubmissionsFromStorage()).length;

        return (
          <div className="min-h-screen bg-gray-50 pb-12">
            <header className="bg-white shadow-sm sticky top-0 z-10">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div>
                  <h1 className="text-lg font-bold text-gray-900">Peer Eval (Test)</h1>
                  <p className="text-xs text-gray-500">{currentUser?.name}</p>
                </div>
                <div className="flex items-center gap-4">
                  {isInstructor(currentUser?.email) && (
                    <button onClick={() => setStep(step === 'INSTRUCTOR_DASHBOARD' ? 'EVALUATE' : 'INSTRUCTOR_DASHBOARD')} className={`text-sm font-medium px-3 py-1.5 rounded-md ${step === 'INSTRUCTOR_DASHBOARD' ? 'bg-red-100 text-red-700' : 'text-gray-600 hover:bg-gray-100'}`}>
                      {step === 'INSTRUCTOR_DASHBOARD' ? 'Test Form' : 'Instructor Dashboard'}
                    </button>
                  )}
                  <button onClick={() => window.location.reload()} className="text-gray-500 hover:text-red-600 text-sm flex gap-1"><LogOut size={16}/> Logout</button>
                </div>
              </div>
            </header>

            <main className="max-w-4xl mx-auto px-4 mt-8">
              {step === 'INSTRUCTOR_DASHBOARD' && (
                <div className="max-w-3xl mx-auto bg-white rounded-xl shadow-md p-8 border border-gray-200">
                    <div className="flex items-center gap-4 mb-6">
                       <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-red-600"><ShieldAlert size={24} /></div>
                       <h2 className="text-2xl font-bold text-gray-900">Instructor Dashboard (Test)</h2>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-6">
                       <div className="bg-gray-50 p-4 rounded text-center">
                          <span className="block text-2xl font-bold">{statsSubmissions}</span>
                          <span className="text-xs text-gray-500">Submissions</span>
                       </div>
                       <div className="bg-gray-50 p-4 rounded text-center">
                          <span className="block text-2xl font-bold">{STUDENTS.length}</span>
                          <span className="text-xs text-gray-500">Roster Size</span>
                       </div>
                    </div>

                    <div className="bg-green-50 border border-green-100 rounded-lg p-6 mb-6">
                        <h3 className="font-bold text-green-800 mb-2 flex items-center gap-2"><FileSpreadsheet size={18}/> Export Data</h3>
                        <p className="text-sm text-green-700 mb-4">Export the simplified emoji ratings collected on this device.</p>
                        <div className="flex gap-4">
                           <button onClick={handleCopyToClipboard} className="flex-1 bg-white border border-green-300 text-green-700 hover:bg-green-100 px-4 py-3 rounded flex items-center justify-center gap-2">
                              {copySuccess ? <Check size={18}/> : <Copy size={18}/>} Copy for Sheets
                           </button>
                           <a href="https://sheets.new" target="_blank" className="flex-1 bg-green-600 text-white hover:bg-green-700 px-4 py-3 rounded flex items-center justify-center gap-2">
                              <ExternalLink size={18}/> Open New Sheet
                           </a>
                        </div>
                    </div>
                    
                    <button onClick={handleClearData} className="text-red-600 text-xs flex items-center gap-1"><Trash2 size={12}/> Clear Test Data</button>
                </div>
              )}

              {step === 'EVALUATE' && (
                <div>
                    <div className="flex justify-center mb-6">
                        <div className="flex gap-1">
                            {peers.map((_, idx) => (
                            <div key={idx} className={`h-2 w-8 rounded-full ${idx === currentPeerIndex ? 'bg-red-600' : idx < currentPeerIndex ? 'bg-green-500' : 'bg-gray-200'}`} />
                            ))}
                        </div>
                    </div>
                    <EvaluationForm 
                        targetName={peers[currentPeerIndex].name} 
                        data={evaluations[peers[currentPeerIndex].email]} 
                        onChange={handleEvaluationChange} 
                        onNext={handleNextEval} 
                        isLast={currentPeerIndex === peers.length - 1} 
                    />
                </div>
              )}

              {step === 'SUCCESS' && (
                <div className="max-w-md mx-auto bg-white p-12 rounded-xl shadow-lg text-center">
                   <div className="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6"><CheckCircle size={32}/></div>
                   <h2 className="text-2xl font-bold mb-4">Submission Complete</h2>
                   <p className="text-gray-600 mb-8">Thank you! Your feedback has been recorded.</p>
                   
                   {isInstructor(currentUser?.email) && (
                      <button onClick={() => setStep('INSTRUCTOR_DASHBOARD')} className="w-full bg-red-600 text-white px-4 py-3 rounded hover:bg-red-700 mb-3">Go to Dashboard</button>
                   )}
                   <button onClick={() => window.location.reload()} className="w-full bg-gray-100 text-gray-700 px-4 py-3 rounded">Return to Login</button>
                </div>
              )}
            </main>
          </div>
        );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
