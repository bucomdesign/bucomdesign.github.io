<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Visual Telephone</title>
    
    <!-- FONTS & STYLES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Manrope', sans-serif; color: #111; background: #fff; }
      
      .btn-primary { background: #111; color: #fff; transition: all 0.2s; }
      .btn-primary:hover { background: #CC0000; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
      .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
      
      .btn-secondary { background: #f1f3f5; color: #444; transition: all 0.2s; }
      .btn-secondary:hover { background: #e2e6ea; transform: translateY(-2px); }
      
      .hover-card { transition: transform 0.25s, box-shadow 0.25s; }
      .hover-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
      
      .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #CC0000; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
      @keyframes spin { 100% { transform: rotate(360deg); } }

      /* Scrollbar cleanup */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #ddd; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #bbb; }
    </style>

    <!-- CORE LIBRARIES (Global fallback) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
</head>
<body>

    <div id="root">
        <!-- Loading Fallback -->
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <div class="spinner" style="width: 50px; height: 50px; border-width: 5px;"></div>
            <p style="margin-top: 20px; color: #666; font-weight: 600;">Loading AI Visual Telephone...</p>
        </div>
    </div>

    <!-- 
      ========================================
       AI SERVICE MODULE (No Babel, Native JS)
      ========================================
    -->
    <script type="module">
        import { GoogleGenAI } from "https://esm.run/@google/genai";

        // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
        //           PASTE API KEY HERE
        // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
        const HARDCODED_API_KEY = "AIzaSyBqHLJJIkH7FG91D2TLv7jEalI9Jht3N44"; 
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        // Expose function to global window so React can use it
        window.generateImageService = async (prompt) => {
            if (!HARDCODED_API_KEY || HARDCODED_API_KEY.includes("PASTE_YOUR")) {
                throw new Error("API_KEY_MISSING");
            }

            const ai = new GoogleGenAI({ apiKey: HARDCODED_API_KEY });
            
            // Using the requested prompt enhancement for realism
            const enhancedPrompt = `${prompt}, photorealistic, realistic photograph, 8k, highly detailed, sharp focus, cinematic lighting`;

            try {
                // Using the specific model from guidelines
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash-image',
                    contents: { parts: [{ text: enhancedPrompt }] },
                });

                // Parse response
                if (response.candidates && response.candidates[0].content && response.candidates[0].content.parts) {
                    for (const part of response.candidates[0].content.parts) {
                        if (part.inlineData && part.inlineData.data) {
                            const mimeType = part.inlineData.mimeType || 'image/png';
                            return `data:${mimeType};base64,${part.inlineData.data}`;
                        }
                    }
                }
                throw new Error("No image data returned from Gemini.");
            } catch (error) {
                console.error("Gemini Error:", error);
                throw error;
            }
        };

        // Signal that AI service is ready
        window.isAIReady = true;
    </script>

    <!-- 
      ========================================
       REACT APPLICATION (Compiled by Babel)
      ========================================
    -->
    <script type="text/babel" data-presets="env,react">
        const { useState, useEffect, useRef } = React;

        // --- ICONS (Inline SVG to avoid external dep) ---
        const Icon = ({ name, className }) => {
            const icons = {
                Users: <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>,
                GraduationCap: <path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/>,
                MonitorPlay: <path d="m10 7 5 3-5 3z"/><rect width="20" height="14" x="2" y="3" rx="2" ry="2"/><path d="M12 17v4"/><path d="M8 21h8"/>,
                Image: <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>,
                Send: <path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/>,
                Edit3: <path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/>,
                AlertCircle: <circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/>,
                Lightbulb: <path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5A6 6 0 0 0 6 8c0 1 .5 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/>,
                RefreshCw: <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/>,
                ZoomIn: <circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/>,
                X: <path d="M18 6 6 18"/><path d="m6 6 12 12"/>,
                CheckCircle2: <circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/>,
                Clock: <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>,
                ArrowRight: <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>,
                Lock: <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>,
                Unlock: <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10"/>}
                </svg>
            );
        };

        // --- CONSTANTS ---
        const GROUP_ORDER = ['GROUP_1', 'GROUP_2', 'GROUP_3', 'GROUP_4', 'GROUP_5'];
        
        const INITIATOR_THEMES = {
            'GROUP_1': "What would your classroom look like if it became a magical world on the last day?",
            'GROUP_2': "Create a scene where everything goes hilariously wrong on the last day of class.",
            'GROUP_3': "How would the last day of class look in a school of the distant future?",
            'GROUP_4': "Illustrate the abstract concept of 'finishing something important' as a visual story.",
            'GROUP_5': "Show the bittersweet feeling of walking out of the classroom for the very last time.",
            'TEACHER': ""
        };

        const PROMPT_RECIPE = [
            { name: "The Subject", examples: ["A chair", "A futuristic sneaker", "A perfume bottle", "A bus stop", "A tiny house", "A geometric explosion"] },
            { name: "The Style", examples: ["Art Deco", "Bauhaus", "Art Nouveau", "Cyberpunk", "Minimalist", "Memphis Design"] },
            { name: "The Material", examples: ["Polished chrome", "Raw concrete", "Rusted iron", "Blue velvet", "Fluffy cotton candy", "Translucent plastic"] },
            { name: "The Vibe", examples: ["Cinematic lighting", "Golden hour", "Neon noir", "Studio softbox", "Isometric view", "Fish-eye lens"] }
        ];

        // --- COMPONENTS ---

        const PromptGuide = () => (
            <div className="bg-white h-full overflow-y-auto border-l border-gray-100 hidden xl:block w-[400px] shrink-0">
                <div className="p-8">
                    <h3 className="text-xl font-bold text-[#111] mb-6 tracking-tight">Prompt Recipe Formula</h3>
                    <div className="p-5 bg-[#fafafa] border border-gray-100 rounded-xl mb-10">
                        <p className="text-sm font-bold text-[#111] mb-2">Instructions:</p>
                        <p className="text-sm text-gray-600 leading-relaxed">Brainstorm one item from each category.</p>
                        <div className="mt-4 pt-4 border-t border-gray-200 font-mono text-xs text-[#CC0000] font-bold">Subject + Style + Material + Vibe</div>
                    </div>
                    <div className="space-y-8">
                        {PROMPT_RECIPE.map((c, i) => (
                            <div key={i}>
                                <h4 className="text-sm font-bold text-[#111] uppercase border-b pb-2 mb-3">{c.name}</h4>
                                <p className="text-sm text-gray-600 leading-relaxed pl-3 border-l-2">{c.examples.join(', ')}</p>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );

        const StudentView = ({ currentGroup, roundNumber, previousTurn, projectId, onTurnComplete }) => {
            const [prompt, setPrompt] = useState('');
            const [loading, setLoading] = useState(false);
            const [image, setImage] = useState(null);
            const [error, setError] = useState(null);
            const isInitiator = roundNumber === 1;

            const handleGenerate = async () => {
                if(!prompt.trim()) return;
                setLoading(true); setError(null);
                
                if (!window.generateImageService) {
                    setError("AI Service not loaded yet. Refresh page.");
                    setLoading(false);
                    return;
                }

                try {
                    const base64 = await window.generateImageService(prompt);
                    setImage(base64);
                } catch(e) {
                    if (e.message === 'API_KEY_MISSING') {
                        setError("CRITICAL: API Key is missing in the HTML file.");
                    } else {
                        setError("Failed to generate: " + e.message);
                    }
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="h-screen bg-white flex flex-col md:flex-row overflow-hidden">
                    <div className="flex-1 flex flex-col h-full overflow-y-auto">
                        <div className="max-w-4xl mx-auto w-full p-8 md:p-12 space-y-8">
                            <div className="border-b pb-6">
                                <div className="flex items-center gap-4 mb-4">
                                    <div className="w-12 h-12 bg-[#111] text-white flex items-center justify-center rounded-xl font-bold text-xl">{currentGroup.split('_')[1]}</div>
                                    <div>
                                        <h1 className="text-3xl font-bold text-[#111]">{isInitiator ? 'The Initiator' : 'The Interpreter'}</h1>
                                        <span className="text-xs font-bold text-[#CC0000] uppercase tracking-wider">Round {roundNumber} / 5</span>
                                    </div>
                                </div>
                                <p className="text-gray-600 text-lg">
                                    {isInitiator ? 'Start the chain. Use your theme to write a prompt.' : 'Analyze the image below. Recreate it with words.'}
                                </p>
                            </div>

                            {isInitiator && (
                                <div className="bg-amber-50 border border-amber-200 p-6 rounded-xl">
                                    <div className="flex items-center gap-2 mb-2">
                                        <Icon name="Lightbulb" className="w-5 h-5 text-amber-600"/>
                                        <span className="font-bold text-amber-900">Theme Assignment</span>
                                    </div>
                                    <p className="text-amber-900 text-lg font-serif italic">"{INITIATOR_THEMES[currentGroup]}"</p>
                                </div>
                            )}

                            {previousTurn && (
                                <div className="bg-gray-50 p-6 rounded-2xl border border-gray-200">
                                    <div className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Incoming Visual</div>
                                    <div className="bg-white p-1 rounded-lg border shadow-sm"><img src={previousTurn.generatedImage} className="w-full max-h-[400px] object-contain mx-auto"/></div>
                                </div>
                            )}

                            <div className="bg-white rounded-xl">
                                <h2 className="text-lg font-bold mb-4 flex gap-2 items-center"><Icon name="Edit3" className="w-5 h-5 text-[#CC0000]"/> Draft Prompt</h2>
                                <textarea 
                                    className="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-[#111] min-h-[120px] text-lg transition-all"
                                    placeholder={isInitiator ? "Describe your theme using the recipe..." : "Describe the image you see..."}
                                    value={prompt}
                                    onChange={e => setPrompt(e.target.value)}
                                />
                                {error && <div className="mt-4 p-3 bg-red-50 text-red-700 text-sm font-bold border border-red-100 rounded flex items-center gap-2"><Icon name="AlertCircle" className="w-4 h-4"/>{error}</div>}
                                
                                <div className="mt-6">
                                    {!image ? (
                                        <button onClick={handleGenerate} disabled={loading || !prompt} className="btn-primary w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2">
                                            {loading ? <div className="spinner"></div> : <Icon name="Image" className="w-5 h-5"/>}
                                            {loading ? 'Generating...' : 'Generate Image'}
                                        </button>
                                    ) : (
                                        <div className="space-y-4">
                                            <div className="bg-gray-50 border rounded-lg p-1"><img src={image} className="w-full max-h-[400px] object-contain mx-auto"/></div>
                                            <div className="flex gap-4">
                                                <button onClick={() => setImage(null)} className="btn-secondary flex-1 py-3 rounded-xl font-bold">Try Again</button>
                                                <button onClick={() => onTurnComplete(prompt, image)} className="flex-[2] py-3 bg-[#111] hover:bg-[#CC0000] text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">
                                                    <Icon name="Send" className="w-5 h-5"/> Transmit
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="h-10"></div>
                        </div>
                    </div>
                    <PromptGuide />
                </div>
            );
        };

        const TeacherDashboard = ({ gameState, onReset, onToggleReflection }) => {
            const [zoom, setZoom] = useState(null);
            const [expand, setExpand] = useState(null);
            
            const totalTurns = gameState.projects.reduce((acc, p) => acc + p.turns.length, 0);
            const progress = Math.round((totalTurns / 25) * 100);

            return (
                <div className="min-h-screen bg-white pb-20">
                    <header className="sticky top-0 bg-white/95 backdrop-blur border-b z-30 px-8 h-20 flex items-center justify-between">
                        <div className="flex items-center gap-4">
                            <div className="bg-[#111] text-white w-10 h-10 rounded-lg flex items-center justify-center font-bold">T</div>
                            <h1 className="font-bold text-lg">Instructor Dashboard</h1>
                        </div>
                        <div className="flex items-center gap-6">
                             <div className="flex flex-col items-end">
                                <span className="text-[10px] font-bold uppercase text-gray-400">Class Progress</span>
                                <div className="flex items-center gap-2">
                                    <div className="w-32 h-2 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-[#CC0000] transition-all duration-1000" style={{width: `${progress}%`}}></div></div>
                                    <span className="text-sm font-bold text-[#CC0000]">{progress}%</span>
                                </div>
                            </div>
                            <button onClick={onToggleReflection} className={`px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 ${gameState.reflectionPhase ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}`}>
                                <Icon name={gameState.reflectionPhase ? 'Unlock' : 'Lock'} className="w-4 h-4"/> {gameState.reflectionPhase ? 'Reflection Open' : 'Unlock Reflection'}
                            </button>
                            <button onClick={onReset} className="p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-red-600"><Icon name="RefreshCw" className="w-5 h-5"/></button>
                        </div>
                    </header>
                    <main className="p-8 grid grid-cols-1 xl:grid-cols-2 gap-8 max-w-[1600px] mx-auto">
                        {gameState.projects.map((p, i) => (
                            <div key={p.id} className="border border-gray-200 rounded-2xl p-6 bg-white shadow-sm hover:shadow-md transition-all">
                                <div className="flex justify-between items-center mb-6">
                                    <div className="flex items-center gap-3">
                                        <span className="w-8 h-8 rounded bg-[#111] text-white flex items-center justify-center font-bold text-sm">{i+1}</span>
                                        <span className="font-bold text-sm uppercase tracking-wide">{p.initiator.replace('_',' ')} CHAIN</span>
                                    </div>
                                    <span className={`text-xs font-bold px-2 py-1 rounded ${p.isComplete ? 'bg-green-50 text-green-700' : 'bg-gray-100 text-gray-500'}`}>{p.isComplete ? 'COMPLETE' : `STEP ${p.turns.length}/5`}</span>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="flex-1 text-center">
                                        <div className="text-[10px] font-bold uppercase text-gray-400 mb-2">Start</div>
                                        {p.turns[0] ? (
                                            <img src={p.turns[0].generatedImage} onClick={() => setZoom({src: p.turns[0].generatedImage, cap: p.turns[0].prompt})} className="w-full aspect-square object-cover rounded-lg border cursor-zoom-in hover:brightness-90 transition-all"/>
                                        ) : <div className="w-full aspect-square rounded-lg border-2 border-dashed flex items-center justify-center text-gray-300">Wait</div>}
                                    </div>
                                    <Icon name="ArrowRight" className="text-gray-300"/>
                                    <div className="flex-1 text-center">
                                        <div className="text-[10px] font-bold uppercase text-gray-400 mb-2">Current</div>
                                        {p.turns.length > 0 ? (
                                            <img src={p.turns[p.turns.length-1].generatedImage} onClick={() => setZoom({src: p.turns[p.turns.length-1].generatedImage, cap: p.turns[p.turns.length-1].prompt})} className="w-full aspect-square object-cover rounded-lg border cursor-zoom-in hover:brightness-90 transition-all"/>
                                        ) : <div className="w-full aspect-square rounded-lg border-2 border-dashed flex items-center justify-center text-gray-300">Wait</div>}
                                    </div>
                                </div>
                                <button onClick={() => setExpand(p)} className="mt-6 w-full py-3 border border-gray-200 hover:border-[#111] rounded-xl font-bold text-sm uppercase transition-all">Inspect Journey</button>
                            </div>
                        ))}
                    </main>

                    {/* Modals */}
                    {expand && (
                        <div className="fixed inset-0 z-50 bg-white/95 backdrop-blur overflow-y-auto">
                            <div className="sticky top-0 bg-white border-b p-6 flex justify-between items-center shadow-sm">
                                <h2 className="text-xl font-bold">Project Analysis: Group {expand.initiator.split('_')[1]}</h2>
                                <button onClick={() => setExpand(null)}><Icon name="X" className="w-6 h-6"/></button>
                            </div>
                            <div className="p-10 max-w-[1600px] mx-auto">
                                <div className="grid grid-cols-5 gap-4">
                                    {Array(5).fill(null).map((_, i) => (
                                        <div key={i} className={!expand.turns[i] ? 'opacity-30' : ''}>
                                            <div className="text-[10px] font-bold uppercase text-gray-400 mb-2">Step {i+1}</div>
                                            {expand.turns[i] ? (
                                                <div className="space-y-3">
                                                    <img src={expand.turns[i].generatedImage} onClick={() => setZoom({src: expand.turns[i].generatedImage, cap: expand.turns[i].prompt})} className="w-full aspect-square object-cover rounded-lg border cursor-zoom-in hover:scale-105 transition-transform"/>
                                                    <div className="text-xs bg-gray-50 p-2 rounded border h-20 overflow-y-auto">{expand.turns[i].prompt}</div>
                                                </div>
                                            ) : <div className="w-full aspect-square border-2 border-dashed rounded-lg flex items-center justify-center text-gray-300"><Icon name="Clock" className="w-6 h-6"/></div>}
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-8 bg-gray-50 p-6 rounded-xl border">
                                    <h3 className="font-bold mb-2">Reflection</h3>
                                    <p className="text-gray-600 italic">"{expand.reflection || 'Pending submission...'}"</p>
                                </div>
                            </div>
                        </div>
                    )}

                    {zoom && (
                        <div className="fixed inset-0 z-[60] bg-black/90 flex flex-col items-center justify-center p-8" onClick={() => setZoom(null)}>
                            <img src={zoom.src} className="max-h-[80vh] w-auto rounded shadow-2xl mb-4"/>
                            <p className="text-white text-center bg-gray-800 px-4 py-2 rounded border border-gray-700 max-w-2xl">{zoom.cap}</p>
                        </div>
                    )}
                </div>
            )
        };

        const App = () => {
            const [gameState, setGameState] = useState({ 
                projects: GROUP_ORDER.map((r,i) => ({ id: `p${i}`, initiator: r, turns: [], isComplete: false, reflection: null })),
                reflectionPhase: false 
            });
            const [role, setRole] = useState(null);
            const [pass, setPass] = useState('');
            const [showPass, setShowPass] = useState(false);
            const [keyError, setKeyError] = useState(false);

            useEffect(() => {
                // Check if API key is set in the module script via global check or similar
                // We handle this at the generation step, but we can also warn early.
            }, []);

            const handleTurn = (pid, prompt, img) => {
                setGameState(prev => {
                    const projects = prev.projects.map(p => {
                        if(p.id !== pid) return p;
                        const turns = [...p.turns, { groupId: role, prompt, generatedImage: img }];
                        return { ...p, turns, isComplete: turns.length >= 5 };
                    });
                    return { ...prev, projects };
                });
            };

            const getTask = () => {
                if(!role || role === 'TEACHER') return null;
                if(gameState.reflectionPhase) {
                    const p = gameState.projects.find(proj => proj.initiator === role);
                    return (!p.reflection) ? { type: 'REFLECT', project: p } : { type: 'DONE' };
                }
                const gIdx = GROUP_ORDER.indexOf(role);
                for(let r=1; r<=5; r++) {
                    let iIdx = (gIdx - (r-1)) % 5;
                    if(iIdx < 0) iIdx += 5;
                    const p = gameState.projects[iIdx];
                    if(p.turns.length >= r) continue;
                    if(p.turns.length < r-1) return { type: 'WAIT', round: r };
                    return { type: 'ACT', round: r, project: p };
                }
                return { type: 'DONE' };
            };

            const task = getTask();

            // Landing Screen
            if(!role) return (
                <div className="min-h-screen bg-white p-8 font-sans">
                    <div className="max-w-5xl mx-auto py-12 text-center">
                        <h1 className="text-5xl font-bold mb-6">AI Visual Telephone</h1>
                        <p className="text-xl text-gray-500 mb-12 max-w-2xl mx-auto">Collaborative generative AI design game.</p>
                        <div className="grid md:grid-cols-2 gap-12 text-left">
                            <div>
                                <h2 className="text-2xl font-bold mb-6 flex gap-2 items-center"><Icon name="Users" className="text-[#CC0000]"/> Student Groups</h2>
                                <div className="grid grid-cols-3 gap-4">
                                    {GROUP_ORDER.map((g,i) => (
                                        <button key={g} onClick={() => setRole(g)} className="hover-card bg-gray-50 p-6 rounded-xl border hover:border-gray-300 flex flex-col items-center">
                                            <div className="w-12 h-12 bg-white rounded-full flex items-center justify-center font-bold shadow-sm mb-2 text-lg">{i+1}</div>
                                            <span className="text-sm font-bold">Group {i+1}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-gray-50 p-8 rounded-2xl border flex flex-col justify-center">
                                <h2 className="text-2xl font-bold mb-4 flex gap-2 items-center"><Icon name="MonitorPlay" className="text-[#CC0000]"/> Instructor</h2>
                                <p className="text-gray-600 mb-6">Access dashboard for real-time monitoring.</p>
                                <button onClick={() => setShowPass(true)} className="btn-primary py-3 px-6 rounded-xl font-bold w-fit">Open Dashboard</button>
                            </div>
                        </div>
                        {showPass && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                                <div className="bg-white p-8 rounded-2xl w-full max-w-sm">
                                    <h3 className="font-bold text-xl mb-4">Instructor Code</h3>
                                    <input type="password" autoFocus className="w-full p-3 border rounded-lg mb-4 text-lg" placeholder="2025" value={pass} onChange={e => setPass(e.target.value)} onKeyDown={e => { if(e.key === 'Enter' && pass === '2025') { setRole('TEACHER'); setShowPass(false); }}}/>
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowPass(false)} className="flex-1 py-3 text-gray-500 font-bold">Cancel</button>
                                        <button onClick={() => { if(pass === '2025') { setRole('TEACHER'); setShowPass(false); }}} className="flex-1 py-3 bg-[#111] text-white rounded-lg font-bold">Enter</button>
                                    </div>
                                </div>
                            </div>
                        )}
                        <div className="mt-20 pt-8 border-t text-gray-400 text-sm">CM501 Fall 2025</div>
                    </div>
                </div>
            );

            if(role === 'TEACHER') return (
                <>
                    <button onClick={() => setRole(null)} className="fixed top-5 right-5 z-50 text-sm font-bold text-gray-400 hover:text-red-600 underline">Exit</button>
                    <TeacherDashboard gameState={gameState} onReset={() => setGameState(INITIAL_GAME_STATE)} onToggleReflection={() => setGameState(p => ({...p, reflectionPhase: !p.reflectionPhase}))} />
                </>
            );

            if(task.type === 'WAIT' || task.type === 'DONE') return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-white p-8 text-center">
                    <button onClick={() => setRole(null)} className="fixed top-5 right-5 z-50 text-sm font-bold text-gray-400 hover:text-red-600 underline">Exit</button>
                    <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-6 ${task.type === 'WAIT' ? 'spinner border-4 border-gray-100 border-t-red-600' : 'bg-green-100 text-green-600'}`}>
                        {task.type === 'DONE' && <Icon name="CheckCircle2" className="w-10 h-10"/>}
                    </div>
                    <h2 className="text-3xl font-bold mb-2">{task.type === 'WAIT' ? 'Pending...' : 'All Done!'}</h2>
                    <p className="text-gray-500">{task.type === 'WAIT' ? `Waiting for Round ${task.round-1} to finish.` : 'Return to main screen.'}</p>
                </div>
            );

            if(task.type === 'REFLECT') return (
                <div className="min-h-screen bg-white p-8">
                     <div className="max-w-2xl mx-auto py-12">
                        <h1 className="text-3xl font-bold mb-6">Final Reflection</h1>
                        <p className="mb-8 text-gray-600">Review your group's initiating chain and discuss.</p>
                        <div className="flex gap-4 mb-8">
                            <div className="flex-1 text-center bg-gray-50 p-4 rounded-lg"><span className="text-xs font-bold uppercase text-gray-400">Start</span><img src={task.project.turns[0].generatedImage} className="mt-2 rounded"/></div>
                            <div className="flex-1 text-center bg-gray-50 p-4 rounded-lg"><span className="text-xs font-bold uppercase text-gray-400">End</span><img src={task.project.turns[task.project.turns.length-1].generatedImage} className="mt-2 rounded"/></div>
                        </div>
                        <textarea id="reflect-txt" className="w-full p-4 border rounded-xl h-40 mb-4 text-lg" placeholder="Write your group discussion notes here..."></textarea>
                        <button onClick={() => { const val = document.getElementById('reflect-txt').value; setGameState(p => ({...p, projects: p.projects.map(proj => proj.id === task.project.id ? {...proj, reflection: val} : proj)})); setRole(null); }} className="btn-primary w-full py-4 rounded-xl font-bold">Submit & Finish</button>
                     </div>
                </div>
            );

            return (
                <>
                    <button onClick={() => setRole(null)} className="fixed top-5 right-5 z-50 text-sm font-bold text-gray-400 hover:text-red-600 underline">Exit</button>
                    <StudentView 
                        currentGroup={role} 
                        roundNumber={task.round} 
                        projectId={task.project.id} 
                        previousTurn={task.round > 1 ? task.project.turns[task.round-2] : null}
                        onTurnComplete={(txt, img) => handleTurn(task.project.id, txt, img)}
                    />
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
