<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Visual Telephone</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Manrope -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- IMPORT MAP: This tells the browser where to download the libraries -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "@google/genai": "https://esm.sh/@google/genai@0.1.1",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0"
        }
    }
    </script>

    <style>
      body {
        font-family: 'Manrope', sans-serif;
        color: #111;
        background: #fff;
      }
      
      /* Buttons */
      .btn-primary {
        background: #111;
        color: #fff;
        transition: all 0.25s ease;
      }
      .btn-primary:hover {
        background: #CC0000;
        transform: translateY(-3px);
        box-shadow: 0 6px 14px rgba(0,0,0,0.12);
      }
      .btn-secondary {
        background: #f1f3f5;
        color: #444;
        transition: all 0.25s ease;
      }
      .btn-secondary:hover {
        background: #e2e6ea;
        transform: translateY(-2px);
      }

      /* Card Hover Effects */
      .hover-card {
        transition: transform 0.25s ease, box-shadow 0.25s ease;
      }
      .hover-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      }
      
      /* Error Box */
      #error-container {
          display: none;
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: #fee2e2;
          color: #991b1b;
          padding: 1rem;
          border-radius: 8px;
          border: 1px solid #f87171;
          max-width: 400px;
          z-index: 9999;
          font-size: 0.875rem;
          font-family: monospace;
      }
    </style>
</head>
<body class="bg-white text-slate-900">
    <div id="root">
        <!-- Loading State before React kicks in -->
        <div class="h-screen w-full flex flex-col items-center justify-center">
            <div class="w-12 h-12 border-4 border-gray-200 border-t-[#CC0000] rounded-full animate-spin mb-4"></div>
            <p class="text-gray-500 font-medium animate-pulse">Loading Application...</p>
        </div>
    </div>
    
    <div id="error-container"></div>

    <script>
        // Global Error Handler to help debug on GitHub Pages
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            const container = document.getElementById('error-container');
            container.style.display = 'block';
            container.innerHTML = `<strong>Error:</strong> ${msg}<br><small>${url}:${lineNo}</small>`;
            return false;
        };
        window.onunhandledrejection = function(event) {
            const container = document.getElementById('error-container');
            container.style.display = 'block';
            container.innerText = "Async Error: " + event.reason;
        };
    </script>

    <!-- MAIN APP SCRIPT -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { GoogleGenAI } from '@google/genai';
        import { 
            Users, GraduationCap, ArrowRight, MonitorPlay, Loader2, Send, 
            Image as ImageIcon, AlertCircle, Edit3, Lightbulb, RefreshCw, 
            ZoomIn, X, Clock, CheckCircle2, Maximize2, MoveRight, Lock, Unlock 
        } from 'lucide-react';

        // ------------------------------------------------------------------
        // *** CONFIGURATION ***
        // ------------------------------------------------------------------
        
        // INSTRUCTOR: PASTE YOUR API KEY INSIDE THE QUOTES BELOW
        const HARDCODED_API_KEY = "AIzaSyBqHLJJIkH7FG91D2TLv7jEalI9Jht3N44"; 

        // ------------------------------------------------------------------
        // 1. CONSTANTS & TYPES
        // ------------------------------------------------------------------

        const GROUP_ORDER = ['GROUP_1', 'GROUP_2', 'GROUP_3', 'GROUP_4', 'GROUP_5'];

        const INITIATOR_THEMES = {
            'GROUP_1': "What would your classroom look like if it became a magical world on the last day?",
            'GROUP_2': "Create a scene where everything goes hilariously wrong on the last day of class.",
            'GROUP_3': "How would the last day of class look in a school of the distant future?",
            'GROUP_4': "Illustrate the abstract concept of 'finishing something important' as a visual story.",
            'GROUP_5': "Show the bittersweet feeling of walking out of the classroom for the very last time.",
            'TEACHER': ""
        };

        const PROMPT_RECIPE = [
            {
                name: "The Subject",
                description: "What is it?",
                examples: ["A chair", "A futuristic sneaker", "A perfume bottle", "A bus stop", "A tiny house", "A geometric explosion", "Letter 'A'"]
            },
            {
                name: "The Style",
                description: "History & Movement",
                examples: ["Art Deco", "Bauhaus", "Art Nouveau", "Cyberpunk", "Minimalist", "Memphis Design", "In the style of Wes Anderson"]
            },
            {
                name: "The Material",
                description: "What is it made of?",
                examples: ["Polished chrome", "Raw concrete", "Rusted iron", "Blue velvet", "Fluffy cotton candy", "Translucent plastic", "Glowing neon tubing"]
            },
            {
                name: "The Vibe",
                description: "Camera & Lighting",
                examples: ["Cinematic lighting", "Golden hour", "Neon noir", "Studio softbox", "Isometric view", "Macro close-up", "Fish-eye lens"]
            }
        ];

        const INITIAL_GAME_STATE = {
            projects: GROUP_ORDER.map((role, index) => ({
                id: `project-${index + 1}`,
                initiator: role,
                turns: [],
                reflection: null,
                isComplete: false
            })),
            reflectionPhase: false
        };

        // ------------------------------------------------------------------
        // 2. SERVICE (Gemini)
        // ------------------------------------------------------------------
        
        let genAIClient = null;

        const initGemini = (apiKey) => {
            try {
                genAIClient = new GoogleGenAI({ apiKey });
            } catch (e) {
                console.error("Failed to init Gemini", e);
                alert("Critical Error: Could not initialize Google AI. Check API Key.");
            }
        };

        const generateImage = async (prompt) => {
            if (!genAIClient) throw new Error("API Key missing. Instructor needs to set HARDCODED_API_KEY in the code.");

            try {
                // Using flash-image for speed in this demo context
                const model = 'gemini-2.5-flash-image';
                const enhancedPrompt = `${prompt}, photorealistic, realistic photograph, 8k, highly detailed, sharp focus, cinematic lighting`;

                const response = await genAIClient.models.generateContent({
                    model: model,
                    contents: { parts: [{ text: enhancedPrompt }] },
                });

                if (response.candidates?.[0]?.content?.parts) {
                    for (const part of response.candidates[0].content.parts) {
                        if (part.inlineData && part.inlineData.data) {
                            const mimeType = part.inlineData.mimeType || 'image/png';
                            return `data:${mimeType};base64,${part.inlineData.data}`;
                        }
                    }
                }
                throw new Error("No image data found in response");
            } catch (error) {
                console.error("Error generating image:", error);
                throw error;
            }
        };

        // ------------------------------------------------------------------
        // 3. COMPONENTS
        // ------------------------------------------------------------------

        // --- Prompt Guide (Passive) ---
        const PromptGuide = () => {
            return (
                <div className="bg-white h-full overflow-y-auto border-l border-gray-100 hidden xl:block w-[400px] shrink-0">
                    <div className="p-8">
                        <h3 className="text-xl font-bold text-[#111] mb-6 tracking-tight">Prompt Recipe Formula</h3>
                        <div className="p-5 bg-[#fafafa] border border-gray-100 rounded-xl mb-10">
                            <p className="text-sm font-bold text-[#111] mb-2">Instructions:</p>
                            <p className="text-sm text-gray-600 leading-relaxed">
                                Brainstorm one item from each of the four categories below.
                            </p>
                            <div className="mt-4 pt-4 border-t border-gray-200 font-mono text-xs text-[#CC0000] font-bold tracking-wide">
                                Subject + Art Style + Material + Vibe
                            </div>
                        </div>
                        <div className="space-y-10">
                            {PROMPT_RECIPE.map((category, idx) => (
                                <div key={idx}>
                                    <h4 className="text-sm font-bold text-[#111] uppercase tracking-wider border-b border-gray-100 pb-3 mb-4 flex justify-between">
                                        <span>{idx + 1}. {category.name}</span>
                                    </h4>
                                    <p className="text-sm text-gray-600 leading-relaxed pl-4 border-l-2 border-gray-100">
                                        {category.examples.join(', ')}, etc.
                                    </p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Student View (Game Phase) ---
        const StudentView = ({ currentGroup, roundNumber, previousTurn, projectId, onTurnComplete }) => {
            const [prompt, setPrompt] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const [generatedImage, setGeneratedImage] = useState(null);
            const [error, setError] = useState(null);

            const isInitiator = roundNumber === 1;
            const referenceImage = previousTurn?.generatedImage;

            const handleGenerate = async () => {
                if (!prompt.trim()) return;
                setIsGenerating(true);
                setError(null);
                try {
                    const base64Image = await generateImage(prompt);
                    setGeneratedImage(base64Image);
                } catch (err) {
                    setError("Generation failed. Please check if API Key is configured in source code.");
                } finally {
                    setIsGenerating(false);
                }
            };

            return (
                <div className="h-screen bg-white flex flex-col md:flex-row overflow-hidden">
                    <div className="flex-1 flex flex-col h-full overflow-y-auto">
                        <div className="max-w-4xl mx-auto w-full p-8 md:p-12 space-y-10">
                            {/* Header */}
                            <div className="space-y-4 border-b border-gray-200 pb-8">
                                <div className="flex items-center gap-4">
                                    <span className="w-12 h-12 rounded-xl bg-[#111] text-white flex items-center justify-center text-xl font-bold">
                                        {currentGroup.replace('GROUP_', '')}
                                    </span>
                                    <div>
                                        <h1 className="text-3xl font-bold tracking-tight text-[#111]">
                                            {isInitiator ? 'The Initiator' : 'The Interpreter'}
                                        </h1>
                                        <span className="text-sm font-bold text-[#CC0000] uppercase tracking-wider">
                                            Round {roundNumber} / 5
                                        </span>
                                    </div>
                                </div>
                                <p className="text-gray-600 text-lg leading-relaxed max-w-3xl">
                                    {isInitiator 
                                        ? 'Start a new visual chain. Write a detailed prompt based on your theme.' 
                                        : 'Analyze the incoming image. Recreate it by writing a new prompt.'}
                                </p>
                            </div>

                            {/* Initiator Theme */}
                            {isInitiator && (
                                <div className="bg-amber-50 border border-amber-200 p-6 rounded-xl flex items-start gap-4 animate-in slide-in-from-top-4">
                                    <div className="bg-white p-2 rounded-full shadow-sm shrink-0">
                                        <Lightbulb className="w-6 h-6 text-amber-500" />
                                    </div>
                                    <div>
                                        <h3 className="font-bold text-amber-900 text-lg mb-2">Theme: "The Last Day"</h3>
                                        <p className="text-amber-900 text-xl font-semibold font-serif italic">"{INITIATOR_THEMES[currentGroup]}"</p>
                                    </div>
                                </div>
                            )}

                            {/* Reference Image */}
                            {referenceImage && (
                                <div className="bg-[#f9f9f9] p-8 rounded-2xl border border-gray-100">
                                    <div className="flex items-center gap-2 mb-6 text-gray-500 text-xs font-bold uppercase tracking-widest">
                                        <ImageIcon className="w-4 h-4" /> Incoming Transmission
                                    </div>
                                    <div className="bg-white border p-1 rounded-lg">
                                        <img src={referenceImage} className="w-full max-h-[500px] object-contain mx-auto" />
                                    </div>
                                </div>
                            )}

                            {/* Workspace */}
                            <div className="bg-white rounded-xl">
                                <h2 className="text-lg font-bold text-[#111] mb-4 flex items-center gap-2">
                                    <Edit3 className="w-5 h-5 text-[#CC0000]" /> Draft Prompt
                                </h2>
                                <textarea
                                    value={prompt}
                                    onChange={(e) => setPrompt(e.target.value)}
                                    placeholder={isInitiator ? "Describe your theme (Subject + Style + Material + Vibe)..." : "Describe the image above in your own words..."}
                                    className="w-full p-6 rounded-xl bg-[#fafafa] border border-gray-200 focus:bg-white focus:ring-2 focus:ring-[#111] min-h-[160px] text-lg font-medium text-[#111] transition-all"
                                />
                                {error && <div className="mt-4 p-4 bg-red-50 text-[#CC0000] rounded-lg text-sm font-bold flex items-center gap-2"><AlertCircle className="w-4 h-4"/>{error}</div>}

                                <div className="mt-6">
                                    {!generatedImage ? (
                                        <button onClick={handleGenerate} disabled={isGenerating || !prompt} className="btn-primary w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2 text-lg disabled:opacity-50 transition-all">
                                            {isGenerating ? <Loader2 className="animate-spin" /> : <ImageIcon />}
                                            {isGenerating ? 'GENERATING...' : 'GENERATE IMAGE'}
                                        </button>
                                    ) : (
                                        <div className="space-y-6 animate-in fade-in slide-in-from-bottom-8">
                                            <div className="bg-[#fafafa] border border-gray-100 rounded-lg overflow-hidden p-1 shadow-sm">
                                                <img src={generatedImage} className="w-full max-h-[500px] object-contain mx-auto rounded" />
                                            </div>
                                            <div className="flex gap-4">
                                                <button onClick={() => setGeneratedImage(null)} className="btn-secondary flex-1 py-4 rounded-xl font-bold">Discard</button>
                                                <button onClick={() => onTurnComplete(prompt, generatedImage)} className="bg-[#111] hover:bg-[#CC0000] text-white flex-[2] py-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-xl hover:-translate-y-1 transition-all">
                                                    <Send className="w-5 h-5" /> TRANSMIT
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="h-20"></div>
                        </div>
                    </div>
                    <PromptGuide />
                </div>
            );
        };

        // --- Reflection View (Phase 2) ---
        const ReflectionView = ({ project, onSubmit }) => {
            const [reflection, setReflection] = useState('');
            
            const firstImage = project.turns[0]?.generatedImage;
            const lastImage = project.turns[project.turns.length - 1]?.generatedImage;

            return (
                <div className="min-h-screen bg-white text-[#111] p-8 md:p-12 overflow-y-auto">
                    <div className="max-w-5xl mx-auto space-y-12">
                        <header className="text-center space-y-4">
                            <h1 className="text-4xl font-bold tracking-tight">Project Reflection</h1>
                            <p className="text-xl text-gray-600">Review the evolution of your initiating project and discuss the changes.</p>
                        </header>

                        <div className="grid md:grid-cols-2 gap-8 items-start">
                            <div className="space-y-4">
                                <div className="bg-gray-50 p-6 rounded-2xl border border-gray-100 text-center">
                                    <span className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 block">Where it Started</span>
                                    <div className="bg-white p-1 rounded-lg border border-gray-100 shadow-sm mb-4">
                                        <img src={firstImage} className="w-full h-auto rounded" />
                                    </div>
                                    <p className="text-sm font-mono text-gray-500 bg-white p-3 rounded border">"{project.turns[0]?.prompt}"</p>
                                </div>
                            </div>
                            <div className="space-y-4">
                                <div className="bg-gray-50 p-6 rounded-2xl border border-gray-100 text-center">
                                    <span className="text-xs font-bold text-[#CC0000] uppercase tracking-widest mb-4 block">Where it Ended</span>
                                    <div className="bg-white p-1 rounded-lg border border-gray-100 shadow-sm mb-4">
                                        <img src={lastImage} className="w-full h-auto rounded" />
                                    </div>
                                    <p className="text-sm font-mono text-gray-500 bg-white p-3 rounded border">"{project.turns[project.turns.length-1]?.prompt}"</p>
                                </div>
                            </div>
                        </div>

                        <div className="bg-[#fcfcfc] border border-gray-100 rounded-2xl p-8 shadow-sm">
                            <h3 className="text-xl font-bold mb-6 flex items-center gap-2">
                                <Users className="w-6 h-6 text-[#CC0000]" /> Group Discussion
                            </h3>
                            <ul className="list-disc list-inside space-y-2 mb-6 text-gray-600 ml-4 marker:text-[#CC0000]">
                                <li>How did the AI’s interpretation evolve?</li>
                                <li>Did certain details survive or get lost along the way?</li>
                                <li>How did prompt styles influence lighting or composition?</li>
                            </ul>
                            <textarea
                                value={reflection}
                                onChange={(e) => setReflection(e.target.value)}
                                placeholder="Type your group's collective reflection here..."
                                className="w-full p-6 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#111] min-h-[200px] text-lg transition-all outline-none"
                            ></textarea>
                            <button 
                                onClick={() => onSubmit(reflection)}
                                disabled={!reflection.trim()}
                                className="btn-primary mt-6 w-full py-4 rounded-xl font-bold text-lg disabled:opacity-50"
                            >
                                Submit Reflection
                            </button>
                        </div>
                    </div>
                </div>
            )
        };

        // --- Teacher Dashboard ---
        const TeacherDashboard = ({ gameState, onReset, onToggleReflection }) => {
            const [expandedProject, setExpandedProject] = useState(null);
            const [zoomedImage, setZoomedImage] = useState(null);

            const totalTurns = 25;
            const currentTurns = gameState.projects.reduce((acc, p) => acc + p.turns.length, 0);
            const progress = Math.round((currentTurns / totalTurns) * 100);

            return (
                <div className="min-h-screen bg-white pb-20">
                    <header className="bg-white border-b border-gray-100 sticky top-0 z-30 shadow-sm">
                        <div className="max-w-[1600px] mx-auto px-8 h-20 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <div className="w-10 h-10 bg-[#111] text-white flex items-center justify-center font-bold rounded-lg text-lg">T</div>
                                <h1 className="font-bold text-xl tracking-tight">Instructor Dashboard</h1>
                            </div>
                            <div className="flex items-center gap-8">
                                <div className="flex flex-col items-end">
                                    <div className="text-xs text-gray-400 font-bold uppercase tracking-wider mb-1">Progress</div>
                                    <div className="flex items-center gap-3">
                                        <div className="w-40 h-2 bg-gray-100 rounded-full overflow-hidden">
                                            <div className="h-full bg-[#CC0000] transition-all duration-1000" style={{ width: `${progress}%`}}></div>
                                        </div>
                                        <div className="font-bold text-[#CC0000]">{progress}%</div>
                                    </div>
                                </div>
                                <div className="h-8 w-px bg-gray-200"></div>
                                <button onClick={onToggleReflection} className={`flex items-center gap-2 font-bold px-4 py-2 rounded-lg transition-colors ${gameState.reflectionPhase ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                                    {gameState.reflectionPhase ? <Unlock className="w-4 h-4"/> : <Lock className="w-4 h-4"/>}
                                    {gameState.reflectionPhase ? 'Reflection Active' : 'Unlock Reflection'}
                                </button>
                                <button onClick={onReset} className="p-2 text-gray-400 hover:text-[#CC0000] rounded-lg hover:bg-red-50 transition-colors" title="Reset"><RefreshCw className="w-5 h-5"/></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-[1600px] mx-auto px-8 py-10 grid grid-cols-1 xl:grid-cols-2 gap-10">
                        {gameState.projects.map((project, idx) => {
                             const first = project.turns[0];
                             const last = project.turns[project.turns.length - 1];
                             return (
                                <div key={project.id} className="bg-white rounded-2xl shadow-sm border border-gray-100 hover:shadow-[0_8px_30px_rgba(0,0,0,0.08)] transition-all duration-300 flex flex-col">
                                    <div className="px-8 py-5 border-b border-gray-100 flex justify-between items-center bg-[#fcfcfc]">
                                        <div className="flex items-center gap-3">
                                            <span className="w-8 h-8 rounded-lg bg-[#111] text-white flex items-center justify-center font-bold">{idx + 1}</span>
                                            <span className="font-bold uppercase tracking-wide text-sm">{project.initiator.replace('_', ' ')}'s Chain</span>
                                        </div>
                                        <span className={`text-xs font-bold px-3 py-1 rounded-full border ${project.isComplete ? 'bg-green-50 text-green-700 border-green-100' : 'bg-gray-100 text-gray-500 border-gray-200'}`}>
                                            {project.isComplete ? 'COMPLETE' : `STEP ${project.turns.length}/5`}
                                        </span>
                                    </div>
                                    <div className="p-8 flex items-center gap-6 flex-1">
                                        <div className="flex-1 text-center space-y-2">
                                            <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">Start</span>
                                            {first ? (
                                                <div className="aspect-square rounded-xl overflow-hidden border border-gray-200 cursor-zoom-in relative group" onClick={() => setZoomedImage({src: first.generatedImage, cap: first.prompt})}>
                                                    <img src={first.generatedImage} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" />
                                                    <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 flex items-center justify-center transition-colors"><ZoomIn className="text-white opacity-0 group-hover:opacity-100 drop-shadow-sm" /></div>
                                                </div>
                                            ) : <div className="aspect-square bg-gray-50 rounded-xl border-2 border-dashed border-gray-200 flex items-center justify-center text-gray-300">Wait</div>}
                                        </div>
                                        <MoveRight className="text-gray-300 w-8 h-8" />
                                        <div className="flex-1 text-center space-y-2">
                                            <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">Current</span>
                                            {last ? (
                                                <div className="aspect-square rounded-xl overflow-hidden border border-gray-200 cursor-zoom-in relative group" onClick={() => setZoomedImage({src: last.generatedImage, cap: last.prompt})}>
                                                    <img src={last.generatedImage} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" />
                                                    <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 flex items-center justify-center transition-colors"><ZoomIn className="text-white opacity-0 group-hover:opacity-100 drop-shadow-sm" /></div>
                                                </div>
                                            ) : <div className="aspect-square bg-gray-50 rounded-xl border-2 border-dashed border-gray-200 flex items-center justify-center text-gray-300">Wait</div>}
                                        </div>
                                    </div>
                                    <div className="p-4 border-t border-gray-100 bg-[#fcfcfc]">
                                        <button onClick={() => setExpandedProject(project)} className="w-full py-3 bg-white border border-gray-200 hover:border-[#111] hover:bg-[#111] hover:text-white font-bold rounded-xl text-sm uppercase tracking-wide transition-all shadow-sm">
                                            Inspect Journey & Reflection
                                        </button>
                                    </div>
                                </div>
                             )
                        })}
                    </main>

                    {/* Modals */}
                    {expandedProject && (
                        <div className="fixed inset-0 z-50 bg-white/95 backdrop-blur overflow-y-auto animate-in fade-in duration-200">
                            <div className="sticky top-0 bg-white/90 border-b border-gray-100 p-6 flex justify-between items-center z-10 shadow-sm">
                                <div>
                                    <h2 className="text-2xl font-bold tracking-tight">Project Analysis</h2>
                                    <p className="text-gray-500 text-sm">Reviewing {expandedProject.initiator.replace('_',' ')}'s Chain</p>
                                </div>
                                <button onClick={() => setExpandedProject(null)} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><X className="w-6 h-6 hover:text-[#CC0000]" /></button>
                            </div>
                            <div className="max-w-[1600px] mx-auto p-10 space-y-12">
                                {/* Evolution Strip */}
                                <div className="grid grid-cols-5 gap-6">
                                    {Array(5).fill(null).map((_, i) => {
                                        const turn = expandedProject.turns[i];
                                        return (
                                            <div key={i} className={`flex flex-col ${!turn && 'opacity-40 grayscale'} transition-all`}>
                                                <div className="mb-2 flex justify-between items-center text-xs font-bold uppercase tracking-wider text-gray-400">
                                                    <span>Step {i+1}</span>
                                                </div>
                                                <div className="aspect-square rounded-xl overflow-hidden border border-gray-200 bg-gray-50 cursor-zoom-in relative group shadow-sm mb-3" 
                                                     onClick={() => turn && setZoomedImage({src: turn.generatedImage, cap: turn.prompt})}>
                                                    {turn ? (
                                                        <>
                                                            <img src={turn.generatedImage} className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" />
                                                            <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 flex items-center justify-center transition-colors"><ZoomIn className="text-white opacity-0 group-hover:opacity-100 drop-shadow-sm" /></div>
                                                        </>
                                                    ) : (
                                                        <div className="w-full h-full flex items-center justify-center"><Clock className="text-gray-300"/></div>
                                                    )}
                                                </div>
                                                <div className="text-xs text-gray-600 border border-gray-100 p-3 rounded-lg bg-white h-24 overflow-y-auto leading-relaxed shadow-sm">
                                                    {turn?.prompt || 'Waiting for input...'}
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                                {/* Reflection Section */}
                                <div className="bg-[#fcfcfc] p-8 rounded-2xl border border-gray-200">
                                    <h3 className="text-lg font-bold mb-4 text-[#CC0000] flex items-center gap-2">
                                        <Users className="w-5 h-5"/> Final Group Reflection
                                    </h3>
                                    {expandedProject.reflection ? (
                                        <p className="text-lg leading-relaxed text-gray-800 italic border-l-4 border-[#CC0000] pl-4">"{expandedProject.reflection}"</p>
                                    ) : (
                                        <p className="text-gray-400 italic">No reflection submitted yet.</p>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {zoomedImage && (
                        <div className="fixed inset-0 z-[60] bg-black/95 backdrop-blur-sm flex flex-col items-center justify-center p-8 animate-in fade-in duration-200">
                            <button onClick={() => setZoomedImage(null)} className="absolute top-8 right-8 text-white/50 hover:text-white hover:bg-white/10 p-2 rounded-full transition-all"><X className="w-10 h-10" /></button>
                            <img src={zoomedImage.src} className="max-h-[75vh] w-auto object-contain mb-8 rounded-lg shadow-2xl" />
                            <p className="text-white text-center text-lg max-w-4xl bg-[#222] px-6 py-4 rounded-xl border border-white/10 shadow-xl">{zoomedImage.cap}</p>
                        </div>
                    )}
                </div>
            );
        };

        // ------------------------------------------------------------------
        // 4. MAIN APP CONTROLLER
        // ------------------------------------------------------------------

        const App = () => {
            const [gameState, setGameState] = useState(INITIAL_GAME_STATE);
            const [userRole, setUserRole] = useState(null);
            
            // USE HARDCODED KEY IF AVAILABLE
            const [apiKey, setApiKey] = useState(HARDCODED_API_KEY || '');
            
            const [showAuth, setShowAuth] = useState(false);
            const [teacherPwd, setTeacherPwd] = useState('');
            const [pwdError, setPwdError] = useState(false);

            useEffect(() => {
                if (apiKey && apiKey !== "PASTE_YOUR_GOOGLE_API_KEY_HERE") initGemini(apiKey);
            }, [apiKey]);

            const handleTurnComplete = (projectId, prompt, image) => {
                setGameState(prev => {
                    const updatedProjects = prev.projects.map(p => {
                        if (p.id === projectId) {
                            const newTurns = [...p.turns, { groupId: userRole, prompt, generatedImage: image, timestamp: Date.now() }];
                            return { ...p, turns: newTurns, isComplete: newTurns.length >= 5 };
                        }
                        return p;
                    });
                    return { ...prev, projects: updatedProjects };
                });
            };

            const handleReflectionSubmit = (text) => {
                 setGameState(prev => {
                     const updatedProjects = prev.projects.map(p => {
                         if (p.initiator === userRole) {
                             return { ...p, reflection: text };
                         }
                         return p;
                     });
                     return { ...prev, projects: updatedProjects };
                 });
                 setUserRole(null); // Return to home after submission
            };

            const handleReset = () => {
                if(confirm("Reset entire class activity? All generated images and prompts will be lost.")) {
                    setGameState(INITIAL_GAME_STATE);
                }
            };

            // Task Logic
            const getActiveTask = () => {
                if (!userRole || userRole === 'TEACHER') return null;
                
                // If reflection phase is active and user is an initiator
                if (gameState.reflectionPhase) {
                    const myProject = gameState.projects.find(p => p.initiator === userRole);
                    // Only if they haven't submitted yet
                    if (!myProject.reflection) return { status: 'REFLECTION', project: myProject };
                    return { status: 'COMPLETE_ALL' };
                }

                const groupIndex = GROUP_ORDER.indexOf(userRole);
                for (let round = 1; round <= 5; round++) {
                    let initiatorIndex = (groupIndex - (round - 1)) % 5;
                    if (initiatorIndex < 0) initiatorIndex += 5;
                    const project = gameState.projects[initiatorIndex];
                    if (project.turns.length >= round) continue;
                    if (project.turns.length < round - 1) return { status: 'WAITING', round, project };
                    return { status: 'ACTIVE', round, project };
                }
                return { status: 'COMPLETE_GAME' };
            };

            // --- VIEW ROUTING ---
            
            // 2. Teacher Dashboard
            if (userRole === 'TEACHER') {
                return (
                    <>
                        <button onClick={() => setUserRole(null)} className="fixed top-6 right-6 z-50 text-sm font-semibold text-gray-400 hover:text-[#CC0000] underline decoration-2 decoration-transparent hover:decoration-[#CC0000] transition-all">Exit Dashboard</button>
                        <TeacherDashboard 
                            gameState={gameState} 
                            onReset={handleReset} 
                            onToggleReflection={() => setGameState(p => ({...p, reflectionPhase: !p.reflectionPhase}))} 
                        />
                    </>
                );
            }

            // 3. Task Views
            const task = getActiveTask();

            if (task?.status === 'REFLECTION') {
                return <ReflectionView project={task.project} onSubmit={handleReflectionSubmit} />;
            }
            
            if (task?.status === 'ACTIVE') {
                 return (
                    <>
                        <button onClick={() => setUserRole(null)} className="fixed top-6 right-6 z-50 text-sm font-semibold text-gray-400 hover:text-[#CC0000] underline decoration-2 decoration-transparent hover:decoration-[#CC0000] transition-all">Exit Role</button>
                        <StudentView 
                            key={`${userRole}-${task.round}`}
                            currentGroup={userRole} 
                            roundNumber={task.round}
                            projectId={task.project.id}
                            previousTurn={task.round > 1 ? task.project.turns[task.round - 2] : null}
                            onTurnComplete={(prompt, img) => handleTurnComplete(task.project.id, prompt, img)}
                        />
                    </>
                 );
            }
            
            if (task?.status === 'WAITING' || task?.status === 'COMPLETE_GAME' || task?.status === 'COMPLETE_ALL') {
                return (
                    <div className="min-h-screen bg-white flex flex-col items-center justify-center p-8 text-center font-sans">
                        <button onClick={() => setUserRole(null)} className="fixed top-6 right-6 z-50 text-sm font-semibold text-gray-400 hover:text-[#CC0000] underline decoration-2 decoration-transparent hover:decoration-[#CC0000] transition-all">Exit Role</button>
                        <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-8 ${task.status === 'WAITING' ? 'border-4 border-slate-100 border-t-[#CC0000] animate-spin' : 'bg-green-50 text-green-600'}`}>
                            {task.status === 'WAITING' ? '' : <GraduationCap className="w-10 h-10" />}
                        </div>
                        <h2 className="text-3xl font-bold text-[#111] mb-4">
                            {task.status === 'WAITING' ? 'Transmission Pending' : 'All Tasks Complete'}
                        </h2>
                        <p className="text-gray-500 max-w-lg mx-auto text-lg leading-relaxed">
                            {task.status === 'WAITING' 
                                ? `Please wait. The previous group is still working on Round ${task.round - 1}.` 
                                : gameState.reflectionPhase 
                                    ? "Your reflection has been recorded. Please return to the main display." 
                                    : "Great work! Please wait for the Instructor to unlock the Reflection Phase."}
                        </p>
                        {task.status === 'WAITING' && (
                             <div className="mt-8 px-4 py-2 bg-[#f9f9f9] rounded text-sm font-mono text-slate-500 border border-slate-200">
                                WAITING FOR: PROJECT {task.project.id.toUpperCase()}
                             </div>
                        )}
                    </div>
                );
            }

            // 4. Landing Page (Role Selection)
            return (
                <div className="min-h-screen bg-white text-[#111] font-sans">
                    <div className="max-w-[1120px] mx-auto px-6 py-20">
                        <div className="text-center mb-16">
                            <h1 className="text-4xl md:text-5xl font-bold tracking-tight mb-6 text-[#111]">AI Visual Telephone</h1>
                            <p className="text-lg md:text-xl text-gray-500 max-w-2xl mx-auto font-normal leading-relaxed">
                                An interactive collaborative game where groups translate visuals back into language using Generative AI.
                            </p>
                        </div>

                        <div className="grid lg:grid-cols-2 gap-12 items-start">
                            <div>
                                <h2 className="text-2xl font-bold mb-6 flex items-center gap-3">
                                    <Users className="w-6 h-6 text-[#CC0000]" /> Student Groups
                                </h2>
                                <div className="grid grid-cols-2 sm:grid-cols-3 gap-6">
                                    {GROUP_ORDER.map((group, idx) => (
                                        <button key={group} onClick={() => setUserRole(group)} className="hover-card bg-[#f9f9f9] rounded-xl p-6 text-center border border-transparent hover:border-gray-200 group flex flex-col items-center h-48 justify-center transition-all">
                                            <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-4 shadow-sm group-hover:shadow-md group-hover:text-[#CC0000] text-2xl font-bold transition-all">{idx + 1}</div>
                                            <p className="font-semibold text-[#111]">Group {idx + 1}</p>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-[#f9f9f9] p-8 rounded-2xl border border-gray-100 flex flex-col justify-center text-center lg:text-left h-full shadow-sm">
                                <h2 className="text-2xl font-bold mb-4 flex items-center gap-3 justify-center lg:justify-start">
                                    <MonitorPlay className="w-6 h-6 text-[#CC0000]" /> Instructor
                                </h2>
                                <p className="mb-8 text-gray-600 leading-relaxed">
                                    Access the centralized dashboard to monitor progress in real-time, view side-by-side comparisons, and facilitate the final class discussion.
                                </p>
                                <button onClick={() => setShowAuth(true)} className="btn-primary py-4 px-8 rounded-xl font-bold text-lg w-full lg:w-auto self-start flex items-center justify-center gap-2">
                                    Launch Dashboard <ArrowRight className="w-5 h-5" />
                                </button>
                            </div>
                        </div>
                        
                         <div className="mt-20 pt-10 border-t border-slate-100 text-center text-slate-400 text-sm">
                            <p>CM501 • Fall 2025 • Visual Communication Design</p>
                         </div>
                    </div>

                    {/* Password Modal */}
                    {showAuth && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                            <div className="bg-white rounded-2xl p-8 max-w-sm w-full shadow-2xl animate-in zoom-in-95 duration-200 border border-gray-100">
                                <h3 className="text-xl font-bold text-[#111] mb-2">Instructor Access</h3>
                                <p className="text-sm text-gray-500 mb-6">Enter passcode to view dashboard.</p>
                                
                                <input type="password" value={teacherPwd} onChange={e => {setTeacherPwd(e.target.value); setPwdError(false);}} 
                                    className={`w-full p-4 border rounded-xl mb-4 outline-none transition-all font-medium text-lg ${pwdError ? 'border-red-300 bg-red-50 text-red-900' : 'border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-[#111]'}`} 
                                    placeholder="Passcode" autoFocus 
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter') {
                                             if (teacherPwd === '2025') { setUserRole('TEACHER'); setShowAuth(false); setTeacherPwd(''); } 
                                             else { setPwdError(true); }
                                        }
                                    }}
                                />
                                {pwdError && <p className="text-[#CC0000] text-sm font-bold mb-4 animate-pulse">Incorrect passcode.</p>}
                                <div className="flex gap-3 mt-2">
                                    <button onClick={() => setShowAuth(false)} className="flex-1 py-3 text-gray-500 hover:bg-gray-100 hover:text-[#111] rounded-xl font-bold transition-colors">Cancel</button>
                                    <button onClick={() => {
                                        if (teacherPwd === '2025') { setUserRole('TEACHER'); setShowAuth(false); setTeacherPwd(''); } 
                                        else { setPwdError(true); }
                                    }} className="flex-1 py-3 bg-[#111] hover:bg-[#CC0000] text-white rounded-xl font-bold shadow-lg transition-all hover:-translate-y-0.5">Enter</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
