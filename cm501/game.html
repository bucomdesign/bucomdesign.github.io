
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Visual Telephone</title>
    
    <!-- STYLES (Tailwind + Fonts) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Manrope', sans-serif; color: #111; background: #fff; }
      
      /* Buttons */
      .btn-primary { background: #111; color: #fff; transition: all 0.2s; }
      .btn-primary:hover { background: #CC0000; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
      .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
      
      .btn-secondary { background: #f1f3f5; color: #444; transition: all 0.2s; }
      .btn-secondary:hover { background: #e2e6ea; transform: translateY(-2px); }
      
      /* Cards */
      .hover-card { transition: transform 0.25s, box-shadow 0.25s; }
      .hover-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }

      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #ddd; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #bbb; }

      /* File Input Hidden styling */
      .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
      .file-input-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
      
      /* Spinner */
      .spinner { animation: spin 1s linear infinite; }
      @keyframes spin { 100% { transform: rotate(360deg); } }
      
      .slide-over { position: fixed; right: 0; top: 0; height: 100%; transition: transform 0.3s ease-in-out; z-index: 40; }
      .slide-over.closed { transform: translateX(100%); }
      .slide-over.open { transform: translateX(0); }
    </style>

    <!-- LIBRARIES -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- PeerJS for Networking -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
</head>
<body>

    <div id="root">
        <!-- Initial Loading State -->
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <div style="width: 50px; height: 50px; border: 5px solid #eee; border-top-color: #CC0000; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 20px; color: #666; font-family: sans-serif;">Initializing Application...</p>
        </div>
    </div>

    <!-- 
      ======================================================
       REACT APPLICATION
      ======================================================
    -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS (SVG Components) ---
        const Icon = ({ name, className }) => {
            const icons = {
                Users: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
                GraduationCap: <><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></>,
                MonitorPlay: <><path d="m10 7 5 3-5 3z"/><rect width="20" height="14" x="2" y="3" rx="2" ry="2"/><path d="M12 17v4"/><path d="M8 21h8"/></>,
                Image: <><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></>,
                Send: <><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></>,
                Edit3: <><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></>,
                AlertCircle: <><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>,
                Lightbulb: <><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5A6 6 0 0 0 6 8c0 1 .5 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></>,
                RefreshCw: <><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></>,
                ZoomIn: <><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/></>,
                X: <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>,
                CheckCircle2: <><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></>,
                Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
                ArrowRight: <><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></>,
                Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
                Unlock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></>,
                UploadCloud: <><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></>,
                Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>,
                Wifi: <><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></>,
                WifiOff: <><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></>,
                BookOpen: <><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>,
                LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>,
                ChevronDown: <><polyline points="6 9 12 15 18 9"/></>,
                ChevronUp: <><polyline points="18 15 12 9 6 15"/></>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10"/>}
                </svg>
            );
        };

        // --- CONSTANTS ---
        const GROUP_ORDER = ['GROUP_1', 'GROUP_2', 'GROUP_3', 'GROUP_4', 'GROUP_5'];
        
        const INITIATOR_THEMES = {
            'GROUP_1': "What would your classroom look like if it became a magical world on the last day?",
            'GROUP_2': "Create a scene where everything goes hilariously wrong on the last day of class.",
            'GROUP_3': "How would the last day of class look in a school of the distant future?",
            'GROUP_4': "Illustrate the abstract concept of 'finishing something important' as a visual story.",
            'GROUP_5': "Show the bittersweet feeling of walking out of the classroom for the very last time.",
            'TEACHER': ""
        };

        const PROMPT_RECIPE = [
            { name: "1. The Subject", examples: ["Design Object (Sneaker, Chair)", "Architecture (Bus stop)", "Abstract (Geometric explosion)", "Diverse group of students"] },
            { name: "2. The Material (Texture)", examples: ["Soft green grass", "Warm checkered blanket", "Fluffy fur", "Polished chrome", "Melting glass"] },
            { name: "3. The Style (Camera)", examples: ["35mm lens", "Waist up shot", "Macro close-up", "Fish-eye lens", "Isometric view"] },
            { name: "4. The Vibe (Lighting)", examples: ["Warm sunset from camera right", "Silk catching motion", "Golden hour", "Neon noir", "Studio softbox"] }
        ];

        // --- COMPONENTS ---

        const PromptGuide = ({ isOpen, onClose, isMobile }) => {
            const [isExpanded, setIsExpanded] = useState(false);

            const Content = () => (
                <div className="p-8 h-full overflow-y-auto">
                    {isMobile && <button onClick={onClose} className="absolute top-4 right-4"><Icon name="X" className="w-6 h-6"/></button>}
                    <h3 className="text-xl font-bold text-[#111] mb-6 tracking-tight">Prompt Engineering 101</h3>
                    
                    <div className="space-y-6 mb-10">
                        <div className="p-5 bg-red-50 border border-red-100 rounded-xl">
                            <h4 className="text-sm font-bold text-[#CC0000] uppercase mb-2">1. Don't Let It Guess</h4>
                            <p className="text-sm text-gray-700 leading-relaxed">
                                Guesses give you random props and strange faces. <br/>
                                <strong>Low quality AI guesses. High quality AI follows direction.</strong>
                            </p>
                        </div>

                        <div className="p-5 bg-blue-50 border border-blue-100 rounded-xl">
                            <h4 className="text-sm font-bold text-blue-900 uppercase mb-2">2. The CTLT Method</h4>
                            <p className="text-sm text-gray-700 leading-relaxed mb-2">
                                Control the frame instead of leaving it to chance. Lock these four elements:
                            </p>
                            <ul className="text-sm text-blue-800 font-bold grid grid-cols-2 gap-2">
                                <li>• <span className="underline">C</span>amera</li>
                                <li>• <span className="underline">T</span>one</li>
                                <li>• <span className="underline">L</span>ight</li>
                                <li>• <span className="underline">T</span>exture</li>
                            </ul>
                        </div>

                        <div className="p-5 bg-gray-50 border border-gray-200 rounded-xl">
                            <h4 className="text-sm font-bold text-[#111] uppercase mb-2">3. Direct, Don't Describe</h4>
                            <div className="text-sm text-gray-700 leading-relaxed space-y-3">
                                <p className="opacity-50 line-through">"A woman in a dress." (Decoration)</p>
                                <p className="font-medium text-[#111]">"35mm lens, waist up, warm sunset from camera right, silk catching motion." (Design)</p>
                            </div>
                        </div>
                    </div>

                    <div className="mb-10 pt-8 border-t border-gray-100">
                        <h4 className="text-sm font-bold text-[#111] uppercase mb-4 tracking-wider">Gold Standard Example</h4>
                        
                        <div className="bg-[#fafafa] p-5 rounded-xl border border-gray-200 space-y-4 text-sm mb-4">
                            <div>
                                <span className="font-bold text-[#CC0000] block text-xs uppercase mb-1">Subject</span>
                                <p className="text-gray-600 leading-relaxed">"A joyful, diverse group of young adults and their exotic pet companions having a picnic gathering outdoors."</p>
                            </div>
                            <div>
                                <span className="font-bold text-[#CC0000] block text-xs uppercase mb-1">Style (Camera)</span>
                                <p className="text-gray-600 leading-relaxed">"Photorealistic, highly detailed, shallow depth of field to keep focus on foreground."</p>
                            </div>
                            <div>
                                <span className="font-bold text-[#CC0000] block text-xs uppercase mb-1">Material (Texture)</span>
                                <p className="text-gray-600 leading-relaxed">"Soft green grass, warm checkered picnic blankets, fluffy animal fur, smooth drink glasses."</p>
                            </div>
                            <div>
                                <span className="font-bold text-[#CC0000] block text-xs uppercase mb-1">Vibe (Light)</span>
                                <p className="text-gray-600 leading-relaxed">"Golden hour outdoor lighting, bright and sunny with a warm glow filtering through trees."</p>
                            </div>
                        </div>

                        {/* Collapsible Full Example */}
                        <button 
                            onClick={() => setIsExpanded(!isExpanded)}
                            className="w-full py-2 px-4 bg-gray-100 hover:bg-gray-200 rounded-lg text-xs font-bold text-gray-700 flex items-center justify-between transition-colors"
                        >
                            <span>{isExpanded ? 'Hide' : 'View'} Full Prompt & Result</span>
                            <Icon name={isExpanded ? 'ChevronUp' : 'ChevronDown'} className="w-4 h-4" />
                        </button>

                        {isExpanded && (
                            <div className="mt-4 animate-in fade-in slide-in-from-top-2">
                                <div className="rounded-lg overflow-hidden border border-gray-200 mb-4 bg-gray-50 relative group">
                                    <img 
                                        src="https://images.unsplash.com/photo-1557400508-ab2019992c30?auto=format&fit=crop&w=800&q=80" 
                                        alt="Picnic Example" 
                                        className="w-full h-auto object-cover"
                                    />
                                    {/* Note: In a real deployment, replace the src above with your specific capybara image URL */}
                                    <div className="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-[10px] p-2 text-center backdrop-blur-sm">
                                        Example Output (Visual Reference)
                                    </div>
                                </div>
                                <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-inner text-xs leading-relaxed text-gray-600 font-medium font-mono">
                                    "A joyful, diverse group of young adults and their exotic pet companions having a picnic gathering outdoors in a park setting. Central focus on two women happily interacting with a golden retriever, a capybara, and other unique animals, sharing drinks. Photorealistic, highly detailed, vibrant, cheerful atmosphere. Soft green grass, warm checkered picnic blankets, casual everyday clothing, fluffy animal fur, smooth drink glasses, string lights, a simple fabric banner. Golden hour outdoor lighting, bright and sunny with a warm glow filtering through trees, a relaxed and friendly community event feel, shallow depth of field to keep focus on the foreground."
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="space-y-6 pt-6 border-t border-gray-100">
                         <h4 className="text-sm font-bold text-[#111] uppercase">Quick Reference</h4>
                        {PROMPT_RECIPE.map((c, i) => (
                            <div key={i}>
                                <h5 className="text-xs font-bold text-gray-900 mb-1">{c.name}</h5>
                                <p className="text-xs text-gray-500 leading-relaxed">{c.examples.join(', ')}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );

            if (isMobile) {
                return (
                    <div className={`slide-over bg-white border-l shadow-2xl w-full sm:w-[450px] ${isOpen ? 'open' : 'closed'}`}>
                        <Content />
                    </div>
                );
            }
            return (
                <div className="bg-white h-full overflow-y-auto border-l border-gray-100 hidden xl:block w-[450px] shrink-0">
                    <Content />
                </div>
            );
        };

        const StudentView = ({ currentGroup, roundNumber, previousTurn, projectId, onTurnComplete, isConnected, onSync }) => {
            const [prompt, setPrompt] = useState('');
            const [image, setImage] = useState(null);
            const [showGuide, setShowGuide] = useState(false);
            const [sending, setSending] = useState(false);
            const isInitiator = roundNumber === 1;

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setImage(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleTransmit = () => {
                if(!prompt.trim() || !image) return;
                if(!isConnected) {
                    alert("Lost connection to Instructor. Please check Wi-Fi.");
                    return;
                }
                setSending(true);
                // Simulate network delay for feel, then send
                setTimeout(() => {
                    onTurnComplete(prompt, image);
                    // Do not unset sending here, wait for parent re-render or let it persist briefly
                }, 800);
            };

            return (
                <div className="h-screen bg-white flex flex-col md:flex-row overflow-hidden relative">
                    {/* Header for Mobile/Tablet that opens Guide */}
                    <div className="xl:hidden fixed bottom-6 right-6 z-30">
                        <button onClick={() => setShowGuide(true)} className="bg-[#111] text-white p-4 rounded-full shadow-lg hover:scale-105 transition-transform">
                            <Icon name="BookOpen" className="w-6 h-6" />
                        </button>
                    </div>

                    <div className="flex-1 flex flex-col h-full overflow-y-auto">
                        <div className="max-w-4xl mx-auto w-full p-8 md:p-12 space-y-8">
                            <div className="border-b pb-6">
                                <div className="flex items-center justify-between mb-4">
                                    <div className="flex items-center gap-4">
                                        <div className="w-12 h-12 bg-[#111] text-white flex items-center justify-center rounded-xl font-bold text-xl">{currentGroup.split('_')[1]}</div>
                                        <div>
                                            <h1 className="text-3xl font-bold text-[#111]">{isInitiator ? 'The Initiator' : 'The Interpreter'}</h1>
                                            <span className="text-xs font-bold text-[#CC0000] uppercase tracking-wider">Round {roundNumber} / 5</span>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <button onClick={onSync} className="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-xs font-bold text-gray-600 flex items-center gap-1" title="Force Sync">
                                            <Icon name="RefreshCw" className="w-3 h-3"/> SYNC
                                        </button>
                                        <div className={`px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2 ${isConnected ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                            <Icon name={isConnected ? "Wifi" : "WifiOff"} className="w-3 h-3" />
                                            {isConnected ? 'ONLINE' : 'OFFLINE'}
                                        </div>
                                    </div>
                                </div>
                                <p className="text-gray-600 text-lg">
                                    {isInitiator 
                                        ? 'Use the CTLT Method. Lock the Camera, Tone, Light, and Texture.' 
                                        : 'Analyze the image below. Do not guess the story. Direct the lens, lighting, and materials to recreate it.'}
                                </p>
                            </div>

                            {isInitiator && (
                                <div className="bg-amber-50 border border-amber-200 p-6 rounded-xl">
                                    <div className="flex items-center gap-2 mb-2">
                                        <Icon name="Lightbulb" className="w-5 h-5 text-amber-600"/>
                                        <span className="font-bold text-amber-900">Theme Assignment</span>
                                    </div>
                                    <p className="text-amber-900 text-lg font-serif italic">"{INITIATOR_THEMES[currentGroup]}"</p>
                                </div>
                            )}

                            {previousTurn && (
                                <div className="bg-gray-50 p-6 rounded-2xl border border-gray-200">
                                    <div className="flex justify-between mb-4">
                                        <div className="text-xs font-bold text-gray-400 uppercase tracking-widest">Incoming Visual</div>
                                        <div className="text-xs font-bold text-[#CC0000] uppercase tracking-widest">From Group {previousTurn.groupId.split('_')[1]}</div>
                                    </div>
                                    <div className="bg-white p-1 rounded-lg border shadow-sm"><img src={previousTurn.generatedImage} className="w-full max-h-[400px] object-contain mx-auto"/></div>
                                </div>
                            )}

                            <div className="bg-white rounded-xl">
                                <h2 className="text-lg font-bold mb-4 flex gap-2 items-center"><Icon name="Edit3" className="w-5 h-5 text-[#CC0000]"/> 1. Direct Your Vision</h2>
                                <p className="text-sm text-gray-500 mb-2">Write your prompt here using the techniques from the guide.</p>
                                <textarea 
                                    className="w-full p-6 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-[#111] min-h-[160px] text-lg transition-all font-medium"
                                    placeholder={isInitiator 
                                        ? "Direct, don't describe. \nEx: '35mm lens, waist up, warm sunset from camera right, silk catching motion...' \nCombine Subject + Style + Material + Vibe." 
                                        : "I see a [Subject] made of [Texture]. \nCamera: [Lens/Angle]. \nLighting: [Vibe/Direction]..."}
                                    value={prompt}
                                    onChange={e => setPrompt(e.target.value)}
                                />
                                
                                <div className="mt-8">
                                    <h2 className="text-lg font-bold mb-4 flex gap-2 items-center"><Icon name="UploadCloud" className="w-5 h-5 text-[#CC0000]"/> 2. Upload Result</h2>
                                    <p className="text-sm text-gray-500 mb-4">Generate your image using your preferred AI tool (Midjourney, Firefly, ChatGPT, etc.), save it, and upload it here.</p>
                                    
                                    {!image ? (
                                        <div className="file-input-wrapper w-full">
                                            <button className="btn-primary w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2 pointer-events-none">
                                                <Icon name="Image" className="w-5 h-5"/> Select Image File
                                            </button>
                                            <input type="file" accept="image/*" onChange={handleFileUpload} />
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            <div className="bg-gray-50 border rounded-lg p-1"><img src={image} className="w-full max-h-[400px] object-contain mx-auto"/></div>
                                            <div className="flex gap-4">
                                                 <div className="file-input-wrapper flex-1">
                                                    <button className="btn-secondary w-full py-3 rounded-xl font-bold pointer-events-none">Change Image</button>
                                                    <input type="file" accept="image/*" onChange={handleFileUpload} />
                                                </div>
                                                <button onClick={handleTransmit} disabled={!prompt.trim() || !isConnected || sending} className="flex-[2] py-3 bg-[#111] hover:bg-[#CC0000] text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                                    {sending ? (
                                                        <>
                                                            <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                            Sending...
                                                        </>
                                                    ) : (
                                                        <>
                                                            <Icon name="Send" className="w-5 h-5"/> Transmit
                                                        </>
                                                    )}
                                                </button>
                                            </div>
                                            {!prompt.trim() && <p className="text-xs text-center text-red-500 font-bold">Please write your prompt text before transmitting.</p>}
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="h-10"></div>
                        </div>
                    </div>
                    
                    {/* Prompt Guide - Responsive */}
                    <PromptGuide isOpen={showGuide} onClose={() => setShowGuide(false)} isMobile={true} />
                    <PromptGuide isOpen={true} isMobile={false} />
                </div>
            );
        };

        const TeacherDashboard = ({ gameState, onReset, onToggleReflection, roomCode, peerCount, onExit }) => {
            const [zoom, setZoom] = useState(null);
            const [expand, setExpand] = useState(null);
            
            const totalTurns = gameState.projects.reduce((acc, p) => acc + p.turns.length, 0);
            const progress = Math.round((totalTurns / 25) * 100);

            // Export Documentation
            const downloadReport = () => {
                const reportContent = `<!DOCTYPE html><html><head><title>Class Documentation</title><style>body{font-family:sans-serif;padding:40px;max-width:1200px;margin:0 auto;}img{max-width:100%;height:auto;border-radius:4px;}</style></head><body><h1>AI Visual Telephone Report</h1><p>${new Date().toLocaleDateString()}</p>${gameState.projects.map(p => `<div><h2>${p.initiator} Chain</h2><div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px">${p.turns.map((t,i) => `<div><p>Step ${i+1}</p><img src="${t.generatedImage}" /><p><strong>Prompt:</strong> ${t.prompt}</p></div>`).join('')}</div><p><strong>Reflection:</strong> ${p.reflection || 'None'}</p></div><hr/>`).join('')}</body></html>`;
                const blob = new Blob([reportContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Report_${new Date().toISOString().slice(0,10)}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };
            
            // Warn if closing teacher tab
            useEffect(() => {
                const handleBeforeUnload = (e) => {
                    e.preventDefault();
                    e.returnValue = '';
                };
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => window.removeEventListener('beforeunload', handleBeforeUnload);
            }, []);

            return (
                <div className="min-h-screen bg-white pb-20">
                    <header className="sticky top-0 bg-white/95 backdrop-blur border-b z-30 px-8 h-20 flex items-center justify-between">
                        <div className="flex items-center gap-4">
                            <div className="bg-[#111] text-white w-10 h-10 rounded-lg flex items-center justify-center font-bold">T</div>
                            <h1 className="font-bold text-lg hidden md:block">Instructor Dashboard</h1>
                        </div>

                        {/* ROOM CODE DISPLAY */}
                        <div className="flex items-center gap-4 bg-gray-100 px-4 py-2 rounded-lg border border-gray-200">
                            <span className="text-xs font-bold text-gray-500 uppercase">Room Code:</span>
                            <span className="text-xl font-mono font-bold text-[#CC0000]">{roomCode}</span>
                            <span className="text-xs text-gray-400 border-l pl-3 ml-2">{peerCount} Devices Connected</span>
                        </div>

                        <div className="flex items-center gap-4">
                            <button onClick={downloadReport} className="hidden md:flex px-4 py-2 rounded-lg font-bold text-sm items-center gap-2 bg-[#111] text-white hover:bg-[#333]">
                                <Icon name="Download" className="w-4 h-4"/> Export
                            </button>

                            <button onClick={onToggleReflection} className={`px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 ${gameState.reflectionPhase ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}`}>
                                <Icon name={gameState.reflectionPhase ? 'Unlock' : 'Lock'} className="w-4 h-4"/> {gameState.reflectionPhase ? 'Reflect' : 'Unlock'}
                            </button>
                            
                            <button onClick={onReset} className="p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-red-600" title="Reset Game"><Icon name="RefreshCw" className="w-5 h-5"/></button>
                            
                            <button onClick={onExit} className="p-2 hover:bg-red-50 rounded-lg text-red-500 hover:text-red-700 border border-transparent hover:border-red-100" title="Exit Session"><Icon name="LogOut" className="w-5 h-5"/></button>
                        </div>
                    </header>
                    <main className="p-8 grid grid-cols-1 xl:grid-cols-2 gap-8 max-w-[1600px] mx-auto">
                        {gameState.projects.map((p, i) => (
                            <div key={p.id} className="border border-gray-200 rounded-2xl p-6 bg-white shadow-sm hover:shadow-md transition-all">
                                <div className="flex justify-between items-center mb-6">
                                    <div className="flex items-center gap-3">
                                        <span className="w-8 h-8 rounded bg-[#111] text-white flex items-center justify-center font-bold text-sm">{i+1}</span>
                                        <span className="font-bold text-sm uppercase tracking-wide">{p.initiator.replace('_',' ')} CHAIN</span>
                                    </div>
                                    <span className={`text-xs font-bold px-2 py-1 rounded ${p.isComplete ? 'bg-green-50 text-green-700' : 'bg-gray-100 text-gray-500'}`}>{p.isComplete ? 'COMPLETE' : `STEP ${p.turns.length}/5`}</span>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="flex-1 text-center">
                                        <div className="text-[10px] font-bold uppercase text-gray-400 mb-2">Start</div>
                                        {p.turns[0] ? (
                                            <img src={p.turns[0].generatedImage} onClick={() => setZoom({src: p.turns[0].generatedImage, cap: p.turns[0].prompt})} className="w-full aspect-square object-cover rounded-lg border cursor-zoom-in hover:brightness-90 transition-all"/>
                                        ) : <div className="w-full aspect-square rounded-lg border-2 border-dashed flex items-center justify-center text-gray-300">Wait</div>}
                                    </div>
                                    <Icon name="ArrowRight" className="text-gray-300"/>
                                    <div className="flex-1 text-center">
                                        <div className="text-[10px] font-bold uppercase text-gray-400 mb-2">Current</div>
                                        {p.turns.length > 0 ? (
                                            <img src={p.turns[p.turns.length-1].generatedImage} onClick={() => setZoom({src: p.turns[p.turns.length-1].generatedImage, cap: p.turns[p.turns.length-1].prompt})} className="w-full aspect-square object-cover rounded-lg border cursor-zoom-in hover:brightness-90 transition-all"/>
                                        ) : <div className="w-full aspect-square rounded-lg border-2 border-dashed flex items-center justify-center text-gray-300">Wait</div>}
                                    </div>
                                </div>
                                <button onClick={() => setExpand(p)} className="mt-6 w-full py-3 border border-gray-200 hover:border-[#111] rounded-xl font-bold text-sm uppercase transition-all">Inspect Journey</button>
                            </div>
                        ))}
                    </main>

                    {/* Modals */}
                    {expand && (
                        <div className="fixed inset-0 z-50 bg-white/95 backdrop-blur overflow-y-auto">
                            <div className="sticky top-0 bg-white border-b p-6 flex justify-between items-center shadow-sm">
                                <h2 className="text-xl font-bold">Project Analysis: Group {expand.initiator.split('_')[1]}</h2>
                                <button onClick={() => setExpand(null)}><Icon name="X" className="w-6 h-6"/></button>
                            </div>
                            <div className="p-10 max-w-[1600px] mx-auto">
                                <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                                    {Array(5).fill(null).map((_, i) => (
                                        <div key={i} className={!expand.turns[i] ? 'opacity-30' : ''}>
                                            <div className="text-[10px] font-bold uppercase text-gray-400 mb-2">Step {i+1}</div>
                                            {expand.turns[i] ? (
                                                <div className="space-y-3">
                                                    <img src={expand.turns[i].generatedImage} onClick={() => setZoom({src: expand.turns[i].generatedImage, cap: expand.turns[i].prompt})} className="w-full aspect-square object-cover rounded-lg border cursor-zoom-in hover:scale-105 transition-transform"/>
                                                    <div className="text-xs bg-gray-50 p-2 rounded border h-20 overflow-y-auto">{expand.turns[i].prompt}</div>
                                                </div>
                                            ) : <div className="w-full aspect-square border-2 border-dashed rounded-lg flex items-center justify-center text-gray-300"><Icon name="Clock" className="w-6 h-6"/></div>}
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-8 bg-gray-50 p-6 rounded-xl border">
                                    <h3 className="font-bold mb-2">Reflection</h3>
                                    <p className="text-gray-600 italic">"{expand.reflection || 'Pending submission...'}"</p>
                                </div>
                            </div>
                        </div>
                    )}

                    {zoom && (
                        <div className="fixed inset-0 z-[60] bg-black/90 flex flex-col items-center justify-center p-8" onClick={() => setZoom(null)}>
                            <img src={zoom.src} className="max-h-[80vh] w-auto rounded shadow-2xl mb-4"/>
                            <p className="text-white text-center bg-gray-800 px-4 py-2 rounded border border-gray-700 max-w-2xl">{zoom.cap}</p>
                        </div>
                    )}
                </div>
            )
        };

        const App = () => {
            // STATE
            const [gameState, setGameState] = useState({ 
                projects: GROUP_ORDER.map((r,i) => ({ id: `p${i}`, initiator: r, turns: [], isComplete: false, reflection: null })),
                reflectionPhase: false 
            });
            const [role, setRole] = useState(null);
            const [pass, setPass] = useState('');
            const [showPass, setShowPass] = useState(false);
            
            // NETWORKING STATE
            const [peer, setPeer] = useState(null);
            const [hostConn, setHostConn] = useState(null);
            const clientConnsRef = useRef([]); // Use Ref for connections to prevent stale closures
            const [clientPeerCount, setClientPeerCount] = useState(0); // Only for display

            const [roomCodeInput, setRoomCodeInput] = useState('');
            const [myRoomCode, setMyRoomCode] = useState(null);
            const [isConnected, setIsConnected] = useState(false);

            // --- TEACHER (HOST) LOGIC ---
            const initializeHost = () => {
                const shortId = 'cm501-' + Math.floor(1000 + Math.random() * 9000);
                const newPeer = new Peer(shortId, { debug: 1 });
                
                newPeer.on('open', (id) => {
                    console.log('Host ID:', id);
                    setMyRoomCode(id);
                    setIsConnected(true);
                });

                newPeer.on('error', (err) => {
                    if (err.type === 'unavailable-id') {
                        setTimeout(initializeHost, 500);
                    } else {
                        setIsConnected(false);
                        alert("Network Error: " + err.type);
                    }
                });

                newPeer.on('connection', (conn) => {
                    // Add to Ref immediately
                    clientConnsRef.current.push(conn);
                    setClientPeerCount(clientConnsRef.current.length);
                    
                    conn.on('open', () => {
                         // Send CURRENT state to new client
                         // Need to access current state from state variable, which is available in closure scope 
                         // BUT best to pass it dynamically. Since initial connect, using current render scope is likely OK,
                         // but for safety we send what we have.
                         // NOTE: Inside this closure, 'gameState' might be stale if using standard state.
                         // But we can trigger a broadcast from the main component update.
                         // For now, let's send what we see.
                    });

                    conn.on('data', (data) => {
                        handleNetworkData(data);
                    });
                    
                    conn.on('close', () => {
                        clientConnsRef.current = clientConnsRef.current.filter(c => c !== conn);
                        setClientPeerCount(clientConnsRef.current.length);
                    });
                });
                
                setPeer(newPeer);
            };
            
            // Force broadcast whenever gameState changes IF we are host
            // This is the most reliable way to keep everyone in sync
            useEffect(() => {
                if(role === 'TEACHER' && isConnected) {
                    broadcastState(gameState);
                }
            }, [gameState, role, isConnected]);

            const cleanupPeer = () => {
                if (peer) {
                    peer.destroy();
                    setPeer(null);
                }
                clientConnsRef.current = [];
                setMyRoomCode(null);
                setIsConnected(false);
                setHostConn(null);
            };

            const handleExit = () => {
                if (window.confirm("Are you sure you want to exit the session? This will disconnect all students.")) {
                    cleanupPeer();
                    setRole(null);
                }
            };

            // --- STUDENT (CLIENT) LOGIC ---
            const joinGame = (code) => {
                if (!code.startsWith('cm501-')) {
                   code = 'cm501-' + code.replace('cm501-', '');
                }
                
                const newPeer = new Peer(null, { debug: 1 });
                newPeer.on('open', (id) => {
                    const conn = newPeer.connect(code);
                    conn.on('open', () => {
                        setIsConnected(true);
                        setHostConn(conn);
                        // Request initial state
                        conn.send({ type: 'REQUEST_SYNC' });
                    });
                    conn.on('data', (data) => {
                        handleNetworkData(data);
                    });
                    conn.on('close', () => setIsConnected(false));
                    conn.on('error', () => setIsConnected(false));
                });
                setPeer(newPeer);
            };

            const requestSync = () => {
                if(hostConn && isConnected) {
                    hostConn.send({ type: 'REQUEST_SYNC' });
                }
            };

            // --- SHARED DATA HANDLER ---
            const handleNetworkData = (data) => {
                if (data.type === 'SYNC_STATE') {
                    setGameState(data.payload);
                } else if (data.type === 'TURN_UPDATE') {
                    // Host receiving turn
                    updateStateLocal(data.payload);
                } else if (data.type === 'REFLECTION_UPDATE') {
                    // Host receiving reflection
                     setGameState(prev => ({
                        ...prev,
                        projects: prev.projects.map(proj => proj.id === data.payload.projectId ? {...proj, reflection: data.payload.text} : proj)
                    }));
                } else if (data.type === 'REQUEST_SYNC') {
                    // Host receiving request for data
                    // We can't easily access current state inside this callback if it's stale.
                    // But our useEffect above syncs automatically on change.
                    // We can force a re-broadcast by toggling a dummy state or just trusting the effect loop.
                    // Or better, use a Ref for State.
                }
            };

            const updateStateLocal = ({ projectId, role, prompt, img }) => {
                setGameState(prev => {
                    const projects = prev.projects.map(p => {
                        if(p.id !== projectId) return p;
                        // Avoid duplicates if networking retries
                        if(p.turns.some(t => t.groupId === role)) return p;
                        
                        const turns = [...p.turns, { groupId: role, prompt, generatedImage: img }];
                        return { ...p, turns, isComplete: turns.length >= 5 };
                    });
                    return { ...prev, projects };
                });
            };

            const broadcastState = (state) => {
                clientConnsRef.current.forEach(conn => {
                    if(conn.open) conn.send({ type: 'SYNC_STATE', payload: state });
                });
            };

            // Teacher toggle reflection
            const toggleReflection = () => {
                setGameState(prev => ({ ...prev, reflectionPhase: !prev.reflectionPhase }));
            };

            // --- LOCAL HANDLERS ---
            const handleTurnSubmit = (pid, prompt, img) => {
                if (hostConn) {
                    hostConn.send({ type: 'TURN_UPDATE', payload: { projectId: pid, role, prompt, img } });
                }
            };

            const handleReflectionSubmit = (pid, text) => {
                if (hostConn) {
                    hostConn.send({ type: 'REFLECTION_UPDATE', payload: { projectId: pid, text } });
                }
            };

            const getTask = () => {
                if(!role || role === 'TEACHER') return null;
                if(gameState.reflectionPhase) {
                    const p = gameState.projects.find(proj => proj.initiator === role);
                    if(p.turns.length === 0) return { type: 'DONE' }; 
                    return (!p.reflection) ? { type: 'REFLECT', project: p } : { type: 'DONE' };
                }
                const gIdx = GROUP_ORDER.indexOf(role);
                for(let r=1; r<=5; r++) {
                    let iIdx = (gIdx - (r-1)) % 5;
                    if(iIdx < 0) iIdx += 5;
                    const p = gameState.projects[iIdx];
                    if(p.turns.length >= r) continue;
                    
                    // IF waiting for previous turn
                    if(p.turns.length < r-1) {
                         // Who are we waiting for?
                         // The group that performs turn (r-1) on project (iIdx).
                         // GroupIndex = (iIdx + (r-1) - 1) % 5
                         // But easier: The initiator of p is Group (iIdx+1).
                         // Turn 1 is Initiator. Turn 2 is Group(Init+1). Turn N is Group(Init+N-1).
                         // We are waiting for Turn (r-1).
                         // Group doing Turn K on Project P is: (InitiatorIndex + K) % 5
                         // Actually, my rotation logic:
                         // Group G does Round R on Project P where P_init = (G - (R-1)).
                         // So Group = (P_init + R - 1)
                         // We wait for Round (r-1).
                         const waitingForRound = r-1;
                         const pInitIdx = GROUP_ORDER.indexOf(p.initiator);
                         const waitingForGroupIdx = (pInitIdx + waitingForRound - 1) % 5;
                         const waitingForGroup = GROUP_ORDER[waitingForGroupIdx];
                         
                         return { type: 'WAIT', round: r, waitingFor: waitingForGroup };
                    }
                    return { type: 'ACT', round: r, project: p };
                }
                return { type: 'DONE' };
            };

            const task = getTask();

            // 1. LANDING SCREEN
            if(!role) return (
                <div className="min-h-screen bg-white p-8 font-sans">
                    <div className="max-w-5xl mx-auto py-12 text-center">
                        <h1 className="text-5xl font-bold mb-6">AI Visual Telephone</h1>
                        <p className="text-xl text-gray-500 mb-12 max-w-2xl mx-auto">Collaborative generative AI design game.</p>
                        
                        <div className="grid md:grid-cols-2 gap-12 text-left">
                            <div>
                                <h2 className="text-2xl font-bold mb-6 flex gap-2 items-center"><Icon name="Users" className="text-[#CC0000]"/> Student Groups</h2>
                                
                                <div className="mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200">
                                    <label className="text-xs font-bold text-gray-500 uppercase block mb-2">1. Enter Room Code from Instructor</label>
                                    <input 
                                        type="text" 
                                        placeholder="e.g. 4821 or cm501-4821" 
                                        className="w-full p-3 border rounded-lg text-lg font-mono tracking-widest uppercase"
                                        value={roomCodeInput}
                                        onChange={(e) => setRoomCodeInput(e.target.value)}
                                    />
                                </div>

                                <div className="grid grid-cols-3 gap-4">
                                    {GROUP_ORDER.map((g,i) => (
                                        <button 
                                            key={g} 
                                            disabled={!roomCodeInput}
                                            onClick={() => { joinGame(roomCodeInput); setRole(g); }} 
                                            className="hover-card bg-white p-4 rounded-xl border-2 border-gray-100 hover:border-[#111] flex flex-col items-center disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                                        >
                                            <div className="w-10 h-10 bg-[#111] text-white rounded-full flex items-center justify-center font-bold mb-2">{i+1}</div>
                                            <span className="text-xs font-bold">Group {i+1}</span>
                                        </button>
                                    ))}
                                </div>
                                {!roomCodeInput && <p className="text-xs text-red-500 mt-2">* Enter Room Code first to join</p>}
                            </div>

                            <div className="bg-gray-50 p-8 rounded-2xl border flex flex-col justify-center">
                                <h2 className="text-2xl font-bold mb-4 flex gap-2 items-center"><Icon name="MonitorPlay" className="text-[#CC0000]"/> Instructor</h2>
                                <p className="text-gray-600 mb-6">Start a new session and generate a Room Code.</p>
                                <button onClick={() => setShowPass(true)} className="btn-primary py-3 px-6 rounded-xl font-bold w-fit">Open Dashboard</button>
                            </div>
                        </div>

                        {showPass && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                                <div className="bg-white p-8 rounded-2xl w-full max-w-sm">
                                    <h3 className="font-bold text-xl mb-4">Instructor Code</h3>
                                    <input type="password" autoFocus className="w-full p-3 border rounded-lg mb-4 text-lg" placeholder="Enter Passcode" value={pass} onChange={e => setPass(e.target.value)} onKeyDown={e => { if(e.key === 'Enter' && pass === '2025') { initializeHost(); setRole('TEACHER'); setShowPass(false); }}}/>
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowPass(false)} className="flex-1 py-3 text-gray-500 font-bold">Cancel</button>
                                        <button onClick={() => { if(pass === '2025') { initializeHost(); setRole('TEACHER'); setShowPass(false); }}} className="flex-1 py-3 bg-[#111] text-white rounded-lg font-bold">Enter</button>
                                    </div>
                                </div>
                            </div>
                        )}
                         <div className="mt-20 pt-8 border-t text-gray-400 text-sm">CM501 Fall 2025 • v2.1 Fixed</div>
                    </div>
                </div>
            );

            // 2. TEACHER VIEW
            if(role === 'TEACHER') return (
                <TeacherDashboard 
                    gameState={gameState} 
                    roomCode={myRoomCode || 'Generating...'} 
                    peerCount={clientPeerCount}
                    onReset={() => { setGameState({ projects: GROUP_ORDER.map((r,i) => ({ id: `p${i}`, initiator: r, turns: [], isComplete: false, reflection: null })), reflectionPhase: false }); }} 
                    onToggleReflection={toggleReflection}
                    onExit={handleExit}
                />
            );

            // 3. STUDENT VIEWS
            if(task.type === 'WAIT' || task.type === 'DONE') return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-white p-8 text-center relative">
                    <div className="absolute top-4 right-4 text-xs font-mono text-gray-400">{isConnected ? '🟢 Connected' : '🔴 Offline'}</div>
                    <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-6 ${task.type === 'WAIT' ? 'spinner border-4 border-gray-100 border-t-red-600' : 'bg-green-100 text-green-600'}`}>
                        {task.type === 'DONE' && <Icon name="CheckCircle2" className="w-10 h-10"/>}
                    </div>
                    <h2 className="text-3xl font-bold mb-2">{task.type === 'WAIT' ? 'Stand By' : 'All Done!'}</h2>
                    
                    {task.type === 'WAIT' && (
                        <div className="max-w-md mx-auto">
                            <p className="text-gray-500 mb-6 text-lg">
                                Waiting for <strong className="text-[#CC0000]">{task.waitingFor ? task.waitingFor.replace('_', ' ') : 'Previous Group'}</strong> to finish Round {task.round-1}.
                            </p>
                            <button onClick={requestSync} className="px-6 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl font-bold text-gray-600 flex items-center gap-2 mx-auto">
                                <Icon name="RefreshCw" className="w-4 h-4"/> Force Refresh
                            </button>
                        </div>
                    )}
                    
                    {task.type === 'DONE' && <p className="text-gray-500">Wait for the class discussion.</p>}
                </div>
            );

            if(task.type === 'REFLECT') return (
                <div className="min-h-screen bg-white p-8">
                     <div className="max-w-6xl mx-auto py-12">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-3xl font-bold">Final Reflection</h1>
                            <div className="text-xs font-mono text-gray-400">{isConnected ? '🟢 Connected' : '🔴 Offline'}</div>
                        </div>
                        <div className="mb-12">
                            <h3 className="text-lg font-bold border-b pb-4 mb-6">Project Evolution History</h3>
                            <div className="grid grid-cols-1 md:grid-cols-5 gap-6">
                                {task.project.turns.map((turn, i) => (
                                    <div key={i} className="flex flex-col gap-3 group">
                                         <div className="flex items-center justify-between">
                                             <span className="text-xs font-bold uppercase text-gray-400">Step {i+1}</span>
                                             <span className="text-[10px] bg-gray-100 px-2 py-0.5 rounded font-bold text-gray-500">{turn.groupId.split('_')[1] || 'Init'}</span>
                                         </div>
                                         <div className="bg-gray-50 border border-gray-200 rounded-xl overflow-hidden aspect-square shadow-sm">
                                            <img src={turn.generatedImage} className="w-full h-full object-cover" />
                                         </div>
                                         <div className="text-[11px] bg-gray-50 p-3 rounded-lg border border-gray-100 h-32 overflow-y-auto leading-relaxed text-gray-600 shadow-inner">
                                            <span className="block font-bold text-gray-900 mb-1">Prompt:</span>
                                            {turn.prompt}
                                         </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="bg-gray-50 p-8 rounded-2xl border border-gray-200 shadow-sm">
                            <h3 className="font-bold text-lg mb-4 text-[#CC0000] flex items-center gap-2"><Icon name="Users" className="w-5 h-5"/> Discussion Questions</h3>
                            <ul className="list-disc pl-5 space-y-2 text-sm text-gray-700 mb-8 font-medium max-w-3xl leading-relaxed">
                                <li>How did the AI’s interpretation evolve?</li>
                                <li>Did certain details survive or get lost along the way?</li>
                                <li>How did each group’s prompt influence style, lighting, or composition?</li>
                                <li>What can this teach about translating visuals back into language for design?</li>
                            </ul>
                            <textarea id="reflect-txt" className="w-full p-6 border border-gray-200 rounded-xl h-48 mb-6 text-base focus:ring-2 focus:ring-[#111] focus:border-transparent outline-none bg-white shadow-inner" placeholder="Type your group's reflection notes here..."></textarea>
                            <button onClick={() => { const val = document.getElementById('reflect-txt').value; handleReflectionSubmit(task.project.id, val); setRole(null); }} className="btn-primary w-full md:w-auto px-12 py-4 rounded-xl font-bold shadow-lg">Submit Reflection</button>
                        </div>
                     </div>
                </div>
            );

            return (
                <StudentView 
                    currentGroup={role} 
                    roundNumber={task.round} 
                    projectId={task.project.id} 
                    previousTurn={task.round > 1 ? task.project.turns[task.round-2] : null}
                    onTurnComplete={(txt, img) => handleTurnSubmit(task.project.id, txt, img)}
                    isConnected={isConnected}
                    onSync={requestSync}
                />
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
