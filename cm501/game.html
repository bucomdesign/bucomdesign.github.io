<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Visual Telephone</title>
    
    <!-- 1. STYLES & FONTS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
      body { font-family: 'Manrope', sans-serif; color: #111; background: #fff; }
      
      /* Component Styles */
      .btn-primary { background: #111; color: #fff; transition: all 0.25s ease; }
      .btn-primary:hover { background: #CC0000; transform: translateY(-3px); box-shadow: 0 6px 14px rgba(0,0,0,0.12); }
      .btn-secondary { background: #f1f3f5; color: #444; transition: all 0.25s ease; }
      .btn-secondary:hover { background: #e2e6ea; transform: translateY(-2px); }
      .hover-card { transition: transform 0.25s ease, box-shadow 0.25s ease; }
      .hover-card:hover { transform: translateY(-6px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }
      
      /* Animation Utilities */
      @keyframes spin { 100% { transform: rotate(360deg); } }
      .animate-spin-slow { animation: spin 3s linear infinite; }
    </style>

    <!-- 2. REACT LIBRARIES (UMD - Universal Module Definition for Browser) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. BABEL (Compiles React in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root">
        <!-- Initial Loading State (Removed by React once loaded) -->
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white;">
            <div style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top-color: #CC0000; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 20px; font-weight: 600; color: #333; font-family: sans-serif;">Loading AI Visual Telephone...</p>
        </div>
    </div>

    <!-- MAIN APP LOGIC -->
    <script type="text/babel">
        
        // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
        //                 CONFIGURATION
        // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
        
        // 1. Paste your key inside the quotes below.
        // 2. Do not remove the quotes.
        
        const HARDCODED_API_KEY = "AIzaSyBqHLJJIkH7FG91D2TLv7jEalI9Jht3N44"; 

        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- ICONS (Inline SVGs to remove external dependencies) ---
        const Icon = ({ name, className }) => {
            const icons = {
                Users: <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>,
                GraduationCap: <path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/>,
                ArrowRight: <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>,
                MonitorPlay: <path d="m10 7 5 3-5 3z"/><rect width="20" height="14" x="2" y="3" rx="2" ry="2"/><path d="M12 17v4"/><path d="M8 21h8"/>,
                Loader2: <path d="M21 12a9 9 0 1 1-6.219-8.56"/>,
                Send: <path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/>,
                Image: <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>,
                AlertCircle: <circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/>,
                Edit3: <path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/>,
                Lightbulb: <path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5A6 6 0 0 0 6 8c0 1 .5 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/>,
                RefreshCw: <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/>,
                ZoomIn: <circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/>,
                X: <path d="M18 6 6 18"/><path d="m6 6 12 12"/>,
                Clock: <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>,
                CheckCircle2: <circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/>,
                MoveRight: <path d="M18 8L22 12L18 16"/><path d="M2 12H22"/>,
                Lock: <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>,
                Unlock: <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10"/>}
                </svg>
            );
        };

        // --- CONSTANTS ---
        const GROUP_ORDER = ['GROUP_1', 'GROUP_2', 'GROUP_3', 'GROUP_4', 'GROUP_5'];

        const INITIATOR_THEMES = {
            'GROUP_1': "What would your classroom look like if it became a magical world on the last day?",
            'GROUP_2': "Create a scene where everything goes hilariously wrong on the last day of class.",
            'GROUP_3': "How would the last day of class look in a school of the distant future?",
            'GROUP_4': "Illustrate the abstract concept of 'finishing something important' as a visual story.",
            'GROUP_5': "Show the bittersweet feeling of walking out of the classroom for the very last time.",
            'TEACHER': ""
        };

        const PROMPT_RECIPE = [
            { name: "The Subject", examples: ["A chair", "A futuristic sneaker", "A perfume bottle", "A bus stop", "A tiny house", "A geometric explosion"] },
            { name: "The Style", examples: ["Art Deco", "Bauhaus", "Art Nouveau", "Cyberpunk", "Minimalist", "Memphis Design"] },
            { name: "The Material", examples: ["Polished chrome", "Raw concrete", "Rusted iron", "Blue velvet", "Fluffy cotton candy", "Translucent plastic"] },
            { name: "The Vibe", examples: ["Cinematic lighting", "Golden hour", "Neon noir", "Studio softbox", "Isometric view", "Fish-eye lens"] }
        ];

        const INITIAL_GAME_STATE = {
            projects: GROUP_ORDER.map((role, index) => ({
                id: `project-${index + 1}`,
                initiator: role,
                turns: [],
                reflection: null,
                isComplete: false
            })),
            reflectionPhase: false
        };

        // --- DIRECT API SERVICE (Uses fetch instead of SDK to prevent loading errors) ---
        const generateImage = async (prompt) => {
            // 1. Validation
            if (!HARDCODED_API_KEY || HARDCODED_API_KEY.includes("PASTE_YOUR") || HARDCODED_API_KEY.length < 10) {
                throw new Error("Invalid API Key. Please update game.html with a valid key.");
            }

            // 2. Prepare Endpoint (Using gemini-2.5-flash as the reliable base)
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${HARDCODED_API_KEY}`;
            
            // 3. Prepare Payload
            const enhancedPrompt = `${prompt}, photorealistic, realistic photograph, 8k, highly detailed, sharp focus, cinematic lighting`;
            
            const payload = {
                contents: [{
                    parts: [{ text: enhancedPrompt }]
                }],
                // Request a response schema or just standard text? 
                // For image generation via text models, we usually rely on them returning a link or inline data if they are multimodal.
                // However, standard text models don't generate images directly in text format.
                // If using gemini-2.5-flash-image (if accessible via public API), we follow that schema.
                // Let's assume standard behavior: the model interprets the request. 
                // Note: If this model endpoint does not support direct image generation in this specific way,
                // we might get text describing an image. 
                // BUT, assuming the user's previous SDK code worked, we mimic that structure.
            };

            // 4. Execute Fetch
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API Error: ${response.status} ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                
                // 5. Extract Image
                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
                    for (const part of data.candidates[0].content.parts) {
                        // Check for inline image data (standard Gemini image response)
                        if (part.inlineData && part.inlineData.data) {
                            const mimeType = part.inlineData.mimeType || 'image/png';
                            return `data:${mimeType};base64,${part.inlineData.data}`;
                        }
                    }
                }
                
                // Fallback: If no image found, throw error
                throw new Error("The model did not return an image. It might have returned text instead.");
                
            } catch (e) {
                console.error("Image Gen Error:", e);
                throw e;
            }
        };

        // --- REACT COMPONENTS ---

        const PromptGuide = () => (
            <div className="bg-white h-full overflow-y-auto border-l border-gray-100 hidden xl:block w-[400px] shrink-0">
                <div className="p-8">
                    <h3 className="text-xl font-bold text-[#111] mb-6 tracking-tight">Prompt Recipe Formula</h3>
                    <div className="p-5 bg-[#fafafa] border border-gray-100 rounded-xl mb-10">
                        <p className="text-sm font-bold text-[#111] mb-2">Instructions:</p>
                        <p className="text-sm text-gray-600 leading-relaxed">Brainstorm one item from each category to build your prompt.</p>
                        <div className="mt-4 pt-4 border-t border-gray-200 font-mono text-xs text-[#CC0000] font-bold tracking-wide">Subject + Art Style + Material + Vibe</div>
                    </div>
                    <div className="space-y-10">
                        {PROMPT_RECIPE.map((category, idx) => (
                            <div key={idx}>
                                <h4 className="text-sm font-bold text-[#111] uppercase tracking-wider border-b border-gray-100 pb-3 mb-4 flex justify-between">
                                    <span>{idx + 1}. {category.name}</span>
                                </h4>
                                <p className="text-sm text-gray-600 leading-relaxed pl-4 border-l-2 border-gray-100">{category.examples.join(', ')}, etc.</p>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );

        const StudentView = ({ currentGroup, roundNumber, previousTurn, projectId, onTurnComplete }) => {
            const [prompt, setPrompt] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const [generatedImage, setGeneratedImage] = useState(null);
            const [error, setError] = useState(null);

            const isInitiator = roundNumber === 1;
            const referenceImage = previousTurn?.generatedImage;

            const handleGenerate = async () => {
                if (!prompt.trim()) return;
                setIsGenerating(true);
                setError(null);
                try {
                    const base64Image = await generateImage(prompt);
                    setGeneratedImage(base64Image);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            return (
                <div className="h-screen bg-white flex flex-col md:flex-row overflow-hidden">
                    <div className="flex-1 flex flex-col h-full overflow-y-auto">
                        <div className="max-w-4xl mx-auto w-full p-8 md:p-12 space-y-10">
                            <div className="space-y-4 border-b border-gray-200 pb-8">
                                <div className="flex items-center gap-4">
                                    <span className="w-12 h-12 rounded-xl bg-[#111] text-white flex items-center justify-center text-xl font-bold">{currentGroup.replace('GROUP_', '')}</span>
                                    <div>
                                        <h1 className="text-3xl font-bold tracking-tight text-[#111]">{isInitiator ? 'The Initiator' : 'The Interpreter'}</h1>
                                        <span className="text-sm font-bold text-[#CC0000] uppercase tracking-wider">Round {roundNumber} / 5</span>
                                    </div>
                                </div>
                                <p className="text-gray-600 text-lg leading-relaxed max-w-3xl">
                                    {isInitiator ? 'Start a new visual chain. Write a detailed prompt based on your theme.' : 'Analyze the incoming image. Recreate it by writing a new prompt.'}
                                </p>
                            </div>
                            {isInitiator && (
                                <div className="bg-amber-50 border border-amber-200 p-6 rounded-xl flex items-start gap-4 animate-pulse-once">
                                    <div className="bg-white p-2 rounded-full shadow-sm shrink-0"><Icon name="Lightbulb" className="w-6 h-6 text-amber-500" /></div>
                                    <div>
                                        <h3 className="font-bold text-amber-900 text-lg mb-2">Theme: "The Last Day"</h3>
                                        <p className="text-amber-900 text-xl font-semibold font-serif italic">"{INITIATOR_THEMES[currentGroup]}"</p>
                                    </div>
                                </div>
                            )}
                            {referenceImage && (
                                <div className="bg-[#f9f9f9] p-8 rounded-2xl border border-gray-100">
                                    <div className="flex items-center gap-2 mb-6 text-gray-500 text-xs font-bold uppercase tracking-widest"><Icon name="Image" className="w-4 h-4" /> Incoming Transmission</div>
                                    <div className="bg-white border p-1 rounded-lg"><img src={referenceImage} className="w-full max-h-[500px] object-contain mx-auto" /></div>
                                </div>
                            )}
                            <div className="bg-white rounded-xl">
                                <h2 className="text-lg font-bold text-[#111] mb-4 flex items-center gap-2"><Icon name="Edit3" className="w-5 h-5 text-[#CC0000]" /> Draft Prompt</h2>
                                <textarea
                                    value={prompt}
                                    onChange={(e) => setPrompt(e.target.value)}
                                    placeholder={isInitiator ? "Describe your theme (Subject + Style + Material + Vibe)..." : "Describe the image above in your own words..."}
                                    className="w-full p-6 rounded-xl bg-[#fafafa] border border-gray-200 focus:bg-white focus:ring-2 focus:ring-[#111] min-h-[160px] text-lg font-medium text-[#111] transition-all"
                                />
                                {error && <div className="mt-4 p-4 bg-red-50 text-[#CC0000] rounded-lg text-sm font-bold flex items-center gap-2"><Icon name="AlertCircle" className="w-4 h-4"/>{error}</div>}
                                <div className="mt-6">
                                    {!generatedImage ? (
                                        <button onClick={handleGenerate} disabled={isGenerating || !prompt} className="btn-primary w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2 text-lg disabled:opacity-50 transition-all cursor-pointer">
                                            {isGenerating ? <Icon name="Loader2" className="animate-spin w-5 h-5" /> : <Icon name="Image" className="w-5 h-5" />}
                                            {isGenerating ? 'GENERATING...' : 'GENERATE IMAGE'}
                                        </button>
                                    ) : (
                                        <div className="space-y-6">
                                            <div className="bg-[#fafafa] border border-gray-100 rounded-lg overflow-hidden p-1 shadow-sm"><img src={generatedImage} className="w-full max-h-[500px] object-contain mx-auto rounded" /></div>
                                            <div className="flex gap-4">
                                                <button onClick={() => setGeneratedImage(null)} className="btn-secondary flex-1 py-4 rounded-xl font-bold">Discard</button>
                                                <button onClick={() => onTurnComplete(prompt, generatedImage)} className="bg-[#111] hover:bg-[#CC0000] text-white flex-[2] py-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-xl hover:-translate-y-1 transition-all">
                                                    <Icon name="Send" className="w-5 h-5" /> TRANSMIT
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="h-20"></div>
                        </div>
                    </div>
                    <PromptGuide />
                </div>
            );
        };

        const ReflectionView = ({ project, onSubmit }) => {
            const [reflection, setReflection] = useState('');
            return (
                <div className="min-h-screen bg-white text-[#111] p-8 md:p-12 overflow-y-auto">
                    <div className="max-w-5xl mx-auto space-y-12">
                        <header className="text-center space-y-4">
                            <h1 className="text-4xl font-bold tracking-tight">Project Reflection</h1>
                            <p className="text-xl text-gray-600">Review the evolution of your initiating project.</p>
                        </header>
                        <div className="grid md:grid-cols-2 gap-8 items-start">
                            <div className="space-y-4">
                                <div className="bg-gray-50 p-6 rounded-2xl border border-gray-100 text-center">
                                    <span className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 block">Started</span>
                                    <div className="bg-white p-1 rounded-lg border border-gray-100 shadow-sm mb-4"><img src={project.turns[0]?.generatedImage} className="w-full h-auto rounded" /></div>
                                    <p className="text-sm font-mono text-gray-500 bg-white p-3 rounded border">"{project.turns[0]?.prompt}"</p>
                                </div>
                            </div>
                            <div className="space-y-4">
                                <div className="bg-gray-50 p-6 rounded-2xl border border-gray-100 text-center">
                                    <span className="text-xs font-bold text-[#CC0000] uppercase tracking-widest mb-4 block">Ended</span>
                                    <div className="bg-white p-1 rounded-lg border border-gray-100 shadow-sm mb-4"><img src={project.turns[project.turns.length-1]?.generatedImage} className="w-full h-auto rounded" /></div>
                                    <p className="text-sm font-mono text-gray-500 bg-white p-3 rounded border">"{project.turns[project.turns.length-1]?.prompt}"</p>
                                </div>
                            </div>
                        </div>
                        <div className="bg-[#fcfcfc] border border-gray-100 rounded-2xl p-8 shadow-sm">
                            <h3 className="text-xl font-bold mb-6 flex items-center gap-2"><Icon name="Users" className="w-6 h-6 text-[#CC0000]" /> Group Discussion</h3>
                            <ul className="list-disc list-inside space-y-2 mb-6 text-gray-600 ml-4 marker:text-[#CC0000]">
                                <li>How did the AI’s interpretation evolve?</li>
                                <li>Did certain details survive or get lost along the way?</li>
                                <li>How did prompt styles influence lighting or composition?</li>
                            </ul>
                            <textarea value={reflection} onChange={(e) => setReflection(e.target.value)} placeholder="Type your reflection here..." className="w-full p-6 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#111] min-h-[200px] text-lg transition-all outline-none"></textarea>
                            <button onClick={() => onSubmit(reflection)} disabled={!reflection.trim()} className="btn-primary mt-6 w-full py-4 rounded-xl font-bold text-lg disabled:opacity-50">Submit Reflection</button>
                        </div>
                    </div>
                </div>
            )
        };

        const TeacherDashboard = ({ gameState, onReset, onToggleReflection }) => {
            const [expandedProject, setExpandedProject] = useState(null);
            const [zoomedImage, setZoomedImage] = useState(null);

            const progress = Math.round((gameState.projects.reduce((acc, p) => acc + p.turns.length, 0) / 25) * 100);

            return (
                <div className="min-h-screen bg-white pb-20">
                    <header className="bg-white border-b border-gray-100 sticky top-0 z-30 shadow-sm">
                        <div className="max-w-[1600px] mx-auto px-8 h-20 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <div className="w-10 h-10 bg-[#111] text-white flex items-center justify-center font-bold rounded-lg text-lg">T</div>
                                <h1 className="font-bold text-xl tracking-tight">Instructor Dashboard</h1>
                            </div>
                            <div className="flex items-center gap-8">
                                <div className="flex flex-col items-end">
                                    <div className="text-xs text-gray-400 font-bold uppercase tracking-wider mb-1">Progress</div>
                                    <div className="flex items-center gap-3">
                                        <div className="w-40 h-2 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-[#CC0000] transition-all duration-1000" style={{ width: `${progress}%`}}></div></div>
                                        <div className="font-bold text-[#CC0000]">{progress}%</div>
                                    </div>
                                </div>
                                <div className="h-8 w-px bg-gray-200"></div>
                                <button onClick={onToggleReflection} className={`flex items-center gap-2 font-bold px-4 py-2 rounded-lg transition-colors ${gameState.reflectionPhase ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                                    <Icon name={gameState.reflectionPhase ? "Unlock" : "Lock"} className="w-4 h-4"/> {gameState.reflectionPhase ? 'Reflection Active' : 'Unlock Reflection'}
                                </button>
                                <button onClick={onReset} className="p-2 text-gray-400 hover:text-[#CC0000] rounded-lg hover:bg-red-50 transition-colors"><Icon name="RefreshCw" className="w-5 h-5"/></button>
                            </div>
                        </div>
                    </header>
                    <main className="max-w-[1600px] mx-auto px-8 py-10 grid grid-cols-1 xl:grid-cols-2 gap-10">
                        {gameState.projects.map((project, idx) => (
                            <div key={project.id} className="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col hover:shadow-lg transition-all">
                                <div className="px-8 py-5 border-b border-gray-100 flex justify-between items-center bg-[#fcfcfc]">
                                    <div className="flex items-center gap-3">
                                        <span className="w-8 h-8 rounded-lg bg-[#111] text-white flex items-center justify-center font-bold">{idx + 1}</span>
                                        <span className="font-bold uppercase tracking-wide text-sm">{project.initiator.replace('_', ' ')}'s Chain</span>
                                    </div>
                                    <span className={`text-xs font-bold px-3 py-1 rounded-full border ${project.isComplete ? 'bg-green-50 text-green-700 border-green-100' : 'bg-gray-100 text-gray-500 border-gray-200'}`}>{project.isComplete ? 'COMPLETE' : `STEP ${project.turns.length}/5`}</span>
                                </div>
                                <div className="p-8 flex items-center gap-6 flex-1">
                                    <div className="flex-1 text-center space-y-2">
                                        <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">Start</span>
                                        {project.turns[0] ? (
                                            <div className="aspect-square rounded-xl overflow-hidden border border-gray-200 cursor-zoom-in relative group" onClick={() => setZoomedImage({src: project.turns[0].generatedImage, cap: project.turns[0].prompt})}>
                                                <img src={project.turns[0].generatedImage} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" />
                                                <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 flex items-center justify-center transition-colors"><Icon name="ZoomIn" className="text-white opacity-0 group-hover:opacity-100 drop-shadow-sm w-8 h-8" /></div>
                                            </div>
                                        ) : <div className="aspect-square bg-gray-50 rounded-xl border-2 border-dashed border-gray-200 flex items-center justify-center text-gray-300">Wait</div>}
                                    </div>
                                    <Icon name="MoveRight" className="text-gray-300 w-8 h-8" />
                                    <div className="flex-1 text-center space-y-2">
                                        <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">Current</span>
                                        {project.turns.length > 0 ? (
                                            <div className="aspect-square rounded-xl overflow-hidden border border-gray-200 cursor-zoom-in relative group" onClick={() => setZoomedImage({src: project.turns[project.turns.length-1].generatedImage, cap: project.turns[project.turns.length-1].prompt})}>
                                                <img src={project.turns[project.turns.length-1].generatedImage} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" />
                                                <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 flex items-center justify-center transition-colors"><Icon name="ZoomIn" className="text-white opacity-0 group-hover:opacity-100 drop-shadow-sm w-8 h-8" /></div>
                                            </div>
                                        ) : <div className="aspect-square bg-gray-50 rounded-xl border-2 border-dashed border-gray-200 flex items-center justify-center text-gray-300">Wait</div>}
                                    </div>
                                </div>
                                <div className="p-4 border-t border-gray-100 bg-[#fcfcfc]">
                                    <button onClick={() => setExpandedProject(project)} className="w-full py-3 bg-white border border-gray-200 hover:border-[#111] hover:bg-[#111] hover:text-white font-bold rounded-xl text-sm uppercase tracking-wide transition-all shadow-sm">Inspect Journey & Reflection</button>
                                </div>
                            </div>
                        ))}
                    </main>

                    {expandedProject && (
                        <div className="fixed inset-0 z-50 bg-white/95 backdrop-blur overflow-y-auto">
                            <div className="sticky top-0 bg-white/90 border-b border-gray-100 p-6 flex justify-between items-center z-10 shadow-sm">
                                <h2 className="text-2xl font-bold tracking-tight">Project Analysis: {expandedProject.initiator.replace('_',' ')}</h2>
                                <button onClick={() => setExpandedProject(null)} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><Icon name="X" className="w-6 h-6 hover:text-[#CC0000]" /></button>
                            </div>
                            <div className="max-w-[1600px] mx-auto p-10 space-y-12">
                                <div className="grid grid-cols-5 gap-6">
                                    {Array(5).fill(null).map((_, i) => (
                                        <div key={i} className={`flex flex-col ${!expandedProject.turns[i] && 'opacity-40 grayscale'} transition-all`}>
                                            <div className="mb-2 text-xs font-bold uppercase tracking-wider text-gray-400">Step {i+1}</div>
                                            <div className="aspect-square rounded-xl overflow-hidden border border-gray-200 bg-gray-50 cursor-zoom-in relative group shadow-sm mb-3" onClick={() => expandedProject.turns[i] && setZoomedImage({src: expandedProject.turns[i].generatedImage, cap: expandedProject.turns[i].prompt})}>
                                                {expandedProject.turns[i] ? (
                                                    <><img src={expandedProject.turns[i].generatedImage} className="w-full h-full object-cover group-hover:scale-105 transition-transform" /><div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 flex items-center justify-center transition-colors"><Icon name="ZoomIn" className="text-white opacity-0 group-hover:opacity-100 w-8 h-8" /></div></>
                                                ) : <div className="w-full h-full flex items-center justify-center"><Icon name="Clock" className="text-gray-300 w-8 h-8"/></div>}
                                            </div>
                                            <div className="text-xs text-gray-600 border border-gray-100 p-3 rounded-lg bg-white h-24 overflow-y-auto leading-relaxed shadow-sm">{expandedProject.turns[i]?.prompt || 'Waiting...'}</div>
                                        </div>
                                    ))}
                                </div>
                                <div className="bg-[#fcfcfc] p-8 rounded-2xl border border-gray-200">
                                    <h3 className="text-lg font-bold mb-4 text-[#CC0000] flex items-center gap-2"><Icon name="Users" className="w-5 h-5"/> Final Group Reflection</h3>
                                    <p className={`text-lg leading-relaxed border-l-4 pl-4 ${expandedProject.reflection ? 'text-gray-800 border-[#CC0000]' : 'text-gray-400 border-gray-200 italic'}`}>"{expandedProject.reflection || "No reflection submitted yet."}"</p>
                                </div>
                            </div>
                        </div>
                    )}
                    {zoomedImage && (
                        <div className="fixed inset-0 z-[60] bg-black/95 backdrop-blur-sm flex flex-col items-center justify-center p-8">
                            <button onClick={() => setZoomedImage(null)} className="absolute top-8 right-8 text-white/50 hover:text-white p-2"><Icon name="X" className="w-10 h-10" /></button>
                            <img src={zoomedImage.src} className="max-h-[75vh] w-auto object-contain mb-8 rounded-lg shadow-2xl" />
                            <p className="text-white text-center text-lg max-w-4xl bg-[#222] px-6 py-4 rounded-xl border border-white/10 shadow-xl">{zoomedImage.cap}</p>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [gameState, setGameState] = useState(INITIAL_GAME_STATE);
            const [userRole, setUserRole] = useState(null);
            const [showAuth, setShowAuth] = useState(false);
            const [teacherPwd, setTeacherPwd] = useState('');
            const [pwdError, setPwdError] = useState(false);

            const handleTurnComplete = (projectId, prompt, image) => {
                setGameState(prev => {
                    const updatedProjects = prev.projects.map(p => {
                        if (p.id === projectId) {
                            const newTurns = [...p.turns, { groupId: userRole, prompt, generatedImage: image, timestamp: Date.now() }];
                            return { ...p, turns: newTurns, isComplete: newTurns.length >= 5 };
                        }
                        return p;
                    });
                    return { ...prev, projects: updatedProjects };
                });
            };

            const handleReflectionSubmit = (text) => {
                 setGameState(prev => ({ ...prev, projects: prev.projects.map(p => p.initiator === userRole ? { ...p, reflection: text } : p) }));
                 setUserRole(null);
            };

            const handleReset = () => { if(confirm("Reset all activity?")) setGameState(INITIAL_GAME_STATE); };

            const getActiveTask = () => {
                if (!userRole || userRole === 'TEACHER') return null;
                if (gameState.reflectionPhase) {
                    const myProject = gameState.projects.find(p => p.initiator === userRole);
                    if (!myProject.reflection) return { status: 'REFLECTION', project: myProject };
                    return { status: 'COMPLETE_ALL' };
                }
                const groupIndex = GROUP_ORDER.indexOf(userRole);
                for (let round = 1; round <= 5; round++) {
                    let initiatorIndex = (groupIndex - (round - 1)) % 5;
                    if (initiatorIndex < 0) initiatorIndex += 5;
                    const project = gameState.projects[initiatorIndex];
                    if (project.turns.length >= round) continue;
                    if (project.turns.length < round - 1) return { status: 'WAITING', round, project };
                    return { status: 'ACTIVE', round, project };
                }
                return { status: 'COMPLETE_GAME' };
            };

            // Basic check for key existence
            if (!HARDCODED_API_KEY || HARDCODED_API_KEY.includes("PASTE_YOUR")) {
                 return <div className="min-h-screen flex items-center justify-center bg-white p-8 text-center"><div className="bg-red-50 p-8 rounded-2xl border border-red-100"><h2 className="text-2xl font-bold text-[#CC0000] mb-4">Setup Required</h2><p className="text-gray-700">Please edit game.html and paste your Gemini API Key in the HARDCODED_API_KEY variable.</p></div></div>;
            }

            if (userRole === 'TEACHER') return <><button onClick={() => setUserRole(null)} className="fixed top-6 right-6 z-50 text-sm font-semibold text-gray-400 hover:text-[#CC0000] underline">Exit Dashboard</button><TeacherDashboard gameState={gameState} onReset={handleReset} onToggleReflection={() => setGameState(p => ({...p, reflectionPhase: !p.reflectionPhase}))} /></>;

            const task = getActiveTask();

            if (task?.status === 'REFLECTION') return <ReflectionView project={task.project} onSubmit={handleReflectionSubmit} />;
            
            if (task?.status === 'ACTIVE') return <><button onClick={() => setUserRole(null)} className="fixed top-6 right-6 z-50 text-sm font-semibold text-gray-400 hover:text-[#CC0000] underline">Exit Role</button><StudentView key={`${userRole}-${task.round}`} currentGroup={userRole} roundNumber={task.round} projectId={task.project.id} previousTurn={task.round > 1 ? task.project.turns[task.round - 2] : null} onTurnComplete={(p, i) => handleTurnComplete(task.project.id, p, i)} /></>;

            if (task?.status === 'WAITING' || task?.status === 'COMPLETE_GAME' || task?.status === 'COMPLETE_ALL') {
                return (
                    <div className="min-h-screen bg-white flex flex-col items-center justify-center p-8 text-center font-sans">
                        <button onClick={() => setUserRole(null)} className="fixed top-6 right-6 z-50 text-sm font-semibold text-gray-400 hover:text-[#CC0000] underline">Exit Role</button>
                        <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-8 ${task.status === 'WAITING' ? 'border-4 border-gray-100 border-t-[#CC0000] animate-spin' : 'bg-green-50 text-green-600'}`}>
                            {task.status !== 'WAITING' && <Icon name="GraduationCap" className="w-10 h-10" />}
                        </div>
                        <h2 className="text-3xl font-bold text-[#111] mb-4">{task.status === 'WAITING' ? 'Transmission Pending' : 'All Tasks Complete'}</h2>
                        <p className="text-gray-500 max-w-lg mx-auto text-lg leading-relaxed">{task.status === 'WAITING' ? `Waiting for the previous group (Round ${task.round - 1}).` : "Great work! Return to main display."}</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-white text-[#111] font-sans">
                    <div className="max-w-[1120px] mx-auto px-6 py-20">
                        <div className="text-center mb-16">
                            <h1 className="text-4xl md:text-5xl font-bold tracking-tight mb-6 text-[#111]">AI Visual Telephone</h1>
                            <p className="text-lg md:text-xl text-gray-500 max-w-2xl mx-auto font-normal leading-relaxed">Collaborative generative AI translation game.</p>
                        </div>
                        <div className="grid lg:grid-cols-2 gap-12 items-start">
                            <div>
                                <h2 className="text-2xl font-bold mb-6 flex items-center gap-3"><Icon name="Users" className="w-6 h-6 text-[#CC0000]" /> Student Groups</h2>
                                <div className="grid grid-cols-2 sm:grid-cols-3 gap-6">
                                    {GROUP_ORDER.map((group, idx) => (
                                        <button key={group} onClick={() => setUserRole(group)} className="hover-card bg-[#f9f9f9] rounded-xl p-6 text-center border border-transparent hover:border-gray-200 group flex flex-col items-center h-48 justify-center transition-all">
                                            <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-4 shadow-sm group-hover:shadow-md group-hover:text-[#CC0000] text-2xl font-bold transition-all">{idx + 1}</div>
                                            <p className="font-semibold text-[#111]">Group {idx + 1}</p>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-[#f9f9f9] p-8 rounded-2xl border border-gray-100 flex flex-col justify-center text-center lg:text-left h-full shadow-sm">
                                <h2 className="text-2xl font-bold mb-4 flex items-center gap-3 justify-center lg:justify-start"><Icon name="MonitorPlay" className="w-6 h-6 text-[#CC0000]" /> Instructor</h2>
                                <p className="mb-8 text-gray-600 leading-relaxed">Access real-time dashboard and facilitate reflection.</p>
                                <button onClick={() => setShowAuth(true)} className="btn-primary py-4 px-8 rounded-xl font-bold text-lg w-full lg:w-auto self-start flex items-center justify-center gap-2">Launch Dashboard <Icon name="ArrowRight" className="w-5 h-5" /></button>
                            </div>
                        </div>
                        <div className="mt-20 pt-10 border-t border-slate-100 text-center text-slate-400 text-sm"><p>CM501 • Fall 2025 • Visual Communication Design</p></div>
                    </div>
                    {showAuth && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                            <div className="bg-white rounded-2xl p-8 max-w-sm w-full shadow-2xl border border-gray-100">
                                <h3 className="text-xl font-bold text-[#111] mb-2">Instructor Access</h3>
                                <p className="text-sm text-gray-500 mb-6">Enter passcode: 2025</p>
                                <input type="password" value={teacherPwd} onChange={e => {setTeacherPwd(e.target.value); setPwdError(false);}} className={`w-full p-4 border rounded-xl mb-4 outline-none transition-all font-medium text-lg ${pwdError ? 'border-red-300 bg-red-50 text-red-900' : 'border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-[#111]'}`} placeholder="Passcode" autoFocus onKeyDown={(e) => { if (e.key === 'Enter') { if (teacherPwd === '2025') { setUserRole('TEACHER'); setShowAuth(false); setTeacherPwd(''); } else { setPwdError(true); }}}} />
                                <div className="flex gap-3 mt-2"><button onClick={() => setShowAuth(false)} className="flex-1 py-3 text-gray-500 hover:bg-gray-100 rounded-xl font-bold">Cancel</button><button onClick={() => { if (teacherPwd === '2025') { setUserRole('TEACHER'); setShowAuth(false); setTeacherPwd(''); } else { setPwdError(true); }}} className="flex-1 py-3 bg-[#111] hover:bg-[#CC0000] text-white rounded-xl font-bold shadow-lg">Enter</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
