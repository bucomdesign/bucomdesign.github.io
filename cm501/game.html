
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Visual Telephone</title>
    
    <!-- STYLES (Tailwind + Fonts) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Manrope', sans-serif; color: #111; background: #fff; }
      
      /* Buttons */
      .btn-primary { background: #111; color: #fff; transition: all 0.2s; }
      .btn-primary:hover { background: #CC0000; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
      .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
      
      .btn-secondary { background: #f1f3f5; color: #444; transition: all 0.2s; }
      .btn-secondary:hover { background: #e2e6ea; transform: translateY(-2px); }
      
      /* Cards */
      .hover-card { transition: transform 0.25s, box-shadow 0.25s; }
      .hover-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }

      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #ddd; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #bbb; }

      /* File Input Hidden styling */
      .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
      .file-input-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
      
      /* Spinner */
      .spinner { animation: spin 1s linear infinite; }
      @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>

    <!-- LIBRARIES -->
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- PeerJS for Networking -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
</head>
<body>

    <div id="root">
        <!-- Initial Loading State -->
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <div style="width: 50px; height: 50px; border: 5px solid #eee; border-top-color: #CC0000; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 20px; color: #666; font-family: sans-serif;">Loading Visual Telephone...</p>
        </div>
    </div>

    <!-- 
      ======================================================
       REACT APPLICATION
      ======================================================
    -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONS (SVG Components) ---
        const Icon = ({ name, className }) => {
            const icons = {
                Users: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
                GraduationCap: <><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></>,
                MonitorPlay: <><path d="m10 7 5 3-5 3z"/><rect width="20" height="14" x="2" y="3" rx="2" ry="2"/><path d="M12 17v4"/><path d="M8 21h8"/></>,
                Image: <><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></>,
                Send: <><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></>,
                Edit3: <><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></>,
                AlertCircle: <><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>,
                Lightbulb: <><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5A6 6 0 0 0 6 8c0 1 .5 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></>,
                RefreshCw: <><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></>,
                ZoomIn: <><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/></>,
                X: <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>,
                CheckCircle2: <><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></>,
                Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
                ArrowRight: <><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></>,
                Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
                Unlock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></>,
                UploadCloud: <><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></>,
                Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>,
                Wifi: <><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></>,
                WifiOff: <><line x1="1" x2="23" y1="1" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10"/>}
                </svg>
            );
        };

        // --- CONSTANTS ---
        const GROUP_ORDER = ['GROUP_1', 'GROUP_2', 'GROUP_3', 'GROUP_4', 'GROUP_5'];
        
        const INITIATOR_THEMES = {
            'GROUP_1': "What would your classroom look like if it became a magical world on the last day?",
            'GROUP_2': "Create a scene where everything goes hilariously wrong on the last day of class.",
            'GROUP_3': "How would the last day of class look in a school of the distant future?",
            'GROUP_4': "Illustrate the abstract concept of 'finishing something important' as a visual story.",
            'GROUP_5': "Show the bittersweet feeling of walking out of the classroom for the very last time.",
            'TEACHER': ""
        };

        const PROMPT_RECIPE = [
            { name: "1. The Subject", examples: ["Design Object (Sneaker, Chair)", "Architecture (Bus stop)", "Abstract (Geometric explosion)", "Diverse group of students"] },
            { name: "2. The Material (Texture)", examples: ["Soft green grass", "Warm checkered blanket", "Fluffy fur", "Polished chrome", "Melting glass"] },
            { name: "3. The Style (Camera)", examples: ["35mm lens", "Waist up shot", "Macro close-up", "Fish-eye lens", "Isometric view"] },
            { name: "4. The Vibe (Lighting)", examples: ["Warm sunset from camera right", "Silk catching motion", "Golden hour", "Neon noir", "Studio softbox"] }
        ];

        // --- COMPONENTS ---

        const PromptGuide = () => (
            <div className="bg-white h-full overflow-y-auto border-l border-gray-100 hidden xl:block w-[450px] shrink-0">
                <div className="p-8">
                    <h3 className="text-xl font-bold text-[#111] mb-6 tracking-tight">Prompt Engineering 101</h3>
                    <div className="space-y-6 mb-10">
                        <div className="p-5 bg-red-50 border border-red-100 rounded-xl">
                            <h4 className="text-sm font-bold text-[#CC0000] uppercase mb-2">1. Don't Let It Guess</h4>
                            <p className="text-sm text-gray-700 leading-relaxed">Guesses give you random props and strange faces. <strong>Low quality AI guesses. High quality AI follows direction.</strong></p>
                        </div>
                        <div className="p-5 bg-blue-50 border border-blue-100 rounded-xl">
                            <h4 className="text-sm font-bold text-blue-900 uppercase mb-2">2. The CTLT Method</h4>
                            <p className="text-sm text-gray-700 leading-relaxed mb-2">Lock these four elements:</p>
                            <ul className="text-sm text-blue-800 font-bold grid grid-cols-2 gap-2">
                                <li>• <span className="underline">C</span>amera</li><li>• <span className="underline">T</span>one</li>
                                <li>• <span className="underline">L</span>ight</li><li>• <span className="underline">T</span>exture</li>
                            </ul>
                        </div>
                        <div className="p-5 bg-gray-50 border border-gray-200 rounded-xl">
                            <h4 className="text-sm font-bold text-[#111] uppercase mb-2">3. Direct, Don't Describe</h4>
                            <div className="text-sm text-gray-700 leading-relaxed space-y-3">
                                <p className="opacity-50 line-through">"A woman in a dress." (Decoration)</p>
                                <p className="font-medium text-[#111]">"35mm lens, waist up, warm sunset from camera right, silk catching motion." (Design)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const StudentView = ({ currentGroup, roundNumber, previousTurn, projectId, onTurnComplete, connectionStatus }) => {
            const [prompt, setPrompt] = useState('');
            const [image, setImage] = useState(null);
            const isInitiator = roundNumber === 1;

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setImage(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="h-screen bg-white flex flex-col md:flex-row overflow-hidden">
                    <div className="flex-1 flex flex-col h-full overflow-y-auto relative">
                        {/* Connection Status Badge */}
                        <div className="absolute top-4 right-4 z-20 flex items-center gap-2 bg-white/80 backdrop-blur px-3 py-1.5 rounded-full border border-gray-200 shadow-sm text-xs font-bold">
                            <span className={`w-2 h-2 rounded-full ${connectionStatus === 'CONNECTED' ? 'bg-green-500' : 'bg-red-500 animate-pulse'}`}></span>
                            {connectionStatus === 'CONNECTED' ? 'LIVE' : 'CONNECTING...'}
                        </div>

                        <div className="max-w-4xl mx-auto w-full p-8 md:p-12 space-y-8">
                            <div className="border-b pb-6">
                                <div className="flex items-center gap-4 mb-4">
                                    <div className="w-12 h-12 bg-[#111] text-white flex items-center justify-center rounded-xl font-bold text-xl">{currentGroup.split('_')[1]}</div>
                                    <div>
                                        <h1 className="text-3xl font-bold text-[#111]">{isInitiator ? 'The Initiator' : 'The Interpreter'}</h1>
                                        <span className="text-xs font-bold text-[#CC0000] uppercase tracking-wider">Round {roundNumber} / 5</span>
                                    </div>
                                </div>
                                <p className="text-gray-600 text-lg">
                                    {isInitiator ? 'Use the CTLT Method. Lock the Camera, Tone, Light, and Texture.' : 'Analyze the image below. Direct the lens, lighting, and materials to recreate it.'}
                                </p>
                            </div>

                            {isInitiator && (
                                <div className="bg-amber-50 border border-amber-200 p-6 rounded-xl">
                                    <div className="flex items-center gap-2 mb-2"><Icon name="Lightbulb" className="w-5 h-5 text-amber-600"/><span className="font-bold text-amber-900">Theme Assignment</span></div>
                                    <p className="text-amber-900 text-lg font-serif italic">"{INITIATOR_THEMES[currentGroup]}"</p>
                                </div>
                            )}

                            {previousTurn && (
                                <div className="bg-gray-50 p-6 rounded-2xl border border-gray-200">
                                    <div className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Incoming Visual</div>
                                    <div className="bg-white p-1 rounded-lg border shadow-sm"><img src={previousTurn.generatedImage} className="w-full max-h-[400px] object-contain mx-auto"/></div>
                                </div>
                            )}

                            <div className="bg-white rounded-xl">
                                <h2 className="text-lg font-bold mb-4 flex gap-2 items-center"><Icon name="Edit3" className="w-5 h-5 text-[#CC0000]"/> 1. Direct Your Vision</h2>
                                <textarea 
                                    className="w-full p-6 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-[#111] min-h-[160px] text-lg transition-all font-medium"
                                    placeholder={isInitiator ? "Direct, don't describe.\nEx: '35mm lens, waist up...'" : "I see a [Subject] made of [Texture].\nCamera: [Lens/Angle]."}
                                    value={prompt}
                                    onChange={e => setPrompt(e.target.value)}
                                />
                                
                                <div className="mt-8">
                                    <h2 className="text-lg font-bold mb-4 flex gap-2 items-center"><Icon name="UploadCloud" className="w-5 h-5 text-[#CC0000]"/> 2. Upload Result</h2>
                                    {!image ? (
                                        <div className="file-input-wrapper w-full">
                                            <button className="btn-primary w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2 pointer-events-none"><Icon name="Image" className="w-5 h-5"/> Select Image File</button>
                                            <input type="file" accept="image/*" onChange={handleFileUpload} />
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            <div className="bg-gray-50 border rounded-lg p-1"><img src={image} className="w-full max-h-[400px] object-contain mx-auto"/></div>
                                            <div className="flex gap-4">
                                                <div className="file-input-wrapper flex-1"><button className="btn-secondary w-full py-3 rounded-xl font-bold pointer-events-none">Change</button><input type="file" accept="image/*" onChange={handleFileUpload} /></div>
                                                <button onClick={() => onTurnComplete(prompt, image)} disabled={!prompt.trim()} className="flex-[2] py-3 bg-[#111] hover:bg-[#CC0000] text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 disabled:opacity-50"><Icon name="Send" className="w-5 h-5"/> Transmit</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="h-10"></div>
                        </div>
                    </div>
                    <PromptGuide />
                </div>
            );
        };

        const TeacherDashboard = ({ gameState, onReset, onToggleReflection, roomCode, peerCount }) => {
            const [zoom, setZoom] = useState(null);
            const [expand, setExpand] = useState(null);
            
            const totalTurns = gameState.projects.reduce((acc, p) => acc + p.turns.length, 0);
            const progress = Math.round((totalTurns / 25) * 100);

            // Export logic... (same as before)
            const downloadReport = () => {
                const reportContent = `<!DOCTYPE html><html><head><title>Visual Telephone Report</title></head><body><h1>Class Report</h1><p>${new Date().toDateString()}</p>${gameState.projects.map(p => `<h3>${p.initiator} Chain</h3>${p.turns.map((t,i) => `<div><strong>Step ${i+1}:</strong> ${t.prompt}<br/><img src="${t.generatedImage}" width="200"/></div>`).join('')}`).join('')}</body></html>`;
                const blob = new Blob([reportContent], { type: 'text/html' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `Report_${new Date().toISOString().slice(0,10)}.html`;
                a.click();
            };

            return (
                <div className="min-h-screen bg-white pb-20">
                    <header className="sticky top-0 bg-white/95 backdrop-blur border-b z-30 px-8 h-20 flex items-center justify-between">
                        <div className="flex items-center gap-4">
                            <div className="bg-[#111] text-white w-10 h-10 rounded-lg flex items-center justify-center font-bold">T</div>
                            <div>
                                <h1 className="font-bold text-lg leading-tight">Instructor Dashboard</h1>
                                <div className="text-xs text-gray-500 flex items-center gap-2">
                                    <span className="font-bold text-[#CC0000] bg-red-50 px-1.5 rounded">CODE: {roomCode}</span>
                                    <span className="flex items-center gap-1"><Icon name="Users" className="w-3 h-3"/> {peerCount} Connected</span>
                                </div>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                             <div className="flex flex-col items-end mr-4">
                                <span className="text-[10px] font-bold uppercase text-gray-400">Progress</span>
                                <div className="flex items-center gap-2">
                                    <div className="w-32 h-2 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-[#CC0000] transition-all duration-1000" style={{width: `${progress}%`}}></div></div>
                                    <span className="text-sm font-bold text-[#CC0000]">{progress}%</span>
                                </div>
                            </div>
                            <button onClick={downloadReport} className="px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 bg-[#111] text-white hover:bg-[#333]"><Icon name="Download" className="w-4 h-4"/> Export</button>
                            <button onClick={onToggleReflection} className={`px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 ${gameState.reflectionPhase ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}`}><Icon name={gameState.reflectionPhase ? 'Unlock' : 'Lock'} className="w-4 h-4"/> {gameState.reflectionPhase ? 'Close Reflection' : 'Unlock Reflection'}</button>
                            <button onClick={onReset} className="p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-red-600"><Icon name="RefreshCw" className="w-5 h-5"/></button>
                        </div>
                    </header>
                    <main className="p-8 grid grid-cols-1 xl:grid-cols-2 gap-8 max-w-[1600px] mx-auto">
                        {gameState.projects.map((p, i) => (
                            <div key={p.id} className="border border-gray-200 rounded-2xl p-6 bg-white shadow-sm hover:shadow-md transition-all">
                                <div className="flex justify-between items-center mb-6">
                                    <div className="flex items-center gap-3"><span className="w-8 h-8 rounded bg-[#111] text-white flex items-center justify-center font-bold text-sm">{i+1}</span><span className="font-bold text-sm uppercase tracking-wide">{p.initiator.replace('_',' ')} CHAIN</span></div>
                                    <span className={`text-xs font-bold px-2 py-1 rounded ${p.isComplete ? 'bg-green-50 text-green-700' : 'bg-gray-100 text-gray-500'}`}>{p.isComplete ? 'COMPLETE' : `STEP ${p.turns.length}/5`}</span>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="flex-1 text-center">
                                        <div className="text-[10px] font-bold uppercase text-gray-400 mb-2">Start</div>
                                        {p.turns[0] ? <img src={p.turns[0].generatedImage} onClick={() => setZoom({src: p.turns[0].generatedImage, cap: p.turns[0].prompt})} className="w-full aspect-square object-cover rounded-lg border cursor-zoom-in"/> : <div className="w-full aspect-square rounded-lg border-2 border-dashed flex items-center justify-center text-gray-300">Wait</div>}
                                    </div>
                                    <Icon name="ArrowRight" className="text-gray-300"/>
                                    <div className="flex-1 text-center">
                                        <div className="text-[10px] font-bold uppercase text-gray-400 mb-2">Current</div>
                                        {p.turns.length > 0 ? <img src={p.turns[p.turns.length-1].generatedImage} onClick={() => setZoom({src: p.turns[p.turns.length-1].generatedImage, cap: p.turns[p.turns.length-1].prompt})} className="w-full aspect-square object-cover rounded-lg border cursor-zoom-in"/> : <div className="w-full aspect-square rounded-lg border-2 border-dashed flex items-center justify-center text-gray-300">Wait</div>}
                                    </div>
                                </div>
                                <button onClick={() => setExpand(p)} className="mt-6 w-full py-3 border border-gray-200 hover:border-[#111] rounded-xl font-bold text-sm uppercase transition-all">Inspect Journey</button>
                            </div>
                        ))}
                    </main>
                    {/* Expand Modal & Zoom Modal logic same as previous ... */}
                    {expand && (
                        <div className="fixed inset-0 z-50 bg-white/95 backdrop-blur overflow-y-auto">
                            <div className="sticky top-0 bg-white border-b p-6 flex justify-between items-center shadow-sm">
                                <h2 className="text-xl font-bold">Project Analysis: Group {expand.initiator.split('_')[1]}</h2>
                                <button onClick={() => setExpand(null)}><Icon name="X" className="w-6 h-6"/></button>
                            </div>
                            <div className="p-10 max-w-[1600px] mx-auto">
                                <div className="grid grid-cols-5 gap-4">
                                    {Array(5).fill(null).map((_, i) => (
                                        <div key={i} className={!expand.turns[i] ? 'opacity-30' : ''}>
                                            <div className="text-[10px] font-bold uppercase text-gray-400 mb-2">Step {i+1}</div>
                                            {expand.turns[i] ? (
                                                <div className="space-y-3">
                                                    <img src={expand.turns[i].generatedImage} onClick={() => setZoom({src: expand.turns[i].generatedImage, cap: expand.turns[i].prompt})} className="w-full aspect-square object-cover rounded-lg border cursor-zoom-in"/>
                                                    <div className="text-xs bg-gray-50 p-2 rounded border h-20 overflow-y-auto">{expand.turns[i].prompt}</div>
                                                </div>
                                            ) : <div className="w-full aspect-square border-2 border-dashed rounded-lg flex items-center justify-center text-gray-300"><Icon name="Clock" className="w-6 h-6"/></div>}
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-8 bg-gray-50 p-6 rounded-xl border">
                                    <h3 className="font-bold mb-2">Reflection</h3>
                                    <p className="text-gray-600 italic">"{expand.reflection || 'Pending submission...'}"</p>
                                </div>
                            </div>
                        </div>
                    )}
                    {zoom && (
                        <div className="fixed inset-0 z-[60] bg-black/90 flex flex-col items-center justify-center p-8" onClick={() => setZoom(null)}>
                            <img src={zoom.src} className="max-h-[80vh] w-auto rounded shadow-2xl mb-4"/>
                            <p className="text-white text-center bg-gray-800 px-4 py-2 rounded border border-gray-700 max-w-2xl">{zoom.cap}</p>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            // STATE
            const [role, setRole] = useState(null); // 'TEACHER' | 'GROUP_X'
            const [isHost, setIsHost] = useState(false);
            const [roomCode, setRoomCode] = useState('');
            const [inputCode, setInputCode] = useState('');
            const [connectionStatus, setConnectionStatus] = useState('DISCONNECTED'); // DISCONNECTED, CONNECTING, CONNECTED
            const [peerCount, setPeerCount] = useState(0);
            
            const [gameState, setGameState] = useState({ 
                projects: GROUP_ORDER.map((r,i) => ({ id: `p${i}`, initiator: r, turns: [], isComplete: false, reflection: null })),
                reflectionPhase: false 
            });

            // AUTH
            const [pass, setPass] = useState('');
            const [showPass, setShowPass] = useState(false);
            const [showJoin, setShowJoin] = useState(false);
            const [selectedGroup, setSelectedGroup] = useState(null);

            // PEERJS REF
            const peerRef = useRef(null);
            const connRef = useRef(null); // For students
            const connectionsRef = useRef([]); // For teacher

            // 1. TEACHER: START HOSTING
            const startHosting = () => {
                const code = Math.random().toString(36).substring(2, 6).toUpperCase();
                setRoomCode(code);
                setIsHost(true);
                setRole('TEACHER');

                const peer = new Peer(`cm501-${code}-HOST`);
                
                peer.on('open', (id) => {
                    setConnectionStatus('CONNECTED');
                    console.log('Host opened:', id);
                });

                peer.on('connection', (conn) => {
                    connectionsRef.current.push(conn);
                    setPeerCount(prev => prev + 1);
                    
                    conn.on('open', () => {
                        // Send current state to new student immediately
                        conn.send({ type: 'STATE_SYNC', state: gameState });
                    });

                    conn.on('data', (data) => {
                        if (data.type === 'TURN') {
                            handleTurn(data.projectId, data.prompt, data.image, data.groupId);
                        } else if (data.type === 'REFLECTION') {
                            handleReflection(data.projectId, data.reflection);
                        }
                    });

                    conn.on('close', () => {
                        connectionsRef.current = connectionsRef.current.filter(c => c !== conn);
                        setPeerCount(prev => prev - 1);
                    });
                });

                peerRef.current = peer;
            };

            // 2. STUDENT: JOIN SESSION
            const joinSession = () => {
                if (!inputCode) return;
                const peer = new Peer(); // Random ID for student
                
                peer.on('open', (id) => {
                    setConnectionStatus('CONNECTING');
                    const conn = peer.connect(`cm501-${inputCode.toUpperCase()}-HOST`);
                    
                    conn.on('open', () => {
                        setConnectionStatus('CONNECTED');
                        setRole(selectedGroup);
                        setRoomCode(inputCode.toUpperCase());
                        setShowJoin(false);
                    });

                    conn.on('data', (data) => {
                        if (data.type === 'STATE_SYNC') {
                            setGameState(data.state);
                        }
                    });

                    conn.on('close', () => setConnectionStatus('DISCONNECTED'));
                    connRef.current = conn;
                });
                
                peerRef.current = peer;
            };

            // 3. LOGIC: STATE UPDATES
            const broadcastState = (newState) => {
                connectionsRef.current.forEach(conn => {
                    if (conn.open) conn.send({ type: 'STATE_SYNC', state: newState });
                });
            };

            const handleTurn = (pid, prompt, img, groupId) => {
                // If I am Host, update my state and broadcast.
                // If I am Student, send to Host.
                if (isHost) {
                    setGameState(prev => {
                        const projects = prev.projects.map(p => {
                            if(p.id !== pid) return p;
                            const turns = [...p.turns, { groupId, prompt, generatedImage: img }];
                            return { ...p, turns, isComplete: turns.length >= 5 };
                        });
                        const newState = { ...prev, projects };
                        broadcastState(newState);
                        return newState;
                    });
                } else {
                    connRef.current.send({ type: 'TURN', projectId: pid, prompt, image: img, groupId });
                }
            };

            const handleReflection = (pid, text) => {
                if (isHost) {
                     setGameState(prev => {
                        const projects = prev.projects.map(p => p.id === pid ? {...p, reflection: text} : p);
                        const newState = { ...prev, projects };
                        broadcastState(newState);
                        return newState;
                     });
                } else {
                    connRef.current.send({ type: 'REFLECTION', projectId: pid, reflection: text });
                }
            };

            const toggleReflection = () => {
                if (!isHost) return;
                setGameState(prev => {
                    const newState = { ...prev, reflectionPhase: !prev.reflectionPhase };
                    broadcastState(newState);
                    return newState;
                });
            };
            
            const resetGame = () => {
                if (!isHost) return;
                const newState = { 
                    projects: GROUP_ORDER.map((r,i) => ({ id: `p${i}`, initiator: r, turns: [], isComplete: false, reflection: null })),
                    reflectionPhase: false 
                };
                setGameState(newState);
                broadcastState(newState);
            };

            // HELPER: Get Task for Student
            const getTask = () => {
                if(!role || role === 'TEACHER') return null;
                if(gameState.reflectionPhase) {
                    const p = gameState.projects.find(proj => proj.initiator === role);
                    return (!p.reflection) ? { type: 'REFLECT', project: p } : { type: 'DONE' };
                }
                const gIdx = GROUP_ORDER.indexOf(role);
                for(let r=1; r<=5; r++) {
                    let iIdx = (gIdx - (r-1)) % 5;
                    if(iIdx < 0) iIdx += 5;
                    const p = gameState.projects[iIdx];
                    if(p.turns.length >= r) continue;
                    if(p.turns.length < r-1) return { type: 'WAIT', round: r };
                    return { type: 'ACT', round: r, project: p };
                }
                return { type: 'DONE' };
            };

            const task = getTask();

            // --- VIEWS ---

            // LANDING
            if(!role) return (
                <div className="min-h-screen bg-white p-8 font-sans">
                    <div className="max-w-5xl mx-auto py-12 text-center">
                        <h1 className="text-5xl font-bold mb-6">AI Visual Telephone</h1>
                        <p className="text-xl text-gray-500 mb-12 max-w-2xl mx-auto">Real-time collaborative generative AI design game.</p>
                        <div className="grid md:grid-cols-2 gap-12 text-left">
                            <div>
                                <h2 className="text-2xl font-bold mb-6 flex gap-2 items-center"><Icon name="Users" className="text-[#CC0000]"/> Student Groups</h2>
                                <div className="grid grid-cols-3 gap-4">
                                    {GROUP_ORDER.map((g,i) => (
                                        <button key={g} onClick={() => { setSelectedGroup(g); setShowJoin(true); }} className="hover-card bg-gray-50 p-6 rounded-xl border hover:border-gray-300 flex flex-col items-center">
                                            <div className="w-12 h-12 bg-white rounded-full flex items-center justify-center font-bold shadow-sm mb-2 text-lg">{i+1}</div>
                                            <span className="text-sm font-bold">Group {i+1}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-gray-50 p-8 rounded-2xl border flex flex-col justify-center">
                                <h2 className="text-2xl font-bold mb-4 flex gap-2 items-center"><Icon name="MonitorPlay" className="text-[#CC0000]"/> Instructor</h2>
                                <p className="text-gray-600 mb-6">Host a session and monitor real-time progress.</p>
                                <button onClick={() => setShowPass(true)} className="btn-primary py-3 px-6 rounded-xl font-bold w-fit">Open Dashboard</button>
                            </div>
                        </div>

                        {/* Student Join Modal */}
                        {showJoin && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                                <div className="bg-white p-8 rounded-2xl w-full max-w-sm">
                                    <h3 className="font-bold text-xl mb-2">Join Session</h3>
                                    <p className="text-gray-500 mb-4 text-sm">Ask your instructor for the 4-letter Room Code.</p>
                                    <input type="text" autoFocus className="w-full p-3 border rounded-lg mb-4 text-lg uppercase tracking-widest text-center" placeholder="CODE" value={inputCode} onChange={e => setInputCode(e.target.value)} maxLength={4}/>
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowJoin(false)} className="flex-1 py-3 text-gray-500 font-bold">Cancel</button>
                                        <button onClick={joinSession} className="flex-1 py-3 bg-[#111] text-white rounded-lg font-bold">Connect</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Teacher Auth Modal */}
                        {showPass && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                                <div className="bg-white p-8 rounded-2xl w-full max-w-sm">
                                    <h3 className="font-bold text-xl mb-4">Instructor Code</h3>
                                    <input type="password" autoFocus className="w-full p-3 border rounded-lg mb-4 text-lg" placeholder="Enter Passcode" value={pass} onChange={e => setPass(e.target.value)} onKeyDown={e => { if(e.key === 'Enter' && pass === '2025') { startHosting(); setShowPass(false); }}}/>
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowPass(false)} className="flex-1 py-3 text-gray-500 font-bold">Cancel</button>
                                        <button onClick={() => { if(pass === '2025') { startHosting(); setShowPass(false); }}} className="flex-1 py-3 bg-[#111] text-white rounded-lg font-bold">Enter</button>
                                    </div>
                                </div>
                            </div>
                        )}
                        <div className="mt-20 pt-8 border-t text-gray-400 text-sm">CM501 Fall 2025</div>
                    </div>
                </div>
            );

            // TEACHER VIEW
            if(role === 'TEACHER') return (
                <TeacherDashboard 
                    gameState={gameState} 
                    onReset={resetGame} 
                    onToggleReflection={toggleReflection} 
                    roomCode={roomCode}
                    peerCount={peerCount}
                />
            );

            // STUDENT WAIT VIEW
            if(task.type === 'WAIT' || task.type === 'DONE') return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-white p-8 text-center relative">
                    <div className="absolute top-4 right-4 text-xs font-bold text-gray-400 flex items-center gap-2">
                        <span className={`w-2 h-2 rounded-full ${connectionStatus === 'CONNECTED' ? 'bg-green-500' : 'bg-red-500'}`}></span>
                        {connectionStatus} TO HOST
                    </div>
                    <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-6 ${task.type === 'WAIT' ? 'spinner border-4 border-gray-100 border-t-red-600' : 'bg-green-100 text-green-600'}`}>
                        {task.type === 'DONE' && <Icon name="CheckCircle2" className="w-10 h-10"/>}
                    </div>
                    <h2 className="text-3xl font-bold mb-2">{task.type === 'WAIT' ? 'Pending...' : 'All Done!'}</h2>
                    <p className="text-gray-500 max-w-md mx-auto">{task.type === 'WAIT' ? `Waiting for Round ${task.round-1} to finish. Ensure the Teacher Dashboard is open.` : 'Wait for the instructor to open the reflection phase.'}</p>
                </div>
            );

            // REFLECTION VIEW
            if(task.type === 'REFLECT') return (
                <div className="min-h-screen bg-white p-8">
                     <div className="max-w-6xl mx-auto py-12">
                        <h1 className="text-3xl font-bold mb-2">Final Reflection</h1>
                        <p className="mb-8 text-gray-600">Review the evolution of your original concept and discuss the outcome.</p>
                        
                        <div className="mb-12">
                            <h3 className="text-lg font-bold border-b pb-4 mb-6">Project Evolution History</h3>
                            <div className="grid grid-cols-1 md:grid-cols-5 gap-6">
                                {task.project.turns.map((turn, i) => (
                                    <div key={i} className="flex flex-col gap-3 group">
                                         <div className="flex items-center justify-between"><span className="text-xs font-bold uppercase text-gray-400">Step {i+1}</span><span className="text-[10px] bg-gray-100 px-2 py-0.5 rounded font-bold text-gray-500">{turn.groupId.split('_')[1]}</span></div>
                                         <div className="bg-gray-50 border border-gray-200 rounded-xl overflow-hidden aspect-square shadow-sm"><img src={turn.generatedImage} className="w-full h-full object-cover"/></div>
                                         <div className="text-[11px] bg-gray-50 p-3 rounded-lg border border-gray-100 h-32 overflow-y-auto leading-relaxed text-gray-600 shadow-inner"><span className="block font-bold text-gray-900 mb-1">Prompt:</span>{turn.prompt}</div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="bg-gray-50 p-8 rounded-2xl border border-gray-200 shadow-sm">
                            <h3 className="font-bold text-lg mb-4 text-[#CC0000] flex items-center gap-2"><Icon name="Users" className="w-5 h-5"/> Discussion Questions</h3>
                            <ul className="list-disc pl-5 space-y-2 text-sm text-gray-700 mb-8 font-medium max-w-3xl leading-relaxed">
                                <li>How did the AI’s interpretation evolve?</li>
                                <li>Did certain details survive or get lost along the way?</li>
                                <li>How did each group’s prompt influence style, lighting, or composition?</li>
                                <li>What can this teach about translating visuals back into language for design?</li>
                            </ul>
                            <textarea id="reflect-txt" className="w-full p-6 border border-gray-200 rounded-xl h-48 mb-6 text-base focus:ring-2 focus:ring-[#111] focus:border-transparent outline-none bg-white shadow-inner" placeholder="Type reflection notes..."></textarea>
                            <button onClick={() => { const val = document.getElementById('reflect-txt').value; handleReflection(task.project.id, val); setRole(null); }} className="btn-primary w-full md:w-auto px-12 py-4 rounded-xl font-bold shadow-lg">Submit & Finish</button>
                        </div>
                     </div>
                </div>
            );

            // ACTIVE STUDENT VIEW
            return (
                <StudentView 
                    currentGroup={role} 
                    roundNumber={task.round} 
                    projectId={task.project.id} 
                    previousTurn={task.round > 1 ? task.project.turns[task.round-2] : null}
                    onTurnComplete={(txt, img) => handleTurn(task.project.id, txt, img, role)}
                    connectionStatus={connectionStatus}
                />
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
