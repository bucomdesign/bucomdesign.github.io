<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project 2 Peer Evaluation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body { font-family: 'Inter', sans-serif; }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.0.0",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.469.0",
        "@google/genai": "https://esm.sh/@google/genai@0.1.1"
      }
    }
    </script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="typescript,react">
      import React, { useState, useEffect } from 'react';
      import { createRoot } from 'react-dom/client';
      import { 
        LogOut, ArrowUp, ArrowDown, CheckCircle, ShieldAlert, 
        FileSpreadsheet, Users, Copy, ExternalLink, Check, 
        Trash2, ArrowLeft, Wand2, Loader2, AlertCircle, Upload, Download 
      } from 'lucide-react';
      import { GoogleGenAI } from "@google/genai";

      /** 
       * ==========================================
       * TYPES
       * ==========================================
       */
      interface Student {
        name: string;
        email: string;
        section: string;
        group: string;
      }

      interface EvaluationData {
        overallContribution: number;
        completionOfTasks: number;
        initiative: string;
        specificContributions: string;
        communicationEffectiveness: number;
        feedbackOpenness: number;
        decisionMakingSupport: string;
        challenges: string;
        positiveImpact: string;
        reliability: number;
        followThrough: string;
        workQualityConsistency: number;
        ideaGeneration: number;
        strategicUnderstanding: string;
        creativeInfluenceExample: string;
        overallPerformance: number;
        workAgain: string;
        additionalComments: string;
      }

      interface FullSubmission {
        evaluatorEmail: string;
        evaluatorName: string;
        section: string;
        group: string;
        evaluations: Record<string, EvaluationData>;
        stackRanking: string[];
        timestamp: string;
      }

      type AppStep = 'LOGIN' | 'EVALUATE' | 'RANKING' | 'SUCCESS' | 'INSTRUCTOR_DASHBOARD';

      /** 
       * ==========================================
       * CONSTANTS
       * ==========================================
       */
      const STUDENTS: Student[] = [
        // Section G1
        { section: 'G1', group: '1', name: 'Kaylin McConnell', email: 'klmcconn@bu.edu' },
        { section: 'G1', group: '1', name: 'Crystal Wu', email: 'cwu21@bu.edu' },
        { section: 'G1', group: '1', name: 'Lincoln Edwards', email: 'lincred@bu.edu' },
        { section: 'G1', group: '1', name: 'Olivia Evans', email: 'eolivia@bu.edu' },
        { section: 'G1', group: '2', name: 'Emily Wyrwa', email: 'evwyrwa@bu.edu' },
        { section: 'G1', group: '2', name: 'Amber (Nikki) Capinpin', email: 'capinpin@bu.edu' },
        { section: 'G1', group: '2', name: 'Claudia', email: 'cminacap@bu.edu' },
        { section: 'G1', group: '2', name: 'Sidi Bello', email: 'sidikatb@bu.edu' },
        { section: 'G1', group: '3', name: 'Annie Levy', email: 'anlevy@bu.edu' },
        { section: 'G1', group: '3', name: 'Ali Cook', email: 'alircook@bu.edu' },
        { section: 'G1', group: '3', name: 'Ava Rheingold', email: 'arheingo@bu.edu' },
        { section: 'G1', group: '3', name: 'Xiaodong (Will) Will', email: 'xiaodonf@bu.edu' },
        { section: 'G1', group: '4', name: 'Piper Gilliam', email: 'pipergg@bu.edu' },
        { section: 'G1', group: '4', name: 'Zitong(Becky) Zheng', email: 'Beckyzzt@bu.edu' },
        { section: 'G1', group: '4', name: 'Sanyu', email: 'sanyuliu@bu.edu' },
        { section: 'G1', group: '4', name: 'Jessica Lin', email: 'jess3lin@bu.edu' },
        { section: 'G1', group: '5', name: 'Teresa Garate', email: 'teresag@bu.edu' },
        { section: 'G1', group: '5', name: 'Ziyi', email: 'renziyi@bu.edu' },
        { section: 'G1', group: '5', name: 'Qinjian(Erik) Ran', email: 'qjr2000@bu.edu' },
        { section: 'G1', group: '5', name: 'Sitong (Scarlett) Jiang', email: 'jstong@bu.edu' },
        // Section H1
        { section: 'H1', group: '1', name: 'Keira Shannon', email: 'keiras@bu.edu' },
        { section: 'H1', group: '1', name: 'Anna McClean', email: 'amcclean@bu.edu' },
        { section: 'H1', group: '1', name: 'Amelia Edelsberg', email: 'ameliae@bu.edu' },
        { section: 'H1', group: '1', name: 'Erin Hajian', email: 'ehajian@bu.edu' },
        { section: 'H1', group: '2', name: 'Marina Berger', email: 'maberger@bu.edu' },
        { section: 'H1', group: '2', name: 'Amanda Brecher', email: 'ambrec@bu.edu' },
        { section: 'H1', group: '2', name: 'Yiyang(Kacey) Jin', email: 'jinyy328@bu.edu' },
        { section: 'H1', group: '2', name: 'Nadezhda Kuznetsova', email: 'nadezhda@bu.edu' },
        { section: 'H1', group: '3', name: 'Samantha Shorr', email: 'sshorr@bu.edu' },
        { section: 'H1', group: '3', name: 'Ananya Swaroop', email: 'ananya21@bu.edu' },
        { section: 'H1', group: '3', name: 'Mily Talgham Cohen', email: 'milytc@bu.edu' },
        { section: 'H1', group: '3', name: 'Lance Shook', email: 'lshook@bu.edu' },
        { section: 'H1', group: '4', name: 'Kirsten Foster', email: 'kefoster@bu.edu' },
        { section: 'H1', group: '4', name: 'Zoe Baumann', email: 'zbaumann@bu.edu' },
        { section: 'H1', group: '4', name: 'Maddy Oberding', email: 'mgober@bu.edu' },
        { section: 'H1', group: '4', name: 'Mickie McCool', email: 'mfmccool@bu.edu' },
        { section: 'H1', group: '5', name: 'Delia Rune', email: 'deliar@bu.edu' },
        { section: 'H1', group: '5', name: 'Kayla Lok', email: 'kaylalok@bu.edu' },
        { section: 'H1', group: '5', name: 'Yiyu Zhang', email: 'yiyuzh@bu.edu' },
        { section: 'H1', group: '5', name: 'Mina Jones', email: 'minacjon@bu.edu' },
        // Section K1
        { section: 'K1', group: '1', name: 'Jocelyn Mao', email: 'jocmao@bu.edu' },
        { section: 'K1', group: '1', name: 'Alisa Hilaly', email: 'alisah@bu.edu' },
        { section: 'K1', group: '1', name: 'Victoria Shapiro', email: 'tshapiro@bu.edu' },
        { section: 'K1', group: '1', name: 'Olivia Schnur', email: 'oschnur@bu.edu' },
        { section: 'K1', group: '2', name: 'Anna Novick', email: 'annayn@bu.edu' },
        { section: 'K1', group: '2', name: 'Michaela Shunney', email: 'mshunney@bu.edu' },
        { section: 'K1', group: '2', name: 'Savannah Radisch', email: 'sradisch@bu.edu' },
        { section: 'K1', group: '2', name: 'Donald Varnerin', email: 'Donnyv@bu.edu' },
        { section: 'K1', group: '3', name: 'Izzy Anderson', email: 'icanders@bu.edu' },
        { section: 'K1', group: '3', name: 'HaoYuan Chen', email: 'chyharry@bu.edu' },
        { section: 'K1', group: '3', name: 'Shree Lheyaa Jayasudha Mathivanan', email: 'lheyaa@bu.edu' },
        { section: 'K1', group: '3', name: 'Blair LeBlanc', email: 'blairl@bu.edu' },
        { section: 'K1', group: '4', name: 'Tala Solomon', email: 'talas@bu.edu' },
        { section: 'K1', group: '4', name: 'Ava Graff', email: 'avagraff@bu.edu' },
        { section: 'K1', group: '4', name: 'Sydney Wiggins', email: 'swiggins@bu.edu' },
        { section: 'K1', group: '4', name: 'Julie Liu', email: 'jhliu18@bu.edu' },
        { section: 'K1', group: '5', name: 'Nia Carrera', email: 'niac@bu.edu' },
        { section: 'K1', group: '5', name: 'Nancy Liu', email: 'lnanan@bu.edu' },
        { section: 'K1', group: '5', name: 'Muneeb Mahmood', email: 'muneebm@bu.edu' },
        // Instructor / Testing
        { section: 'Test', group: 'Instructor', name: 'Jen Choi', email: 'choijen@bu.edu' },
        { section: 'Test', group: 'Instructor', name: 'Jen Choi (Gmail)', email: 'choij126@gmail.com' },
        { section: 'Test', group: 'Instructor', name: 'Jen Jiun Choi', email: 'jenjiunchoi@gmail.com' },
        { section: 'Test', group: 'Instructor', name: 'Test Student A', email: 'test.student.a@bu.edu' },
        { section: 'Test', group: 'Instructor', name: 'Test Student B', email: 'test.student.b@bu.edu' },
      ];

      const INITIAL_EVALUATION_STATE = {
        overallContribution: 0,
        completionOfTasks: 0,
        initiative: '',
        specificContributions: '',
        communicationEffectiveness: 0,
        feedbackOpenness: 0,
        decisionMakingSupport: '',
        challenges: '',
        positiveImpact: '',
        reliability: 0,
        followThrough: '',
        workQualityConsistency: 0,
        ideaGeneration: 0,
        strategicUnderstanding: '',
        creativeInfluenceExample: '',
        overallPerformance: 0,
        workAgain: '',
        additionalComments: '',
      };

      /** 
       * ==========================================
       * SERVICE: Gemini (AI)
       * ==========================================
       */
      const refineFeedback = async (draft, context) => {
        // NOTE: In a static file, we can't hide API keys properly. 
        // Users might need to enter it or we assume a safe env.
        // For this demo, we'll return the draft if no key is present.
        const apiKey = ''; // Enter API Key here if needed for testing
        
        if (!apiKey) return draft;

        try {
          const ai = new GoogleGenAI({ apiKey });
          const model = 'gemini-2.5-flash';
          const prompt = `You are a professional communication coach helping a student write peer feedback. Context: ${context}. Draft: "${draft}". Rewrite to be constructive and professional. Return ONLY the text.`;
          
          const response = await ai.models.generateContent({ model, contents: prompt });
          return response.text || draft;
        } catch (error) {
          console.error("Gemini Error:", error);
          return draft;
        }
      };

      /** 
       * ==========================================
       * UTILS: CSV/TSV Helper
       * ==========================================
       */
      const escapeField = (str, separator) => {
        if (str === null || str === undefined) return '';
        const stringValue = str.toString();
        if (separator === '\t') {
          if (stringValue.includes('\t') || stringValue.includes('\n') || stringValue.includes('"')) {
            return `"${stringValue.replace(/"/g, '""')}"`;
          }
        } else {
          if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
            return `"${stringValue.replace(/"/g, '""')}"`;
          }
        }
        return stringValue;
      };

      const generateMasterData = (students, submissions, format = 'csv') => {
        const sep = format === 'tsv' ? '\t' : ',';
        const headers = [
          'Section', 'Group', 'Target Name', 'Target Email',
          'Evaluator Name', 'Evaluator Email', 
          'Overall Contribution', 'Task Completion', 'Initiative', 'Specific Contributions',
          'Communication', 'Feedback Openness', 'Decision Support', 'Challenges', 'Positive Impact',
          'Reliability', 'Follow Through', 'Consistency', 
          'Idea Generation', 'Strategic Understanding', 'Creative Example',
          'Overall Performance', 'Work Again?', 'Additional Comments', 
          'Stack Rank Position', 'Avg Peer Rank', 'Calculated Group Rank', 'Status'
        ];

        // Process rankings
        const studentRanks = {}; // { email: [ranks...] }
        students.forEach(s => studentRanks[s.email] = []);

        students.forEach(target => {
           const potentialEvaluators = students.filter(s => s.section === target.section && s.group === target.group && s.email !== target.email);
           potentialEvaluators.forEach(ev => {
              const sub = submissions[ev.email];
              if (sub && sub.stackRanking) {
                const idx = sub.stackRanking.indexOf(target.email);
                if (idx !== -1) studentRanks[target.email].push(idx + 1);
              }
           });
        });

        // Calculate averages and sort order
        const studentStats = {};
        students.forEach(s => {
           const ranks = studentRanks[s.email];
           const avg = ranks.length > 0 ? (ranks.reduce((a,b)=>a+b,0) / ranks.length) : 999;
           studentStats[s.email] = { avg, ranks };
        });

        const rows = [headers.join(sep)];

        // Sort students by Section > Group > Rank (Avg)
        const sortedStudents = [...students].sort((a, b) => {
           if (a.section !== b.section) return a.section.localeCompare(b.section);
           if (a.group !== b.group) return a.group.localeCompare(b.group);
           return studentStats[a.email].avg - studentStats[b.email].avg;
        });

        sortedStudents.forEach((target, index, array) => {
           // Determine group rank position (1st, 2nd, etc) based on sorted order within group
           const groupMembers = array.filter(s => s.section === target.section && s.group === target.group);
           const relativeRank = groupMembers.indexOf(target) + 1;
           const avgRank = studentStats[target.email].avg === 999 ? 'N/A' : studentStats[target.email].avg.toFixed(1);

           const potentialEvaluators = students.filter(s => s.section === target.section && s.group === target.group && s.email !== target.email);
           
           potentialEvaluators.forEach(evaluator => {
              const submission = submissions[evaluator.email];
              let evalData = null;
              let rank = 'N/A';
              let status = 'Pending';

              if (submission && submission.evaluations && submission.evaluations[target.email]) {
                  evalData = submission.evaluations[target.email];
                  status = 'Submitted';
                  const rankIndex = submission.stackRanking ? submission.stackRanking.indexOf(target.email) : -1;
                  rank = rankIndex !== -1 ? (rankIndex + 1).toString() : 'N/A';
              }

              const row = [
                escapeField(target.section, sep), escapeField(target.group, sep), escapeField(target.name, sep), escapeField(target.email, sep),
                escapeField(evaluator.name, sep), escapeField(evaluator.email, sep),
                evalData?.overallContribution ?? '', evalData?.completionOfTasks ?? '', evalData?.initiative ?? '', escapeField(evalData?.specificContributions ?? '', sep),
                evalData?.communicationEffectiveness ?? '', evalData?.feedbackOpenness ?? '', evalData?.decisionMakingSupport ?? '', escapeField(evalData?.challenges ?? '', sep), escapeField(evalData?.positiveImpact ?? '', sep),
                evalData?.reliability ?? '', evalData?.followThrough ?? '', evalData?.workQualityConsistency ?? '',
                evalData?.ideaGeneration ?? '', evalData?.strategicUnderstanding ?? '', escapeField(evalData?.creativeInfluenceExample ?? '', sep),
                evalData?.overallPerformance ?? '', evalData?.workAgain ?? '', escapeField(evalData?.additionalComments ?? '', sep),
                rank, avgRank, relativeRank, status
              ];
              rows.push(row.join(sep));
           });
        });

        return rows.join('\n');
      };

      const downloadCSV = (content, filename) => {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      /** 
       * ==========================================
       * COMPONENT: EvaluationForm
       * ==========================================
       */
      const EvaluationForm = ({ targetName, data, onChange, onNext, onBack, isLast }) => {
        const [loadingAI, setLoadingAI] = useState(null);

        const handleAIHelp = async (field, context) => {
          const currentText = data[field];
          if (!currentText || currentText.length < 5) return;
          setLoadingAI(field);
          const refined = await refineFeedback(currentText, context);
          onChange(field, refined);
          setLoadingAI(null);
        };

        const isFormValid = () => {
          return (
            data.overallContribution > 0 && data.completionOfTasks > 0 && data.initiative !== '' &&
            data.communicationEffectiveness > 0 && data.feedbackOpenness > 0 && data.decisionMakingSupport !== '' &&
            data.reliability > 0 && data.followThrough !== '' && data.workQualityConsistency > 0 &&
            data.ideaGeneration > 0 && data.strategicUnderstanding !== '' && data.overallPerformance > 0 && data.workAgain !== ''
          );
        };

        const renderRating = (field, label) => (
          <div className="mb-6">
            <label className="block text-sm font-medium text-gray-700 mb-2">{label} <span className="text-red-500">*</span></label>
            <div className="flex gap-4">
              {[1, 2, 3, 4, 5].map((num) => (
                <button
                  key={num}
                  onClick={() => onChange(field, num)}
                  className={`w-10 h-10 rounded-full flex items-center justify-center font-bold transition-colors ${
                    data[field] === num ? 'bg-red-600 text-white shadow-lg ring-2 ring-red-300' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'
                  }`}
                >
                  {num}
                </button>
              ))}
            </div>
          </div>
        );

        const renderSelect = (field, label, options) => (
          <div className="mb-6">
            <label className="block text-sm font-medium text-gray-700 mb-2">{label} <span className="text-red-500">*</span></label>
            <div className="flex flex-wrap gap-2">
              {options.map((opt) => (
                <button
                  key={opt}
                  onClick={() => onChange(field, opt)}
                  className={`px-4 py-2 rounded-md text-sm font-medium border transition-colors ${
                    data[field] === opt ? 'bg-red-50 border-red-500 text-red-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50'
                  }`}
                >
                  {opt}
                </button>
              ))}
            </div>
          </div>
        );

        const renderText = (field, label, placeholder) => (
          <div className="mb-6">
            <div className="flex justify-between items-center mb-2">
              <label className="block text-sm font-medium text-gray-700">{label} <span className="text-gray-400 font-normal">(Optional)</span></label>
            </div>
            <textarea
              value={data[field]}
              onChange={(e) => onChange(field, e.target.value)}
              rows={3}
              className="w-full p-3 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500 text-sm"
              placeholder={placeholder}
            />
          </div>
        );

        const valid = isFormValid();

        return (
          <div className="max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-sm border border-gray-200">
            <div className="mb-8 border-b pb-4">
              <h2 className="text-2xl font-bold text-gray-900">Evaluating: <span className="text-red-600">{targetName}</span></h2>
              <p className="text-gray-500 text-sm mt-1">Fields marked with <span className="text-red-500">*</span> are required.</p>
            </div>

            <div className="mb-8">
              <h3 className="text-lg font-semibold text-gray-800 mb-4 bg-gray-50 p-2 rounded">Section 1: Individual Contribution</h3>
              {renderRating('overallContribution', 'Overall contribution to the project (1-5)')}
              {renderRating('completionOfTasks', 'Completion of assigned tasks (1-5)')}
              {renderSelect('initiative', 'Initiative', ['Yes', 'Sometimes', 'No'])}
              {renderText('specificContributions', 'Specific contributions', 'Describe tasks...')}
            </div>

            <div className="mb-8">
              <h3 className="text-lg font-semibold text-gray-800 mb-4 bg-gray-50 p-2 rounded">Section 2: Collaboration & Communication</h3>
              {renderRating('communicationEffectiveness', 'Communication effectiveness (1-5)')}
              {renderRating('feedbackOpenness', 'Openness to giving/receiving feedback (1-5)')}
              {renderSelect('decisionMakingSupport', 'Support for collaborative decision-making', ['Yes', 'Sometimes', 'No'])}
              {renderText('challenges', 'Challenges', 'If applicable...')}
              {renderText('positiveImpact', 'Positive impact', 'Describe behaviors...')}
            </div>

            <div className="mb-8">
              <h3 className="text-lg font-semibold text-gray-800 mb-4 bg-gray-50 p-2 rounded">Section 3: Reliability & Accountability</h3>
              {renderRating('reliability', 'Reliability in meeting deadlines (1-5)')}
              {renderSelect('followThrough', 'Follow-through on responsibilities', ['Always', 'Sometimes', 'Rarely'])}
              {renderRating('workQualityConsistency', 'Consistency of work quality (1-5)')}
            </div>

            <div className="mb-8">
              <h3 className="text-lg font-semibold text-gray-800 mb-4 bg-gray-50 p-2 rounded">Section 4: Creativity & Strategic Thinking</h3>
              {renderRating('ideaGeneration', 'Idea generation & brainstorming contribution (1-5)')}
              {renderSelect('strategicUnderstanding', 'Understanding of strategic storytelling', ['Yes', 'Somewhat', 'No'])}
              {renderText('creativeInfluenceExample', 'Example of creative influence', 'Describe a moment...')}
            </div>

            <div className="mb-8">
              <h3 className="text-lg font-semibold text-gray-800 mb-4 bg-gray-50 p-2 rounded">Section 5: Overall Assessment</h3>
              {renderRating('overallPerformance', 'Overall performance (1-5)')}
              {renderSelect('workAgain', 'Would you work with this team member again?', ['Yes', 'Maybe', 'No'])}
              {renderText('additionalComments', 'Additional comments', 'Strengths, improvements...')}
            </div>

            <div className="flex justify-between pt-6 border-t items-center">
              <button onClick={onBack} className="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Back</button>
              <div className="flex items-center gap-4">
                  {!valid && <span className="text-xs text-red-500 font-medium flex items-center gap-1"><AlertCircle size={14} /> Complete required ratings</span>}
                  <button
                  onClick={onNext}
                  disabled={!valid}
                  className={`px-6 py-2 rounded-md font-medium shadow-sm transition-all ${valid ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}
                  >
                  {isLast ? 'Complete & Rank' : 'Next Member'}
                  </button>
              </div>
            </div>
          </div>
        );
      };

      /** 
       * ==========================================
       * COMPONENT: Main App
       * ==========================================
       */
      const App = () => {
        const [step, setStep] = useState('LOGIN');
        const [currentUser, setCurrentUser] = useState(null);
        const [loginEmail, setLoginEmail] = useState('');
        const [loginError, setLoginError] = useState('');
        const [copySuccess, setCopySuccess] = useState(false);
        const [peers, setPeers] = useState([]);
        const [allGroupMembers, setAllGroupMembers] = useState([]);
        const [evaluations, setEvaluations] = useState({});
        const [currentPeerIndex, setCurrentPeerIndex] = useState(0);
        const [rankings, setRankings] = useState([]);

        // Instructor List
        const INSTRUCTORS = ['choijen@bu.edu', 'choij126@gmail.com', 'jenjiunchoi@gmail.com'];
        const isInstructor = (email) => INSTRUCTORS.includes(email);

        const getSubmissionsFromStorage = () => {
          try {
            const stored = localStorage.getItem('peer_eval_submissions');
            return stored ? JSON.parse(stored) : {};
          } catch (e) { return {}; }
        };

        const handleLogin = (e) => {
          e.preventDefault();
          const emailLower = loginEmail.toLowerCase().trim();
          const student = STUDENTS.find(s => s.email.toLowerCase() === emailLower);
          
          if (student) {
            setCurrentUser(student);
            const groupMembers = STUDENTS.filter(s => s.section === student.section && s.group === student.group);
            setAllGroupMembers(groupMembers);
            const peersToEval = groupMembers.filter(s => s.email !== student.email);
            setPeers(peersToEval);
            setRankings([...groupMembers]);
            const initialEvals = {};
            peersToEval.forEach(p => initialEvals[p.email] = { ...INITIAL_EVALUATION_STATE });
            setEvaluations(initialEvals);
            setStep('EVALUATE');
            setLoginError('');
          } else {
            setLoginError('Email not found in the authorized student list.');
          }
        };

        const handleEvaluationChange = (field, value) => {
          const currentPeer = peers[currentPeerIndex];
          setEvaluations(prev => ({
            ...prev,
            [currentPeer.email]: { ...prev[currentPeer.email], [field]: value }
          }));
        };

        const handleNextEval = () => {
          if (currentPeerIndex < peers.length - 1) {
            setCurrentPeerIndex(prev => prev + 1);
            window.scrollTo(0, 0);
          } else {
            setStep('RANKING');
            window.scrollTo(0, 0);
          }
        };

        const handleBackEval = () => {
          if (currentPeerIndex > 0) {
            setCurrentPeerIndex(prev => prev - 1);
            window.scrollTo(0, 0);
          }
        };

        const moveRank = (index, direction) => {
          const newRankings = [...rankings];
          if (direction === 'up' && index > 0) {
            [newRankings[index], newRankings[index - 1]] = [newRankings[index - 1], newRankings[index]];
          } else if (direction === 'down' && index < newRankings.length - 1) {
            [newRankings[index], newRankings[index + 1]] = [newRankings[index + 1], newRankings[index]];
          }
          setRankings(newRankings);
        };

        const handleSubmit = () => {
          if (!currentUser) return;
          const submission = {
            evaluatorEmail: currentUser.email,
            evaluatorName: currentUser.name,
            section: currentUser.section,
            group: currentUser.group,
            evaluations,
            stackRanking: rankings.map(r => r.email),
            timestamp: new Date().toISOString()
          };
          
          // Save to Local Storage
          const allSubmissions = getSubmissionsFromStorage();
          allSubmissions[currentUser.email] = submission;
          localStorage.setItem('peer_eval_submissions', JSON.stringify(allSubmissions));
          setStep('SUCCESS');
        };

        const handleDownloadReceipt = () => {
           // Provide a JSON file for the student to email the instructor
           const allSubmissions = getSubmissionsFromStorage();
           const mySubmission = allSubmissions[currentUser.email];
           const blob = new Blob([JSON.stringify(mySubmission, null, 2)], { type: 'application/json' });
           const link = document.createElement('a');
           link.href = URL.createObjectURL(blob);
           link.download = `PeerEval_${currentUser.name.replace(/\s+/g, '_')}_${currentUser.section}.json`;
           document.body.appendChild(link);
           link.click();
           document.body.removeChild(link);
        };

        const handleInstructorImport = (event) => {
           const files = event.target.files;
           if (!files) return;
           
           // We need to read all files and merge them into local storage
           const promises = Array.from(files).map(file => {
              return new Promise((resolve) => {
                 const reader = new FileReader();
                 reader.onload = (e) => {
                    try {
                       const data = JSON.parse(e.target.result);
                       resolve(data);
                    } catch (err) { resolve(null); }
                 };
                 reader.readAsText(file);
              });
           });

           Promise.all(promises).then(results => {
              const currentStore = getSubmissionsFromStorage();
              let count = 0;
              results.forEach((sub) => {
                 if (sub && sub.evaluatorEmail) {
                    currentStore[sub.evaluatorEmail] = sub;
                    count++;
                 }
              });
              localStorage.setItem('peer_eval_submissions', JSON.stringify(currentStore));
              alert(`Successfully imported ${count} submissions.`);
              // Force re-render logic via window reload or state update. 
              // Simple way for this file:
              window.location.reload();
           });
        };

        const handleCopyToClipboard = () => {
          const submissions = getSubmissionsFromStorage();
          const tsvContent = generateMasterData(STUDENTS, submissions, 'tsv');
          navigator.clipboard.writeText(tsvContent).then(() => {
            setCopySuccess(true);
            setTimeout(() => setCopySuccess(false), 3000);
          });
        };

        const handleClearData = () => {
          if (confirm("Delete all data from this browser?")) {
            localStorage.removeItem('peer_eval_submissions');
            window.location.reload();
          }
        };

        if (step === 'LOGIN') {
          return (
            <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
              <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8 border border-gray-100">
                <div className="text-center mb-8">
                  <h1 className="text-2xl font-bold text-gray-900">Peer Evaluation Login</h1>
                  <p className="text-gray-500 mt-2">Project 2 - Sections G1, H1, K1</p>
                </div>
                <form onSubmit={handleLogin} className="space-y-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700">BU Email Address</label>
                    <input type="email" required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="you@bu.edu" value={loginEmail} onChange={(e) => setLoginEmail(e.target.value)} />
                  </div>
                  {loginError && <div className="bg-red-50 text-red-700 px-4 py-3 rounded text-sm">{loginError}</div>}
                  <button type="submit" className="w-full py-2 px-4 bg-red-600 text-white rounded-md hover:bg-red-700">Access Form</button>
                </form>
              </div>
            </div>
          );
        }

        const statsSubmissions = Object.keys(getSubmissionsFromStorage()).length;

        return (
          <div className="min-h-screen bg-gray-50 pb-12">
            <header className="bg-white shadow-sm sticky top-0 z-10">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div>
                  <h1 className="text-lg font-bold text-gray-900">Project 2 Peer Eval</h1>
                  <p className="text-xs text-gray-500">{currentUser?.name}</p>
                </div>
                <div className="flex items-center gap-4">
                  {isInstructor(currentUser?.email) && (
                    <button onClick={() => setStep(step === 'INSTRUCTOR_DASHBOARD' ? 'EVALUATE' : 'INSTRUCTOR_DASHBOARD')} className={`text-sm font-medium px-3 py-1.5 rounded-md ${step === 'INSTRUCTOR_DASHBOARD' ? 'bg-red-100 text-red-700' : 'text-gray-600 hover:bg-gray-100'}`}>
                      {step === 'INSTRUCTOR_DASHBOARD' ? 'Test Form' : 'Instructor Dashboard'}
                    </button>
                  )}
                  <button onClick={() => window.location.reload()} className="text-gray-500 hover:text-red-600 text-sm flex gap-1"><LogOut size={16}/> Logout</button>
                </div>
              </div>
            </header>

            <main className="max-w-4xl mx-auto px-4 mt-8">
              {step === 'INSTRUCTOR_DASHBOARD' && (
                <div className="max-w-3xl mx-auto bg-white rounded-xl shadow-md p-8 border border-gray-200">
                    <div className="flex items-center gap-4 mb-6">
                       <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-red-600"><ShieldAlert size={24} /></div>
                       <h2 className="text-2xl font-bold text-gray-900">Instructor Dashboard</h2>
                    </div>

                    <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                       <h3 className="font-bold text-blue-800 mb-2 flex items-center gap-2"><Upload size={18}/> Import Student Submissions</h3>
                       <p className="text-sm text-blue-700 mb-3">Since there is no server, students must send you their submission files (JSON). Upload them here to populate your dashboard.</p>
                       <input type="file" multiple accept=".json" onChange={handleInstructorImport} className="block w-full text-sm text-blue-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200"/>
                    </div>

                    <div className="grid grid-cols-3 gap-4 mb-6">
                       <div className="bg-gray-50 p-4 rounded text-center">
                          <span className="block text-2xl font-bold">{statsSubmissions}</span>
                          <span className="text-xs text-gray-500">Submissions Loaded</span>
                       </div>
                       <div className="bg-gray-50 p-4 rounded text-center">
                          <span className="block text-2xl font-bold">3</span>
                          <span className="text-xs text-gray-500">Sections</span>
                       </div>
                       <div className="bg-gray-50 p-4 rounded text-center">
                          <span className="block text-2xl font-bold">Top</span>
                          <span className="text-xs text-gray-500">Performers Sorted</span>
                       </div>
                    </div>

                    <div className="bg-green-50 border border-green-100 rounded-lg p-6 mb-6">
                        <h3 className="font-bold text-green-800 mb-2 flex items-center gap-2"><FileSpreadsheet size={18}/> Export Report</h3>
                        <div className="flex gap-4">
                           <button onClick={handleCopyToClipboard} className="flex-1 bg-white border border-green-300 text-green-700 hover:bg-green-100 px-4 py-3 rounded flex items-center justify-center gap-2">
                              {copySuccess ? <Check size={18}/> : <Copy size={18}/>} Copy for Sheets
                           </button>
                           <a href="https://sheets.new" target="_blank" className="flex-1 bg-green-600 text-white hover:bg-green-700 px-4 py-3 rounded flex items-center justify-center gap-2">
                              <ExternalLink size={18}/> Open New Sheet
                           </a>
                        </div>
                    </div>
                    
                    <button onClick={handleClearData} className="text-red-600 text-xs flex items-center gap-1"><Trash2 size={12}/> Clear Dashboard Data</button>
                </div>
              )}

              {step === 'EVALUATE' && (
                <EvaluationForm targetName={peers[currentPeerIndex].name} data={evaluations[peers[currentPeerIndex].email]} onChange={handleEvaluationChange} onNext={handleNextEval} onBack={handleBackEval} isLast={currentPeerIndex === peers.length - 1} />
              )}

              {step === 'RANKING' && (
                <div className="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-sm">
                   <h2 className="text-2xl font-bold mb-6">Rank Team Members</h2>
                   <div className="space-y-3 mb-8">
                     {rankings.map((student, index) => (
                       <div key={student.email} className="flex items-center gap-4 bg-gray-50 p-4 rounded-lg">
                          <div className="w-8 h-8 bg-red-100 text-red-700 rounded-full flex items-center justify-center font-bold">{index + 1}</div>
                          <div className="flex-grow font-semibold">{student.name}</div>
                          <div className="flex flex-col gap-1">
                             <button onClick={() => moveRank(index, 'up')} disabled={index===0}><ArrowUp size={20}/></button>
                             <button onClick={() => moveRank(index, 'down')} disabled={index===rankings.length-1}><ArrowDown size={20}/></button>
                          </div>
                       </div>
                     ))}
                   </div>
                   <div className="flex justify-between">
                      <button onClick={() => setStep('EVALUATE')} className="px-6 py-2 border rounded">Back</button>
                      <button onClick={handleSubmit} className="px-6 py-2 bg-red-600 text-white rounded flex items-center gap-2"><CheckCircle size={18}/> Submit</button>
                   </div>
                </div>
              )}

              {step === 'SUCCESS' && (
                <div className="max-w-md mx-auto bg-white p-12 rounded-xl shadow-lg text-center">
                   <div className="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6"><CheckCircle size={32}/></div>
                   <h2 className="text-2xl font-bold mb-4">Submission Complete</h2>
                   <p className="text-gray-600 mb-8">Your peer evaluation has been recorded locally.</p>
                   
                   <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mb-6 text-left">
                      <h4 className="font-bold text-yellow-800 text-sm mb-2">Required Step:</h4>
                      <p className="text-xs text-yellow-800">Please download your submission receipt below and email it to your instructor.</p>
                   </div>

                   <button onClick={handleDownloadReceipt} className="w-full bg-blue-600 text-white px-4 py-3 rounded mb-3 hover:bg-blue-700 flex items-center justify-center gap-2">
                      <Download size={18} /> Download Receipt (JSON)
                   </button>

                   {isInstructor(currentUser?.email) && (
                      <button onClick={() => setStep('INSTRUCTOR_DASHBOARD')} className="w-full bg-red-600 text-white px-4 py-3 rounded hover:bg-red-700 mb-3">Go to Dashboard</button>
                   )}
                   <button onClick={() => window.location.reload()} className="w-full bg-gray-100 text-gray-700 px-4 py-3 rounded">Return to Login</button>
                </div>
              )}
            </main>
          </div>
        );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
